(function(J,w){typeof exports=="object"&&typeof module<"u"?w(exports,require("three")):typeof define=="function"&&define.amd?define(["exports","three"],w):(J=typeof globalThis<"u"?globalThis:J||self,w(J.Anchor={},J.three))})(this,function(J,w){"use strict";var va=Object.defineProperty;var ba=(J,w,ge)=>w in J?va(J,w,{enumerable:!0,configurable:!0,writable:!0,value:ge}):J[w]=ge;var Bt=(J,w,ge)=>(ba(J,typeof w!="symbol"?w+"":w,ge),ge);const ge={type:"change"},lt={type:"start"},zt={type:"end"},Ye=new w.Ray,kt=new w.Plane,as=Math.cos(70*w.MathUtils.DEG2RAD);class cs extends w.EventDispatcher{constructor(e,t){super(),this.object=e,this.domElement=t,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new w.Vector3,this.cursor=new w.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:w.MOUSE.ROTATE,MIDDLE:w.MOUSE.DOLLY,RIGHT:w.MOUSE.PAN},this.touches={ONE:w.TOUCH.ROTATE,TWO:w.TOUCH.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return r.phi},this.getAzimuthalAngle=function(){return r.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(x){x.addEventListener("keydown",Ot),this._domElementKeyEvents=x},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",Ot),this._domElementKeyEvents=null},this.saveState=function(){n.target0.copy(n.target),n.position0.copy(n.object.position),n.zoom0=n.object.zoom},this.reset=function(){n.target.copy(n.target0),n.object.position.copy(n.position0),n.object.zoom=n.zoom0,n.object.updateProjectionMatrix(),n.dispatchEvent(ge),n.update(),i=s.NONE},this.update=function(){const x=new w.Vector3,k=new w.Quaternion().setFromUnitVectors(e.up,new w.Vector3(0,1,0)),V=k.clone().invert(),W=new w.Vector3,te=new w.Quaternion,Ae=new w.Vector3,oe=2*Math.PI;return function(wa=null){const rs=n.object.position;x.copy(rs).sub(n.target),x.applyQuaternion(k),r.setFromVector3(x),n.autoRotate&&i===s.NONE&&B(_(wa)),n.enableDamping?(r.theta+=a.theta*n.dampingFactor,r.phi+=a.phi*n.dampingFactor):(r.theta+=a.theta,r.phi+=a.phi);let me=n.minAzimuthAngle,ye=n.maxAzimuthAngle;isFinite(me)&&isFinite(ye)&&(me<-Math.PI?me+=oe:me>Math.PI&&(me-=oe),ye<-Math.PI?ye+=oe:ye>Math.PI&&(ye-=oe),me<=ye?r.theta=Math.max(me,Math.min(ye,r.theta)):r.theta=r.theta>(me+ye)/2?Math.max(me,r.theta):Math.min(ye,r.theta)),r.phi=Math.max(n.minPolarAngle,Math.min(n.maxPolarAngle,r.phi)),r.makeSafe(),n.enableDamping===!0?n.target.addScaledVector(l,n.dampingFactor):n.target.add(l),n.target.sub(n.cursor),n.target.clampLength(n.minTargetRadius,n.maxTargetRadius),n.target.add(n.cursor),n.zoomToCursor&&M||n.object.isOrthographicCamera?r.radius=H(r.radius):r.radius=H(r.radius*c),x.setFromSpherical(r),x.applyQuaternion(V),rs.copy(n.target).add(x),n.object.lookAt(n.target),n.enableDamping===!0?(a.theta*=1-n.dampingFactor,a.phi*=1-n.dampingFactor,l.multiplyScalar(1-n.dampingFactor)):(a.set(0,0,0),l.set(0,0,0));let Ft=!1;if(n.zoomToCursor&&M){let Xe=null;if(n.object.isPerspectiveCamera){const Ke=x.length();Xe=H(Ke*c);const ct=Ke-Xe;n.object.position.addScaledVector(E,ct),n.object.updateMatrixWorld()}else if(n.object.isOrthographicCamera){const Ke=new w.Vector3(S.x,S.y,0);Ke.unproject(n.object),n.object.zoom=Math.max(n.minZoom,Math.min(n.maxZoom,n.object.zoom/c)),n.object.updateProjectionMatrix(),Ft=!0;const ct=new w.Vector3(S.x,S.y,0);ct.unproject(n.object),n.object.position.sub(ct).add(Ke),n.object.updateMatrixWorld(),Xe=x.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),n.zoomToCursor=!1;Xe!==null&&(this.screenSpacePanning?n.target.set(0,0,-1).transformDirection(n.object.matrix).multiplyScalar(Xe).add(n.object.position):(Ye.origin.copy(n.object.position),Ye.direction.set(0,0,-1).transformDirection(n.object.matrix),Math.abs(n.object.up.dot(Ye.direction))<as?e.lookAt(n.target):(kt.setFromNormalAndCoplanarPoint(n.object.up,n.target),Ye.intersectPlane(kt,n.target))))}else n.object.isOrthographicCamera&&(n.object.zoom=Math.max(n.minZoom,Math.min(n.maxZoom,n.object.zoom/c)),n.object.updateProjectionMatrix(),Ft=!0);return c=1,M=!1,Ft||W.distanceToSquared(n.object.position)>o||8*(1-te.dot(n.object.quaternion))>o||Ae.distanceToSquared(n.target)>0?(n.dispatchEvent(ge),W.copy(n.object.position),te.copy(n.object.quaternion),Ae.copy(n.target),!0):!1}}(),this.dispose=function(){n.domElement.removeEventListener("contextmenu",is),n.domElement.removeEventListener("pointerdown",ns),n.domElement.removeEventListener("pointercancel",We),n.domElement.removeEventListener("wheel",ss),n.domElement.removeEventListener("pointermove",Lt),n.domElement.removeEventListener("pointerup",We),n._domElementKeyEvents!==null&&(n._domElementKeyEvents.removeEventListener("keydown",Ot),n._domElementKeyEvents=null)};const n=this,s={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let i=s.NONE;const o=1e-6,r=new w.Spherical,a=new w.Spherical;let c=1;const l=new w.Vector3,d=new w.Vector2,u=new w.Vector2,g=new w.Vector2,h=new w.Vector2,y=new w.Vector2,m=new w.Vector2,b=new w.Vector2,v=new w.Vector2,A=new w.Vector2,E=new w.Vector3,S=new w.Vector2;let M=!1;const N=[],C={};function _(x){return x!==null?2*Math.PI/60*n.autoRotateSpeed*x:2*Math.PI/60/60*n.autoRotateSpeed}function I(x){const k=Math.abs(x)/(100*(window.devicePixelRatio|0));return Math.pow(.95,n.zoomSpeed*k)}function B(x){a.theta-=x}function O(x){a.phi-=x}const T=function(){const x=new w.Vector3;return function(V,W){x.setFromMatrixColumn(W,0),x.multiplyScalar(-V),l.add(x)}}(),L=function(){const x=new w.Vector3;return function(V,W){n.screenSpacePanning===!0?x.setFromMatrixColumn(W,1):(x.setFromMatrixColumn(W,0),x.crossVectors(n.object.up,x)),x.multiplyScalar(V),l.add(x)}}(),P=function(){const x=new w.Vector3;return function(V,W){const te=n.domElement;if(n.object.isPerspectiveCamera){const Ae=n.object.position;x.copy(Ae).sub(n.target);let oe=x.length();oe*=Math.tan(n.object.fov/2*Math.PI/180),T(2*V*oe/te.clientHeight,n.object.matrix),L(2*W*oe/te.clientHeight,n.object.matrix)}else n.object.isOrthographicCamera?(T(V*(n.object.right-n.object.left)/n.object.zoom/te.clientWidth,n.object.matrix),L(W*(n.object.top-n.object.bottom)/n.object.zoom/te.clientHeight,n.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),n.enablePan=!1)}}();function R(x){n.object.isPerspectiveCamera||n.object.isOrthographicCamera?c/=x:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),n.enableZoom=!1)}function D(x){n.object.isPerspectiveCamera||n.object.isOrthographicCamera?c*=x:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),n.enableZoom=!1)}function G(x,k){if(!n.zoomToCursor)return;M=!0;const V=n.domElement.getBoundingClientRect(),W=x-V.left,te=k-V.top,Ae=V.width,oe=V.height;S.x=W/Ae*2-1,S.y=-(te/oe)*2+1,E.set(S.x,S.y,1).unproject(n.object).sub(n.object.position).normalize()}function H(x){return Math.max(n.minDistance,Math.min(n.maxDistance,x))}function ee(x){d.set(x.clientX,x.clientY)}function Q(x){G(x.clientX,x.clientX),b.set(x.clientX,x.clientY)}function j(x){h.set(x.clientX,x.clientY)}function xe(x){u.set(x.clientX,x.clientY),g.subVectors(u,d).multiplyScalar(n.rotateSpeed);const k=n.domElement;B(2*Math.PI*g.x/k.clientHeight),O(2*Math.PI*g.y/k.clientHeight),d.copy(u),n.update()}function Le(x){v.set(x.clientX,x.clientY),A.subVectors(v,b),A.y>0?R(I(A.y)):A.y<0&&D(I(A.y)),b.copy(v),n.update()}function qe(x){y.set(x.clientX,x.clientY),m.subVectors(y,h).multiplyScalar(n.panSpeed),P(m.x,m.y),h.copy(y),n.update()}function Ve(x){G(x.clientX,x.clientY),x.deltaY<0?D(I(x.deltaY)):x.deltaY>0&&R(I(x.deltaY)),n.update()}function at(x){let k=!1;switch(x.code){case n.keys.UP:x.ctrlKey||x.metaKey||x.shiftKey?O(2*Math.PI*n.rotateSpeed/n.domElement.clientHeight):P(0,n.keyPanSpeed),k=!0;break;case n.keys.BOTTOM:x.ctrlKey||x.metaKey||x.shiftKey?O(-2*Math.PI*n.rotateSpeed/n.domElement.clientHeight):P(0,-n.keyPanSpeed),k=!0;break;case n.keys.LEFT:x.ctrlKey||x.metaKey||x.shiftKey?B(2*Math.PI*n.rotateSpeed/n.domElement.clientHeight):P(n.keyPanSpeed,0),k=!0;break;case n.keys.RIGHT:x.ctrlKey||x.metaKey||x.shiftKey?B(-2*Math.PI*n.rotateSpeed/n.domElement.clientHeight):P(-n.keyPanSpeed,0),k=!0;break}k&&(x.preventDefault(),n.update())}function $n(x){if(N.length===1)d.set(x.pageX,x.pageY);else{const k=Oe(x),V=.5*(x.pageX+k.x),W=.5*(x.pageY+k.y);d.set(V,W)}}function Zn(x){if(N.length===1)h.set(x.pageX,x.pageY);else{const k=Oe(x),V=.5*(x.pageX+k.x),W=.5*(x.pageY+k.y);h.set(V,W)}}function Qn(x){const k=Oe(x),V=x.pageX-k.x,W=x.pageY-k.y,te=Math.sqrt(V*V+W*W);b.set(0,te)}function ca(x){n.enableZoom&&Qn(x),n.enablePan&&Zn(x)}function la(x){n.enableZoom&&Qn(x),n.enableRotate&&$n(x)}function Jn(x){if(N.length==1)u.set(x.pageX,x.pageY);else{const V=Oe(x),W=.5*(x.pageX+V.x),te=.5*(x.pageY+V.y);u.set(W,te)}g.subVectors(u,d).multiplyScalar(n.rotateSpeed);const k=n.domElement;B(2*Math.PI*g.x/k.clientHeight),O(2*Math.PI*g.y/k.clientHeight),d.copy(u)}function es(x){if(N.length===1)y.set(x.pageX,x.pageY);else{const k=Oe(x),V=.5*(x.pageX+k.x),W=.5*(x.pageY+k.y);y.set(V,W)}m.subVectors(y,h).multiplyScalar(n.panSpeed),P(m.x,m.y),h.copy(y)}function ts(x){const k=Oe(x),V=x.pageX-k.x,W=x.pageY-k.y,te=Math.sqrt(V*V+W*W);v.set(0,te),A.set(0,Math.pow(v.y/b.y,n.zoomSpeed)),R(A.y),b.copy(v);const Ae=(x.pageX+k.x)*.5,oe=(x.pageY+k.y)*.5;G(Ae,oe)}function ua(x){n.enableZoom&&ts(x),n.enablePan&&es(x)}function ha(x){n.enableZoom&&ts(x),n.enableRotate&&Jn(x)}function ns(x){n.enabled!==!1&&(N.length===0&&(n.domElement.setPointerCapture(x.pointerId),n.domElement.addEventListener("pointermove",Lt),n.domElement.addEventListener("pointerup",We)),ya(x),x.pointerType==="touch"?pa(x):da(x))}function Lt(x){n.enabled!==!1&&(x.pointerType==="touch"?ma(x):fa(x))}function We(x){ga(x),N.length===0&&(n.domElement.releasePointerCapture(x.pointerId),n.domElement.removeEventListener("pointermove",Lt),n.domElement.removeEventListener("pointerup",We)),n.dispatchEvent(zt),i=s.NONE}function da(x){let k;switch(x.button){case 0:k=n.mouseButtons.LEFT;break;case 1:k=n.mouseButtons.MIDDLE;break;case 2:k=n.mouseButtons.RIGHT;break;default:k=-1}switch(k){case w.MOUSE.DOLLY:if(n.enableZoom===!1)return;Q(x),i=s.DOLLY;break;case w.MOUSE.ROTATE:if(x.ctrlKey||x.metaKey||x.shiftKey){if(n.enablePan===!1)return;j(x),i=s.PAN}else{if(n.enableRotate===!1)return;ee(x),i=s.ROTATE}break;case w.MOUSE.PAN:if(x.ctrlKey||x.metaKey||x.shiftKey){if(n.enableRotate===!1)return;ee(x),i=s.ROTATE}else{if(n.enablePan===!1)return;j(x),i=s.PAN}break;default:i=s.NONE}i!==s.NONE&&n.dispatchEvent(lt)}function fa(x){switch(i){case s.ROTATE:if(n.enableRotate===!1)return;xe(x);break;case s.DOLLY:if(n.enableZoom===!1)return;Le(x);break;case s.PAN:if(n.enablePan===!1)return;qe(x);break}}function ss(x){n.enabled===!1||n.enableZoom===!1||i!==s.NONE||(x.preventDefault(),n.dispatchEvent(lt),Ve(x),n.dispatchEvent(zt))}function Ot(x){n.enabled===!1||n.enablePan===!1||at(x)}function pa(x){switch(os(x),N.length){case 1:switch(n.touches.ONE){case w.TOUCH.ROTATE:if(n.enableRotate===!1)return;$n(x),i=s.TOUCH_ROTATE;break;case w.TOUCH.PAN:if(n.enablePan===!1)return;Zn(x),i=s.TOUCH_PAN;break;default:i=s.NONE}break;case 2:switch(n.touches.TWO){case w.TOUCH.DOLLY_PAN:if(n.enableZoom===!1&&n.enablePan===!1)return;ca(x),i=s.TOUCH_DOLLY_PAN;break;case w.TOUCH.DOLLY_ROTATE:if(n.enableZoom===!1&&n.enableRotate===!1)return;la(x),i=s.TOUCH_DOLLY_ROTATE;break;default:i=s.NONE}break;default:i=s.NONE}i!==s.NONE&&n.dispatchEvent(lt)}function ma(x){switch(os(x),i){case s.TOUCH_ROTATE:if(n.enableRotate===!1)return;Jn(x),n.update();break;case s.TOUCH_PAN:if(n.enablePan===!1)return;es(x),n.update();break;case s.TOUCH_DOLLY_PAN:if(n.enableZoom===!1&&n.enablePan===!1)return;ua(x),n.update();break;case s.TOUCH_DOLLY_ROTATE:if(n.enableZoom===!1&&n.enableRotate===!1)return;ha(x),n.update();break;default:i=s.NONE}}function is(x){n.enabled!==!1&&x.preventDefault()}function ya(x){N.push(x.pointerId)}function ga(x){delete C[x.pointerId];for(let k=0;k<N.length;k++)if(N[k]==x.pointerId){N.splice(k,1);return}}function os(x){let k=C[x.pointerId];k===void 0&&(k=new w.Vector2,C[x.pointerId]=k),k.set(x.pageX,x.pageY)}function Oe(x){const k=x.pointerId===N[0]?N[1]:N[0];return C[k]}n.domElement.addEventListener("contextmenu",is),n.domElement.addEventListener("pointerdown",ns),n.domElement.addEventListener("pointercancel",We),n.domElement.addEventListener("wheel",ss,{passive:!1}),this.update()}}class re{constructor(e){e===void 0&&(e=[0,0,0,0,0,0,0,0,0]),this.elements=e}identity(){const e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}setZero(){const e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0}setTrace(e){const t=this.elements;t[0]=e.x,t[4]=e.y,t[8]=e.z}getTrace(e){e===void 0&&(e=new f);const t=this.elements;return e.x=t[0],e.y=t[4],e.z=t[8],e}vmult(e,t){t===void 0&&(t=new f);const n=this.elements,s=e.x,i=e.y,o=e.z;return t.x=n[0]*s+n[1]*i+n[2]*o,t.y=n[3]*s+n[4]*i+n[5]*o,t.z=n[6]*s+n[7]*i+n[8]*o,t}smult(e){for(let t=0;t<this.elements.length;t++)this.elements[t]*=e}mmult(e,t){t===void 0&&(t=new re);const n=this.elements,s=e.elements,i=t.elements,o=n[0],r=n[1],a=n[2],c=n[3],l=n[4],d=n[5],u=n[6],g=n[7],h=n[8],y=s[0],m=s[1],b=s[2],v=s[3],A=s[4],E=s[5],S=s[6],M=s[7],N=s[8];return i[0]=o*y+r*v+a*S,i[1]=o*m+r*A+a*M,i[2]=o*b+r*E+a*N,i[3]=c*y+l*v+d*S,i[4]=c*m+l*A+d*M,i[5]=c*b+l*E+d*N,i[6]=u*y+g*v+h*S,i[7]=u*m+g*A+h*M,i[8]=u*b+g*E+h*N,t}scale(e,t){t===void 0&&(t=new re);const n=this.elements,s=t.elements;for(let i=0;i!==3;i++)s[3*i+0]=e.x*n[3*i+0],s[3*i+1]=e.y*n[3*i+1],s[3*i+2]=e.z*n[3*i+2];return t}solve(e,t){t===void 0&&(t=new f);const n=3,s=4,i=[];let o,r;for(o=0;o<n*s;o++)i.push(0);for(o=0;o<3;o++)for(r=0;r<3;r++)i[o+s*r]=this.elements[o+3*r];i[3+4*0]=e.x,i[3+4*1]=e.y,i[3+4*2]=e.z;let a=3;const c=a;let l;const d=4;let u;do{if(o=c-a,i[o+s*o]===0){for(r=o+1;r<c;r++)if(i[o+s*r]!==0){l=d;do u=d-l,i[u+s*o]+=i[u+s*r];while(--l);break}}if(i[o+s*o]!==0)for(r=o+1;r<c;r++){const g=i[o+s*r]/i[o+s*o];l=d;do u=d-l,i[u+s*r]=u<=o?0:i[u+s*r]-i[u+s*o]*g;while(--l)}}while(--a);if(t.z=i[2*s+3]/i[2*s+2],t.y=(i[1*s+3]-i[1*s+2]*t.z)/i[1*s+1],t.x=(i[0*s+3]-i[0*s+2]*t.z-i[0*s+1]*t.y)/i[0*s+0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===1/0||t.y===1/0||t.z===1/0)throw`Could not solve equation! Got x=[${t.toString()}], b=[${e.toString()}], A=[${this.toString()}]`;return t}e(e,t,n){if(n===void 0)return this.elements[t+3*e];this.elements[t+3*e]=n}copy(e){for(let t=0;t<e.elements.length;t++)this.elements[t]=e.elements[t];return this}toString(){let e="";const t=",";for(let n=0;n<9;n++)e+=this.elements[n]+t;return e}reverse(e){e===void 0&&(e=new re);const t=3,n=6,s=ls;let i,o;for(i=0;i<3;i++)for(o=0;o<3;o++)s[i+n*o]=this.elements[i+3*o];s[3+6*0]=1,s[3+6*1]=0,s[3+6*2]=0,s[4+6*0]=0,s[4+6*1]=1,s[4+6*2]=0,s[5+6*0]=0,s[5+6*1]=0,s[5+6*2]=1;let r=3;const a=r;let c;const l=n;let d;do{if(i=a-r,s[i+n*i]===0){for(o=i+1;o<a;o++)if(s[i+n*o]!==0){c=l;do d=l-c,s[d+n*i]+=s[d+n*o];while(--c);break}}if(s[i+n*i]!==0)for(o=i+1;o<a;o++){const u=s[i+n*o]/s[i+n*i];c=l;do d=l-c,s[d+n*o]=d<=i?0:s[d+n*o]-s[d+n*i]*u;while(--c)}}while(--r);i=2;do{o=i-1;do{const u=s[i+n*o]/s[i+n*i];c=n;do d=n-c,s[d+n*o]=s[d+n*o]-s[d+n*i]*u;while(--c)}while(o--)}while(--i);i=2;do{const u=1/s[i+n*i];c=n;do d=n-c,s[d+n*i]=s[d+n*i]*u;while(--c)}while(i--);i=2;do{o=2;do{if(d=s[t+o+n*i],isNaN(d)||d===1/0)throw`Could not reverse! A=[${this.toString()}]`;e.e(i,o,d)}while(o--)}while(i--);return e}setRotationFromQuaternion(e){const t=e.x,n=e.y,s=e.z,i=e.w,o=t+t,r=n+n,a=s+s,c=t*o,l=t*r,d=t*a,u=n*r,g=n*a,h=s*a,y=i*o,m=i*r,b=i*a,v=this.elements;return v[3*0+0]=1-(u+h),v[3*0+1]=l-b,v[3*0+2]=d+m,v[3*1+0]=l+b,v[3*1+1]=1-(c+h),v[3*1+2]=g-y,v[3*2+0]=d-m,v[3*2+1]=g+y,v[3*2+2]=1-(c+u),this}transpose(e){e===void 0&&(e=new re);const t=this.elements,n=e.elements;let s;return n[0]=t[0],n[4]=t[4],n[8]=t[8],s=t[1],n[1]=t[3],n[3]=s,s=t[2],n[2]=t[6],n[6]=s,s=t[5],n[5]=t[7],n[7]=s,e}}const ls=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];class f{constructor(e,t,n){e===void 0&&(e=0),t===void 0&&(t=0),n===void 0&&(n=0),this.x=e,this.y=t,this.z=n}cross(e,t){t===void 0&&(t=new f);const n=e.x,s=e.y,i=e.z,o=this.x,r=this.y,a=this.z;return t.x=r*i-a*s,t.y=a*n-o*i,t.z=o*s-r*n,t}set(e,t,n){return this.x=e,this.y=t,this.z=n,this}setZero(){this.x=this.y=this.z=0}vadd(e,t){if(t)t.x=e.x+this.x,t.y=e.y+this.y,t.z=e.z+this.z;else return new f(this.x+e.x,this.y+e.y,this.z+e.z)}vsub(e,t){if(t)t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z;else return new f(this.x-e.x,this.y-e.y,this.z-e.z)}crossmat(){return new re([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])}normalize(){const e=this.x,t=this.y,n=this.z,s=Math.sqrt(e*e+t*t+n*n);if(s>0){const i=1/s;this.x*=i,this.y*=i,this.z*=i}else this.x=0,this.y=0,this.z=0;return s}unit(e){e===void 0&&(e=new f);const t=this.x,n=this.y,s=this.z;let i=Math.sqrt(t*t+n*n+s*s);return i>0?(i=1/i,e.x=t*i,e.y=n*i,e.z=s*i):(e.x=1,e.y=0,e.z=0),e}length(){const e=this.x,t=this.y,n=this.z;return Math.sqrt(e*e+t*t+n*n)}lengthSquared(){return this.dot(this)}distanceTo(e){const t=this.x,n=this.y,s=this.z,i=e.x,o=e.y,r=e.z;return Math.sqrt((i-t)*(i-t)+(o-n)*(o-n)+(r-s)*(r-s))}distanceSquared(e){const t=this.x,n=this.y,s=this.z,i=e.x,o=e.y,r=e.z;return(i-t)*(i-t)+(o-n)*(o-n)+(r-s)*(r-s)}scale(e,t){t===void 0&&(t=new f);const n=this.x,s=this.y,i=this.z;return t.x=e*n,t.y=e*s,t.z=e*i,t}vmul(e,t){return t===void 0&&(t=new f),t.x=e.x*this.x,t.y=e.y*this.y,t.z=e.z*this.z,t}addScaledVector(e,t,n){return n===void 0&&(n=new f),n.x=this.x+e*t.x,n.y=this.y+e*t.y,n.z=this.z+e*t.z,n}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}isZero(){return this.x===0&&this.y===0&&this.z===0}negate(e){return e===void 0&&(e=new f),e.x=-this.x,e.y=-this.y,e.z=-this.z,e}tangents(e,t){const n=this.length();if(n>0){const s=us,i=1/n;s.set(this.x*i,this.y*i,this.z*i);const o=hs;Math.abs(s.x)<.9?(o.set(1,0,0),s.cross(o,e)):(o.set(0,1,0),s.cross(o,e)),s.cross(e,t)}else e.set(1,0,0),t.set(0,1,0)}toString(){return`${this.x},${this.y},${this.z}`}toArray(){return[this.x,this.y,this.z]}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}lerp(e,t,n){const s=this.x,i=this.y,o=this.z;n.x=s+(e.x-s)*t,n.y=i+(e.y-i)*t,n.z=o+(e.z-o)*t}almostEquals(e,t){return t===void 0&&(t=1e-6),!(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t)}almostZero(e){return e===void 0&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)}isAntiparallelTo(e,t){return this.negate(jt),jt.almostEquals(e,t)}clone(){return new f(this.x,this.y,this.z)}}f.ZERO=new f(0,0,0),f.UNIT_X=new f(1,0,0),f.UNIT_Y=new f(0,1,0),f.UNIT_Z=new f(0,0,1);const us=new f,hs=new f,jt=new f;class se{constructor(e){e===void 0&&(e={}),this.lowerBound=new f,this.upperBound=new f,e.lowerBound&&this.lowerBound.copy(e.lowerBound),e.upperBound&&this.upperBound.copy(e.upperBound)}setFromPoints(e,t,n,s){const i=this.lowerBound,o=this.upperBound,r=n;i.copy(e[0]),r&&r.vmult(i,i),o.copy(i);for(let a=1;a<e.length;a++){let c=e[a];r&&(r.vmult(c,Dt),c=Dt),c.x>o.x&&(o.x=c.x),c.x<i.x&&(i.x=c.x),c.y>o.y&&(o.y=c.y),c.y<i.y&&(i.y=c.y),c.z>o.z&&(o.z=c.z),c.z<i.z&&(i.z=c.z)}return t&&(t.vadd(i,i),t.vadd(o,o)),s&&(i.x-=s,i.y-=s,i.z-=s,o.x+=s,o.y+=s,o.z+=s),this}copy(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this}clone(){return new se().copy(this)}extend(e){this.lowerBound.x=Math.min(this.lowerBound.x,e.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,e.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,e.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,e.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,e.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,e.upperBound.z)}overlaps(e){const t=this.lowerBound,n=this.upperBound,s=e.lowerBound,i=e.upperBound,o=s.x<=n.x&&n.x<=i.x||t.x<=i.x&&i.x<=n.x,r=s.y<=n.y&&n.y<=i.y||t.y<=i.y&&i.y<=n.y,a=s.z<=n.z&&n.z<=i.z||t.z<=i.z&&i.z<=n.z;return o&&r&&a}volume(){const e=this.lowerBound,t=this.upperBound;return(t.x-e.x)*(t.y-e.y)*(t.z-e.z)}contains(e){const t=this.lowerBound,n=this.upperBound,s=e.lowerBound,i=e.upperBound;return t.x<=s.x&&n.x>=i.x&&t.y<=s.y&&n.y>=i.y&&t.z<=s.z&&n.z>=i.z}getCorners(e,t,n,s,i,o,r,a){const c=this.lowerBound,l=this.upperBound;e.copy(c),t.set(l.x,c.y,c.z),n.set(l.x,l.y,c.z),s.set(c.x,l.y,l.z),i.set(l.x,c.y,l.z),o.set(c.x,l.y,c.z),r.set(c.x,c.y,l.z),a.copy(l)}toLocalFrame(e,t){const n=Gt,s=n[0],i=n[1],o=n[2],r=n[3],a=n[4],c=n[5],l=n[6],d=n[7];this.getCorners(s,i,o,r,a,c,l,d);for(let u=0;u!==8;u++){const g=n[u];e.pointToLocal(g,g)}return t.setFromPoints(n)}toWorldFrame(e,t){const n=Gt,s=n[0],i=n[1],o=n[2],r=n[3],a=n[4],c=n[5],l=n[6],d=n[7];this.getCorners(s,i,o,r,a,c,l,d);for(let u=0;u!==8;u++){const g=n[u];e.pointToWorld(g,g)}return t.setFromPoints(n)}overlapsRay(e){const{direction:t,from:n}=e,s=1/t.x,i=1/t.y,o=1/t.z,r=(this.lowerBound.x-n.x)*s,a=(this.upperBound.x-n.x)*s,c=(this.lowerBound.y-n.y)*i,l=(this.upperBound.y-n.y)*i,d=(this.lowerBound.z-n.z)*o,u=(this.upperBound.z-n.z)*o,g=Math.max(Math.max(Math.min(r,a),Math.min(c,l)),Math.min(d,u)),h=Math.min(Math.min(Math.max(r,a),Math.max(c,l)),Math.max(d,u));return!(h<0||g>h)}}const Dt=new f,Gt=[new f,new f,new f,new f,new f,new f,new f,new f];class Ht{constructor(){this.matrix=[]}get(e,t){let{index:n}=e,{index:s}=t;if(s>n){const i=s;s=n,n=i}return this.matrix[(n*(n+1)>>1)+s-1]}set(e,t,n){let{index:s}=e,{index:i}=t;if(i>s){const o=i;i=s,s=o}this.matrix[(s*(s+1)>>1)+i-1]=n?1:0}reset(){for(let e=0,t=this.matrix.length;e!==t;e++)this.matrix[e]=0}setNumObjects(e){this.matrix.length=e*(e-1)>>1}}class Ut{addEventListener(e,t){this._listeners===void 0&&(this._listeners={});const n=this._listeners;return n[e]===void 0&&(n[e]=[]),n[e].includes(t)||n[e].push(t),this}hasEventListener(e,t){if(this._listeners===void 0)return!1;const n=this._listeners;return!!(n[e]!==void 0&&n[e].includes(t))}hasAnyEventListener(e){return this._listeners===void 0?!1:this._listeners[e]!==void 0}removeEventListener(e,t){if(this._listeners===void 0)return this;const n=this._listeners;if(n[e]===void 0)return this;const s=n[e].indexOf(t);return s!==-1&&n[e].splice(s,1),this}dispatchEvent(e){if(this._listeners===void 0)return this;const n=this._listeners[e.type];if(n!==void 0){e.target=this;for(let s=0,i=n.length;s<i;s++)n[s].call(this,e)}return this}}class Y{constructor(e,t,n,s){e===void 0&&(e=0),t===void 0&&(t=0),n===void 0&&(n=0),s===void 0&&(s=1),this.x=e,this.y=t,this.z=n,this.w=s}set(e,t,n,s){return this.x=e,this.y=t,this.z=n,this.w=s,this}toString(){return`${this.x},${this.y},${this.z},${this.w}`}toArray(){return[this.x,this.y,this.z,this.w]}setFromAxisAngle(e,t){const n=Math.sin(t*.5);return this.x=e.x*n,this.y=e.y*n,this.z=e.z*n,this.w=Math.cos(t*.5),this}toAxisAngle(e){e===void 0&&(e=new f),this.normalize();const t=2*Math.acos(this.w),n=Math.sqrt(1-this.w*this.w);return n<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/n,e.y=this.y/n,e.z=this.z/n),[e,t]}setFromVectors(e,t){if(e.isAntiparallelTo(t)){const n=ds,s=fs;e.tangents(n,s),this.setFromAxisAngle(n,Math.PI)}else{const n=e.cross(t);this.x=n.x,this.y=n.y,this.z=n.z,this.w=Math.sqrt(e.length()**2*t.length()**2)+e.dot(t),this.normalize()}return this}mult(e,t){t===void 0&&(t=new Y);const n=this.x,s=this.y,i=this.z,o=this.w,r=e.x,a=e.y,c=e.z,l=e.w;return t.x=n*l+o*r+s*c-i*a,t.y=s*l+o*a+i*r-n*c,t.z=i*l+o*c+n*a-s*r,t.w=o*l-n*r-s*a-i*c,t}inverse(e){e===void 0&&(e=new Y);const t=this.x,n=this.y,s=this.z,i=this.w;this.conjugate(e);const o=1/(t*t+n*n+s*s+i*i);return e.x*=o,e.y*=o,e.z*=o,e.w*=o,e}conjugate(e){return e===void 0&&(e=new Y),e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e}normalize(){let e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return e===0?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this}normalizeFast(){const e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return e===0?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e),this}vmult(e,t){t===void 0&&(t=new f);const n=e.x,s=e.y,i=e.z,o=this.x,r=this.y,a=this.z,c=this.w,l=c*n+r*i-a*s,d=c*s+a*n-o*i,u=c*i+o*s-r*n,g=-o*n-r*s-a*i;return t.x=l*c+g*-o+d*-a-u*-r,t.y=d*c+g*-r+u*-o-l*-a,t.z=u*c+g*-a+l*-r-d*-o,t}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}toEuler(e,t){t===void 0&&(t="YZX");let n,s,i;const o=this.x,r=this.y,a=this.z,c=this.w;switch(t){case"YZX":const l=o*r+a*c;if(l>.499&&(n=2*Math.atan2(o,c),s=Math.PI/2,i=0),l<-.499&&(n=-2*Math.atan2(o,c),s=-Math.PI/2,i=0),n===void 0){const d=o*o,u=r*r,g=a*a;n=Math.atan2(2*r*c-2*o*a,1-2*u-2*g),s=Math.asin(2*l),i=Math.atan2(2*o*c-2*r*a,1-2*d-2*g)}break;default:throw new Error(`Euler order ${t} not supported yet.`)}e.y=n,e.z=s,e.x=i}setFromEuler(e,t,n,s){s===void 0&&(s="XYZ");const i=Math.cos(e/2),o=Math.cos(t/2),r=Math.cos(n/2),a=Math.sin(e/2),c=Math.sin(t/2),l=Math.sin(n/2);return s==="XYZ"?(this.x=a*o*r+i*c*l,this.y=i*c*r-a*o*l,this.z=i*o*l+a*c*r,this.w=i*o*r-a*c*l):s==="YXZ"?(this.x=a*o*r+i*c*l,this.y=i*c*r-a*o*l,this.z=i*o*l-a*c*r,this.w=i*o*r+a*c*l):s==="ZXY"?(this.x=a*o*r-i*c*l,this.y=i*c*r+a*o*l,this.z=i*o*l+a*c*r,this.w=i*o*r-a*c*l):s==="ZYX"?(this.x=a*o*r-i*c*l,this.y=i*c*r+a*o*l,this.z=i*o*l-a*c*r,this.w=i*o*r+a*c*l):s==="YZX"?(this.x=a*o*r+i*c*l,this.y=i*c*r+a*o*l,this.z=i*o*l-a*c*r,this.w=i*o*r-a*c*l):s==="XZY"&&(this.x=a*o*r-i*c*l,this.y=i*c*r-a*o*l,this.z=i*o*l+a*c*r,this.w=i*o*r+a*c*l),this}clone(){return new Y(this.x,this.y,this.z,this.w)}slerp(e,t,n){n===void 0&&(n=new Y);const s=this.x,i=this.y,o=this.z,r=this.w;let a=e.x,c=e.y,l=e.z,d=e.w,u,g,h,y,m;return g=s*a+i*c+o*l+r*d,g<0&&(g=-g,a=-a,c=-c,l=-l,d=-d),1-g>1e-6?(u=Math.acos(g),h=Math.sin(u),y=Math.sin((1-t)*u)/h,m=Math.sin(t*u)/h):(y=1-t,m=t),n.x=y*s+m*a,n.y=y*i+m*c,n.z=y*o+m*l,n.w=y*r+m*d,n}integrate(e,t,n,s){s===void 0&&(s=new Y);const i=e.x*n.x,o=e.y*n.y,r=e.z*n.z,a=this.x,c=this.y,l=this.z,d=this.w,u=t*.5;return s.x+=u*(i*d+o*l-r*c),s.y+=u*(o*d+r*a-i*l),s.z+=u*(r*d+i*c-o*a),s.w+=u*(-i*a-o*c-r*l),s}}const ds=new f,fs=new f,ps={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256};class F{constructor(e){e===void 0&&(e={}),this.id=F.idCounter++,this.type=e.type||0,this.boundingSphereRadius=0,this.collisionResponse=e.collisionResponse?e.collisionResponse:!0,this.collisionFilterGroup=e.collisionFilterGroup!==void 0?e.collisionFilterGroup:1,this.collisionFilterMask=e.collisionFilterMask!==void 0?e.collisionFilterMask:-1,this.material=e.material?e.material:null,this.body=null}updateBoundingSphereRadius(){throw`computeBoundingSphereRadius() not implemented for shape type ${this.type}`}volume(){throw`volume() not implemented for shape type ${this.type}`}calculateLocalInertia(e,t){throw`calculateLocalInertia() not implemented for shape type ${this.type}`}calculateWorldAABB(e,t,n,s){throw`calculateWorldAABB() not implemented for shape type ${this.type}`}}F.idCounter=0,F.types=ps;class q{constructor(e){e===void 0&&(e={}),this.position=new f,this.quaternion=new Y,e.position&&this.position.copy(e.position),e.quaternion&&this.quaternion.copy(e.quaternion)}pointToLocal(e,t){return q.pointToLocalFrame(this.position,this.quaternion,e,t)}pointToWorld(e,t){return q.pointToWorldFrame(this.position,this.quaternion,e,t)}vectorToWorldFrame(e,t){return t===void 0&&(t=new f),this.quaternion.vmult(e,t),t}static pointToLocalFrame(e,t,n,s){return s===void 0&&(s=new f),n.vsub(e,s),t.conjugate(qt),qt.vmult(s,s),s}static pointToWorldFrame(e,t,n,s){return s===void 0&&(s=new f),t.vmult(n,s),s.vadd(e,s),s}static vectorToWorldFrame(e,t,n){return n===void 0&&(n=new f),e.vmult(t,n),n}static vectorToLocalFrame(e,t,n,s){return s===void 0&&(s=new f),t.w*=-1,t.vmult(n,s),t.w*=-1,s}}const qt=new Y;class Fe extends F{constructor(e){e===void 0&&(e={});const{vertices:t=[],faces:n=[],normals:s=[],axes:i,boundingSphereRadius:o}=e;super({type:F.types.CONVEXPOLYHEDRON}),this.vertices=t,this.faces=n,this.faceNormals=s,this.faceNormals.length===0&&this.computeNormals(),o?this.boundingSphereRadius=o:this.updateBoundingSphereRadius(),this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.worldFaceNormals=[],this.worldFaceNormalsNeedsUpdate=!0,this.uniqueAxes=i?i.slice():null,this.uniqueEdges=[],this.computeEdges()}computeEdges(){const e=this.faces,t=this.vertices,n=this.uniqueEdges;n.length=0;const s=new f;for(let i=0;i!==e.length;i++){const o=e[i],r=o.length;for(let a=0;a!==r;a++){const c=(a+1)%r;t[o[a]].vsub(t[o[c]],s),s.normalize();let l=!1;for(let d=0;d!==n.length;d++)if(n[d].almostEquals(s)||n[d].almostEquals(s)){l=!0;break}l||n.push(s.clone())}}}computeNormals(){this.faceNormals.length=this.faces.length;for(let e=0;e<this.faces.length;e++){for(let s=0;s<this.faces[e].length;s++)if(!this.vertices[this.faces[e][s]])throw new Error(`Vertex ${this.faces[e][s]} not found!`);const t=this.faceNormals[e]||new f;this.getFaceNormal(e,t),t.negate(t),this.faceNormals[e]=t;const n=this.vertices[this.faces[e][0]];if(t.dot(n)<0){console.error(`.faceNormals[${e}] = Vec3(${t.toString()}) looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.`);for(let s=0;s<this.faces[e].length;s++)console.warn(`.vertices[${this.faces[e][s]}] = Vec3(${this.vertices[this.faces[e][s]].toString()})`)}}}getFaceNormal(e,t){const n=this.faces[e],s=this.vertices[n[0]],i=this.vertices[n[1]],o=this.vertices[n[2]];Fe.computeNormal(s,i,o,t)}static computeNormal(e,t,n,s){const i=new f,o=new f;t.vsub(e,o),n.vsub(t,i),i.cross(o,s),s.isZero()||s.normalize()}clipAgainstHull(e,t,n,s,i,o,r,a,c){const l=new f;let d=-1,u=-Number.MAX_VALUE;for(let h=0;h<n.faces.length;h++){l.copy(n.faceNormals[h]),i.vmult(l,l);const y=l.dot(o);y>u&&(u=y,d=h)}const g=[];for(let h=0;h<n.faces[d].length;h++){const y=n.vertices[n.faces[d][h]],m=new f;m.copy(y),i.vmult(m,m),s.vadd(m,m),g.push(m)}d>=0&&this.clipFaceAgainstHull(o,e,t,g,r,a,c)}findSeparatingAxis(e,t,n,s,i,o,r,a){const c=new f,l=new f,d=new f,u=new f,g=new f,h=new f;let y=Number.MAX_VALUE;const m=this;if(m.uniqueAxes)for(let b=0;b!==m.uniqueAxes.length;b++){n.vmult(m.uniqueAxes[b],c);const v=m.testSepAxis(c,e,t,n,s,i);if(v===!1)return!1;v<y&&(y=v,o.copy(c))}else{const b=r?r.length:m.faces.length;for(let v=0;v<b;v++){const A=r?r[v]:v;c.copy(m.faceNormals[A]),n.vmult(c,c);const E=m.testSepAxis(c,e,t,n,s,i);if(E===!1)return!1;E<y&&(y=E,o.copy(c))}}if(e.uniqueAxes)for(let b=0;b!==e.uniqueAxes.length;b++){i.vmult(e.uniqueAxes[b],l);const v=m.testSepAxis(l,e,t,n,s,i);if(v===!1)return!1;v<y&&(y=v,o.copy(l))}else{const b=a?a.length:e.faces.length;for(let v=0;v<b;v++){const A=a?a[v]:v;l.copy(e.faceNormals[A]),i.vmult(l,l);const E=m.testSepAxis(l,e,t,n,s,i);if(E===!1)return!1;E<y&&(y=E,o.copy(l))}}for(let b=0;b!==m.uniqueEdges.length;b++){n.vmult(m.uniqueEdges[b],u);for(let v=0;v!==e.uniqueEdges.length;v++)if(i.vmult(e.uniqueEdges[v],g),u.cross(g,h),!h.almostZero()){h.normalize();const A=m.testSepAxis(h,e,t,n,s,i);if(A===!1)return!1;A<y&&(y=A,o.copy(h))}}return s.vsub(t,d),d.dot(o)>0&&o.negate(o),!0}testSepAxis(e,t,n,s,i,o){const r=this;Fe.project(r,e,n,s,ut),Fe.project(t,e,i,o,ht);const a=ut[0],c=ut[1],l=ht[0],d=ht[1];if(a<d||l<c)return!1;const u=a-d,g=l-c;return u<g?u:g}calculateLocalInertia(e,t){const n=new f,s=new f;this.computeLocalAABB(s,n);const i=n.x-s.x,o=n.y-s.y,r=n.z-s.z;t.x=1/12*e*(2*o*2*o+2*r*2*r),t.y=1/12*e*(2*i*2*i+2*r*2*r),t.z=1/12*e*(2*o*2*o+2*i*2*i)}getPlaneConstantOfFace(e){const t=this.faces[e],n=this.faceNormals[e],s=this.vertices[t[0]];return-n.dot(s)}clipFaceAgainstHull(e,t,n,s,i,o,r){const a=new f,c=new f,l=new f,d=new f,u=new f,g=new f,h=new f,y=new f,m=this,b=[],v=s,A=b;let E=-1,S=Number.MAX_VALUE;for(let I=0;I<m.faces.length;I++){a.copy(m.faceNormals[I]),n.vmult(a,a);const B=a.dot(e);B<S&&(S=B,E=I)}if(E<0)return;const M=m.faces[E];M.connectedFaces=[];for(let I=0;I<m.faces.length;I++)for(let B=0;B<m.faces[I].length;B++)M.indexOf(m.faces[I][B])!==-1&&I!==E&&M.connectedFaces.indexOf(I)===-1&&M.connectedFaces.push(I);const N=M.length;for(let I=0;I<N;I++){const B=m.vertices[M[I]],O=m.vertices[M[(I+1)%N]];B.vsub(O,c),l.copy(c),n.vmult(l,l),t.vadd(l,l),d.copy(this.faceNormals[E]),n.vmult(d,d),t.vadd(d,d),l.cross(d,u),u.negate(u),g.copy(B),n.vmult(g,g),t.vadd(g,g);const T=M.connectedFaces[I];h.copy(this.faceNormals[T]);const L=this.getPlaneConstantOfFace(T);y.copy(h),n.vmult(y,y);const P=L-y.dot(t);for(this.clipFaceAgainstPlane(v,A,y,P);v.length;)v.shift();for(;A.length;)v.push(A.shift())}h.copy(this.faceNormals[E]);const C=this.getPlaneConstantOfFace(E);y.copy(h),n.vmult(y,y);const _=C-y.dot(t);for(let I=0;I<v.length;I++){let B=y.dot(v[I])+_;if(B<=i&&(console.log(`clamped: depth=${B} to minDist=${i}`),B=i),B<=o){const O=v[I];if(B<=1e-6){const T={point:O,normal:y,depth:B};r.push(T)}}}}clipFaceAgainstPlane(e,t,n,s){let i,o;const r=e.length;if(r<2)return t;let a=e[e.length-1],c=e[0];i=n.dot(a)+s;for(let l=0;l<r;l++){if(c=e[l],o=n.dot(c)+s,i<0)if(o<0){const d=new f;d.copy(c),t.push(d)}else{const d=new f;a.lerp(c,i/(i-o),d),t.push(d)}else if(o<0){const d=new f;a.lerp(c,i/(i-o),d),t.push(d),t.push(c)}a=c,i=o}return t}computeWorldVertices(e,t){for(;this.worldVertices.length<this.vertices.length;)this.worldVertices.push(new f);const n=this.vertices,s=this.worldVertices;for(let i=0;i!==this.vertices.length;i++)t.vmult(n[i],s[i]),e.vadd(s[i],s[i]);this.worldVerticesNeedsUpdate=!1}computeLocalAABB(e,t){const n=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let s=0;s<this.vertices.length;s++){const i=n[s];i.x<e.x?e.x=i.x:i.x>t.x&&(t.x=i.x),i.y<e.y?e.y=i.y:i.y>t.y&&(t.y=i.y),i.z<e.z?e.z=i.z:i.z>t.z&&(t.z=i.z)}}computeWorldFaceNormals(e){const t=this.faceNormals.length;for(;this.worldFaceNormals.length<t;)this.worldFaceNormals.push(new f);const n=this.faceNormals,s=this.worldFaceNormals;for(let i=0;i!==t;i++)e.vmult(n[i],s[i]);this.worldFaceNormalsNeedsUpdate=!1}updateBoundingSphereRadius(){let e=0;const t=this.vertices;for(let n=0;n!==t.length;n++){const s=t[n].lengthSquared();s>e&&(e=s)}this.boundingSphereRadius=Math.sqrt(e)}calculateWorldAABB(e,t,n,s){const i=this.vertices;let o,r,a,c,l,d,u=new f;for(let g=0;g<i.length;g++){u.copy(i[g]),t.vmult(u,u),e.vadd(u,u);const h=u;(o===void 0||h.x<o)&&(o=h.x),(c===void 0||h.x>c)&&(c=h.x),(r===void 0||h.y<r)&&(r=h.y),(l===void 0||h.y>l)&&(l=h.y),(a===void 0||h.z<a)&&(a=h.z),(d===void 0||h.z>d)&&(d=h.z)}n.set(o,r,a),s.set(c,l,d)}volume(){return 4*Math.PI*this.boundingSphereRadius/3}getAveragePointLocal(e){e===void 0&&(e=new f);const t=this.vertices;for(let n=0;n<t.length;n++)e.vadd(t[n],e);return e.scale(1/t.length,e),e}transformAllPoints(e,t){const n=this.vertices.length,s=this.vertices;if(t){for(let i=0;i<n;i++){const o=s[i];t.vmult(o,o)}for(let i=0;i<this.faceNormals.length;i++){const o=this.faceNormals[i];t.vmult(o,o)}}if(e)for(let i=0;i<n;i++){const o=s[i];o.vadd(e,o)}}pointIsInside(e){const t=this.vertices,n=this.faces,s=this.faceNormals,i=null,o=new f;this.getAveragePointLocal(o);for(let r=0;r<this.faces.length;r++){let a=s[r];const c=t[n[r][0]],l=new f;e.vsub(c,l);const d=a.dot(l),u=new f;o.vsub(c,u);const g=a.dot(u);if(d<0&&g>0||d>0&&g<0)return!1}return i?1:-1}static project(e,t,n,s,i){const o=e.vertices.length,r=ms;let a=0,c=0;const l=ys,d=e.vertices;l.setZero(),q.vectorToLocalFrame(n,s,t,r),q.pointToLocalFrame(n,s,l,l);const u=l.dot(r);c=a=d[0].dot(r);for(let g=1;g<o;g++){const h=d[g].dot(r);h>a&&(a=h),h<c&&(c=h)}if(c-=u,a-=u,c>a){const g=c;c=a,a=g}i[0]=a,i[1]=c}}const ut=[],ht=[];new f;const ms=new f,ys=new f;class dt extends F{constructor(e){super({type:F.types.BOX}),this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}updateConvexPolyhedronRepresentation(){const e=this.halfExtents.x,t=this.halfExtents.y,n=this.halfExtents.z,s=f,i=[new s(-e,-t,-n),new s(e,-t,-n),new s(e,t,-n),new s(-e,t,-n),new s(-e,-t,n),new s(e,-t,n),new s(e,t,n),new s(-e,t,n)],o=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],r=[new s(0,0,1),new s(0,1,0),new s(1,0,0)],a=new Fe({vertices:i,faces:o,axes:r});this.convexPolyhedronRepresentation=a,a.material=this.material}calculateLocalInertia(e,t){return t===void 0&&(t=new f),dt.calculateInertia(this.halfExtents,e,t),t}static calculateInertia(e,t,n){const s=e;n.x=1/12*t*(2*s.y*2*s.y+2*s.z*2*s.z),n.y=1/12*t*(2*s.x*2*s.x+2*s.z*2*s.z),n.z=1/12*t*(2*s.y*2*s.y+2*s.x*2*s.x)}getSideNormals(e,t){const n=e,s=this.halfExtents;if(n[0].set(s.x,0,0),n[1].set(0,s.y,0),n[2].set(0,0,s.z),n[3].set(-s.x,0,0),n[4].set(0,-s.y,0),n[5].set(0,0,-s.z),t!==void 0)for(let i=0;i!==n.length;i++)t.vmult(n[i],n[i]);return n}volume(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z}updateBoundingSphereRadius(){this.boundingSphereRadius=this.halfExtents.length()}forEachWorldCorner(e,t,n){const s=this.halfExtents,i=[[s.x,s.y,s.z],[-s.x,s.y,s.z],[-s.x,-s.y,s.z],[-s.x,-s.y,-s.z],[s.x,-s.y,-s.z],[s.x,s.y,-s.z],[-s.x,s.y,-s.z],[s.x,-s.y,s.z]];for(let o=0;o<i.length;o++)we.set(i[o][0],i[o][1],i[o][2]),t.vmult(we,we),e.vadd(we,we),n(we.x,we.y,we.z)}calculateWorldAABB(e,t,n,s){const i=this.halfExtents;ce[0].set(i.x,i.y,i.z),ce[1].set(-i.x,i.y,i.z),ce[2].set(-i.x,-i.y,i.z),ce[3].set(-i.x,-i.y,-i.z),ce[4].set(i.x,-i.y,-i.z),ce[5].set(i.x,i.y,-i.z),ce[6].set(-i.x,i.y,-i.z),ce[7].set(i.x,-i.y,i.z);const o=ce[0];t.vmult(o,o),e.vadd(o,o),s.copy(o),n.copy(o);for(let r=1;r<8;r++){const a=ce[r];t.vmult(a,a),e.vadd(a,a);const c=a.x,l=a.y,d=a.z;c>s.x&&(s.x=c),l>s.y&&(s.y=l),d>s.z&&(s.z=d),c<n.x&&(n.x=c),l<n.y&&(n.y=l),d<n.z&&(n.z=d)}}}const we=new f,ce=[new f,new f,new f,new f,new f,new f,new f,new f],ft={DYNAMIC:1,STATIC:2,KINEMATIC:4},pt={AWAKE:0,SLEEPY:1,SLEEPING:2};class z extends Ut{constructor(e){e===void 0&&(e={}),super(),this.id=z.idCounter++,this.index=-1,this.world=null,this.vlambda=new f,this.collisionFilterGroup=typeof e.collisionFilterGroup=="number"?e.collisionFilterGroup:1,this.collisionFilterMask=typeof e.collisionFilterMask=="number"?e.collisionFilterMask:-1,this.collisionResponse=typeof e.collisionResponse=="boolean"?e.collisionResponse:!0,this.position=new f,this.previousPosition=new f,this.interpolatedPosition=new f,this.initPosition=new f,e.position&&(this.position.copy(e.position),this.previousPosition.copy(e.position),this.interpolatedPosition.copy(e.position),this.initPosition.copy(e.position)),this.velocity=new f,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new f,this.force=new f;const t=typeof e.mass=="number"?e.mass:0;this.mass=t,this.invMass=t>0?1/t:0,this.material=e.material||null,this.linearDamping=typeof e.linearDamping=="number"?e.linearDamping:.01,this.type=t<=0?z.STATIC:z.DYNAMIC,typeof e.type==typeof z.STATIC&&(this.type=e.type),this.allowSleep=typeof e.allowSleep<"u"?e.allowSleep:!0,this.sleepState=z.AWAKE,this.sleepSpeedLimit=typeof e.sleepSpeedLimit<"u"?e.sleepSpeedLimit:.1,this.sleepTimeLimit=typeof e.sleepTimeLimit<"u"?e.sleepTimeLimit:1,this.timeLastSleepy=0,this.wakeUpAfterNarrowphase=!1,this.torque=new f,this.quaternion=new Y,this.initQuaternion=new Y,this.previousQuaternion=new Y,this.interpolatedQuaternion=new Y,e.quaternion&&(this.quaternion.copy(e.quaternion),this.initQuaternion.copy(e.quaternion),this.previousQuaternion.copy(e.quaternion),this.interpolatedQuaternion.copy(e.quaternion)),this.angularVelocity=new f,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new f,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new f,this.invInertia=new f,this.invInertiaWorld=new re,this.invMassSolve=0,this.invInertiaSolve=new f,this.invInertiaWorldSolve=new re,this.fixedRotation=typeof e.fixedRotation<"u"?e.fixedRotation:!1,this.angularDamping=typeof e.angularDamping<"u"?e.angularDamping:.01,this.linearFactor=new f(1,1,1),e.linearFactor&&this.linearFactor.copy(e.linearFactor),this.angularFactor=new f(1,1,1),e.angularFactor&&this.angularFactor.copy(e.angularFactor),this.aabb=new se,this.aabbNeedsUpdate=!0,this.boundingRadius=0,this.wlambda=new f,this.isTrigger=!!e.isTrigger,e.shape&&this.addShape(e.shape),this.updateMassProperties()}wakeUp(){const e=this.sleepState;this.sleepState=z.AWAKE,this.wakeUpAfterNarrowphase=!1,e===z.SLEEPING&&this.dispatchEvent(z.wakeupEvent)}sleep(){this.sleepState=z.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.wakeUpAfterNarrowphase=!1}sleepTick(e){if(this.allowSleep){const t=this.sleepState,n=this.velocity.lengthSquared()+this.angularVelocity.lengthSquared(),s=this.sleepSpeedLimit**2;t===z.AWAKE&&n<s?(this.sleepState=z.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(z.sleepyEvent)):t===z.SLEEPY&&n>s?this.wakeUp():t===z.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(z.sleepEvent))}}updateSolveMassProperties(){this.sleepState===z.SLEEPING||this.type===z.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))}pointToLocalFrame(e,t){return t===void 0&&(t=new f),e.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t}vectorToLocalFrame(e,t){return t===void 0&&(t=new f),this.quaternion.conjugate().vmult(e,t),t}pointToWorldFrame(e,t){return t===void 0&&(t=new f),this.quaternion.vmult(e,t),t.vadd(this.position,t),t}vectorToWorldFrame(e,t){return t===void 0&&(t=new f),this.quaternion.vmult(e,t),t}addShape(e,t,n){const s=new f,i=new Y;return t&&s.copy(t),n&&i.copy(n),this.shapes.push(e),this.shapeOffsets.push(s),this.shapeOrientations.push(i),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,e.body=this,this}removeShape(e){const t=this.shapes.indexOf(e);return t===-1?(console.warn("Shape does not belong to the body"),this):(this.shapes.splice(t,1),this.shapeOffsets.splice(t,1),this.shapeOrientations.splice(t,1),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,e.body=null,this)}updateBoundingRadius(){const e=this.shapes,t=this.shapeOffsets,n=e.length;let s=0;for(let i=0;i!==n;i++){const o=e[i];o.updateBoundingSphereRadius();const r=t[i].length(),a=o.boundingSphereRadius;r+a>s&&(s=r+a)}this.boundingRadius=s}updateAABB(){const e=this.shapes,t=this.shapeOffsets,n=this.shapeOrientations,s=e.length,i=gs,o=ws,r=this.quaternion,a=this.aabb,c=vs;for(let l=0;l!==s;l++){const d=e[l];r.vmult(t[l],i),i.vadd(this.position,i),r.mult(n[l],o),d.calculateWorldAABB(i,o,c.lowerBound,c.upperBound),l===0?a.copy(c):a.extend(c)}this.aabbNeedsUpdate=!1}updateInertiaWorld(e){const t=this.invInertia;if(!(t.x===t.y&&t.y===t.z&&!e)){const n=bs,s=xs;n.setRotationFromQuaternion(this.quaternion),n.transpose(s),n.scale(t,n),n.mmult(s,this.invInertiaWorld)}}applyForce(e,t){if(t===void 0&&(t=new f),this.type!==z.DYNAMIC)return;this.sleepState===z.SLEEPING&&this.wakeUp();const n=As;t.cross(e,n),this.force.vadd(e,this.force),this.torque.vadd(n,this.torque)}applyLocalForce(e,t){if(t===void 0&&(t=new f),this.type!==z.DYNAMIC)return;const n=Es,s=Ts;this.vectorToWorldFrame(e,n),this.vectorToWorldFrame(t,s),this.applyForce(n,s)}applyTorque(e){this.type===z.DYNAMIC&&(this.sleepState===z.SLEEPING&&this.wakeUp(),this.torque.vadd(e,this.torque))}applyImpulse(e,t){if(t===void 0&&(t=new f),this.type!==z.DYNAMIC)return;this.sleepState===z.SLEEPING&&this.wakeUp();const n=t,s=Ss;s.copy(e),s.scale(this.invMass,s),this.velocity.vadd(s,this.velocity);const i=Ms;n.cross(e,i),this.invInertiaWorld.vmult(i,i),this.angularVelocity.vadd(i,this.angularVelocity)}applyLocalImpulse(e,t){if(t===void 0&&(t=new f),this.type!==z.DYNAMIC)return;const n=Rs,s=Cs;this.vectorToWorldFrame(e,n),this.vectorToWorldFrame(t,s),this.applyImpulse(n,s)}updateMassProperties(){const e=_s;this.invMass=this.mass>0?1/this.mass:0;const t=this.inertia,n=this.fixedRotation;this.updateAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),dt.calculateInertia(e,this.mass,t),this.invInertia.set(t.x>0&&!n?1/t.x:0,t.y>0&&!n?1/t.y:0,t.z>0&&!n?1/t.z:0),this.updateInertiaWorld(!0)}getVelocityAtWorldPoint(e,t){const n=new f;return e.vsub(this.position,n),this.angularVelocity.cross(n,t),this.velocity.vadd(t,t),t}integrate(e,t,n){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),!(this.type===z.DYNAMIC||this.type===z.KINEMATIC)||this.sleepState===z.SLEEPING)return;const s=this.velocity,i=this.angularVelocity,o=this.position,r=this.force,a=this.torque,c=this.quaternion,l=this.invMass,d=this.invInertiaWorld,u=this.linearFactor,g=l*e;s.x+=r.x*g*u.x,s.y+=r.y*g*u.y,s.z+=r.z*g*u.z;const h=d.elements,y=this.angularFactor,m=a.x*y.x,b=a.y*y.y,v=a.z*y.z;i.x+=e*(h[0]*m+h[1]*b+h[2]*v),i.y+=e*(h[3]*m+h[4]*b+h[5]*v),i.z+=e*(h[6]*m+h[7]*b+h[8]*v),o.x+=s.x*e,o.y+=s.y*e,o.z+=s.z*e,c.integrate(this.angularVelocity,e,this.angularFactor,c),t&&(n?c.normalizeFast():c.normalize()),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}}z.idCounter=0,z.COLLIDE_EVENT_NAME="collide",z.DYNAMIC=ft.DYNAMIC,z.STATIC=ft.STATIC,z.KINEMATIC=ft.KINEMATIC,z.AWAKE=pt.AWAKE,z.SLEEPY=pt.SLEEPY,z.SLEEPING=pt.SLEEPING,z.wakeupEvent={type:"wakeup"},z.sleepyEvent={type:"sleepy"},z.sleepEvent={type:"sleep"};const gs=new f,ws=new Y,vs=new se,bs=new re,xs=new re;new re;const As=new f,Es=new f,Ts=new f,Ss=new f,Ms=new f,Rs=new f,Cs=new f,_s=new f;class Ps{constructor(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}collisionPairs(e,t,n){throw new Error("collisionPairs not implemented for this BroadPhase class!")}needBroadphaseCollision(e,t){return!(!(e.collisionFilterGroup&t.collisionFilterMask)||!(t.collisionFilterGroup&e.collisionFilterMask)||(e.type&z.STATIC||e.sleepState===z.SLEEPING)&&(t.type&z.STATIC||t.sleepState===z.SLEEPING))}intersectionTest(e,t,n,s){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,t,n,s):this.doBoundingSphereBroadphase(e,t,n,s)}doBoundingSphereBroadphase(e,t,n,s){const i=Ns;t.position.vsub(e.position,i);const o=(e.boundingRadius+t.boundingRadius)**2;i.lengthSquared()<o&&(n.push(e),s.push(t))}doBoundingBoxBroadphase(e,t,n,s){e.aabbNeedsUpdate&&e.updateAABB(),t.aabbNeedsUpdate&&t.updateAABB(),e.aabb.overlaps(t.aabb)&&(n.push(e),s.push(t))}makePairsUnique(e,t){const n=Is,s=Ls,i=Os,o=e.length;for(let r=0;r!==o;r++)s[r]=e[r],i[r]=t[r];e.length=0,t.length=0;for(let r=0;r!==o;r++){const a=s[r].id,c=i[r].id,l=a<c?`${a},${c}`:`${c},${a}`;n[l]=r,n.keys.push(l)}for(let r=0;r!==n.keys.length;r++){const a=n.keys.pop(),c=n[a];e.push(s[c]),t.push(i[c]),delete n[a]}}setWorld(e){}static boundingSphereCheck(e,t){const n=new f;e.position.vsub(t.position,n);const s=e.shapes[0],i=t.shapes[0];return Math.pow(s.boundingSphereRadius+i.boundingSphereRadius,2)>n.lengthSquared()}aabbQuery(e,t,n){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}}const Ns=new f;new f,new Y,new f;const Is={keys:[]},Ls=[],Os=[];new f,new f,new f;class Vt extends Ps{constructor(){super()}collisionPairs(e,t,n){const s=e.bodies,i=s.length;let o,r;for(let a=0;a!==i;a++)for(let c=0;c!==a;c++)o=s[a],r=s[c],this.needBroadphaseCollision(o,r)&&this.intersectionTest(o,r,t,n)}aabbQuery(e,t,n){n===void 0&&(n=[]);for(let s=0;s<e.bodies.length;s++){const i=e.bodies[s];i.aabbNeedsUpdate&&i.updateAABB(),i.aabb.overlaps(t)&&n.push(i)}return n}}class $e{constructor(){this.rayFromWorld=new f,this.rayToWorld=new f,this.hitNormalWorld=new f,this.hitPointWorld=new f,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1}reset(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1}abort(){this.shouldStop=!0}set(e,t,n,s,i,o,r){this.rayFromWorld.copy(e),this.rayToWorld.copy(t),this.hitNormalWorld.copy(n),this.hitPointWorld.copy(s),this.shape=i,this.body=o,this.distance=r}}let Wt,Xt,Kt,Yt,$t,Zt,Qt;const mt={CLOSEST:1,ANY:2,ALL:4};Wt=F.types.SPHERE,Xt=F.types.PLANE,Kt=F.types.BOX,Yt=F.types.CYLINDER,$t=F.types.CONVEXPOLYHEDRON,Zt=F.types.HEIGHTFIELD,Qt=F.types.TRIMESH;class ${get[Wt](){return this._intersectSphere}get[Xt](){return this._intersectPlane}get[Kt](){return this._intersectBox}get[Yt](){return this._intersectConvex}get[$t](){return this._intersectConvex}get[Zt](){return this._intersectHeightfield}get[Qt](){return this._intersectTrimesh}constructor(e,t){e===void 0&&(e=new f),t===void 0&&(t=new f),this.from=e.clone(),this.to=t.clone(),this.direction=new f,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=$.ANY,this.result=new $e,this.hasHit=!1,this.callback=n=>{}}intersectWorld(e,t){return this.mode=t.mode||$.ANY,this.result=t.result||new $e,this.skipBackfaces=!!t.skipBackfaces,this.collisionFilterMask=typeof t.collisionFilterMask<"u"?t.collisionFilterMask:-1,this.collisionFilterGroup=typeof t.collisionFilterGroup<"u"?t.collisionFilterGroup:-1,this.checkCollisionResponse=typeof t.checkCollisionResponse<"u"?t.checkCollisionResponse:!0,t.from&&this.from.copy(t.from),t.to&&this.to.copy(t.to),this.callback=t.callback||(()=>{}),this.hasHit=!1,this.result.reset(),this.updateDirection(),this.getAABB(Jt),yt.length=0,e.broadphase.aabbQuery(e,Jt,yt),this.intersectBodies(yt),this.hasHit}intersectBody(e,t){t&&(this.result=t,this.updateDirection());const n=this.checkCollisionResponse;if(n&&!e.collisionResponse||!(this.collisionFilterGroup&e.collisionFilterMask)||!(e.collisionFilterGroup&this.collisionFilterMask))return;const s=Fs,i=Bs;for(let o=0,r=e.shapes.length;o<r;o++){const a=e.shapes[o];if(!(n&&!a.collisionResponse)&&(e.quaternion.mult(e.shapeOrientations[o],i),e.quaternion.vmult(e.shapeOffsets[o],s),s.vadd(e.position,s),this.intersectShape(a,i,s,e),this.result.shouldStop))break}}intersectBodies(e,t){t&&(this.result=t,this.updateDirection());for(let n=0,s=e.length;!this.result.shouldStop&&n<s;n++)this.intersectBody(e[n])}updateDirection(){this.to.vsub(this.from,this.direction),this.direction.normalize()}intersectShape(e,t,n,s){const i=this.from;if($s(i,this.direction,n)>e.boundingSphereRadius)return;const r=this[e.type];r&&r.call(this,e,t,n,s,e)}_intersectBox(e,t,n,s,i){return this._intersectConvex(e.convexPolyhedronRepresentation,t,n,s,i)}_intersectPlane(e,t,n,s,i){const o=this.from,r=this.to,a=this.direction,c=new f(0,0,1);t.vmult(c,c);const l=new f;o.vsub(n,l);const d=l.dot(c);r.vsub(n,l);const u=l.dot(c);if(d*u>0||o.distanceTo(r)<d)return;const g=c.dot(a);if(Math.abs(g)<this.precision)return;const h=new f,y=new f,m=new f;o.vsub(n,h);const b=-c.dot(h)/g;a.scale(b,y),o.vadd(y,m),this.reportIntersection(c,m,i,s,-1)}getAABB(e){const{lowerBound:t,upperBound:n}=e,s=this.to,i=this.from;t.x=Math.min(s.x,i.x),t.y=Math.min(s.y,i.y),t.z=Math.min(s.z,i.z),n.x=Math.max(s.x,i.x),n.y=Math.max(s.y,i.y),n.z=Math.max(s.z,i.z)}_intersectHeightfield(e,t,n,s,i){e.data,e.elementSize;const o=zs;o.from.copy(this.from),o.to.copy(this.to),q.pointToLocalFrame(n,t,o.from,o.from),q.pointToLocalFrame(n,t,o.to,o.to),o.updateDirection();const r=ks;let a,c,l,d;a=c=0,l=d=e.data.length-1;const u=new se;o.getAABB(u),e.getIndexOfPosition(u.lowerBound.x,u.lowerBound.y,r,!0),a=Math.max(a,r[0]),c=Math.max(c,r[1]),e.getIndexOfPosition(u.upperBound.x,u.upperBound.y,r,!0),l=Math.min(l,r[0]+1),d=Math.min(d,r[1]+1);for(let g=a;g<l;g++)for(let h=c;h<d;h++){if(this.result.shouldStop)return;if(e.getAabbAtIndex(g,h,u),!!u.overlapsRay(o)){if(e.getConvexTrianglePillar(g,h,!1),q.pointToWorldFrame(n,t,e.pillarOffset,Ze),this._intersectConvex(e.pillarConvex,t,Ze,s,i,en),this.result.shouldStop)return;e.getConvexTrianglePillar(g,h,!0),q.pointToWorldFrame(n,t,e.pillarOffset,Ze),this._intersectConvex(e.pillarConvex,t,Ze,s,i,en)}}}_intersectSphere(e,t,n,s,i){const o=this.from,r=this.to,a=e.radius,c=(r.x-o.x)**2+(r.y-o.y)**2+(r.z-o.z)**2,l=2*((r.x-o.x)*(o.x-n.x)+(r.y-o.y)*(o.y-n.y)+(r.z-o.z)*(o.z-n.z)),d=(o.x-n.x)**2+(o.y-n.y)**2+(o.z-n.z)**2-a**2,u=l**2-4*c*d,g=js,h=Ds;if(!(u<0))if(u===0)o.lerp(r,u,g),g.vsub(n,h),h.normalize(),this.reportIntersection(h,g,i,s,-1);else{const y=(-l-Math.sqrt(u))/(2*c),m=(-l+Math.sqrt(u))/(2*c);if(y>=0&&y<=1&&(o.lerp(r,y,g),g.vsub(n,h),h.normalize(),this.reportIntersection(h,g,i,s,-1)),this.result.shouldStop)return;m>=0&&m<=1&&(o.lerp(r,m,g),g.vsub(n,h),h.normalize(),this.reportIntersection(h,g,i,s,-1))}}_intersectConvex(e,t,n,s,i,o){const r=Gs,a=tn,c=o&&o.faceList||null,l=e.faces,d=e.vertices,u=e.faceNormals,g=this.direction,h=this.from,y=this.to,m=h.distanceTo(y),b=c?c.length:l.length,v=this.result;for(let A=0;!v.shouldStop&&A<b;A++){const E=c?c[A]:A,S=l[E],M=u[E],N=t,C=n;a.copy(d[S[0]]),N.vmult(a,a),a.vadd(C,a),a.vsub(h,a),N.vmult(M,r);const _=g.dot(r);if(Math.abs(_)<this.precision)continue;const I=r.dot(a)/_;if(!(I<0)){g.scale(I,ne),ne.vadd(h,ne),ae.copy(d[S[0]]),N.vmult(ae,ae),C.vadd(ae,ae);for(let B=1;!v.shouldStop&&B<S.length-1;B++){le.copy(d[S[B]]),ue.copy(d[S[B+1]]),N.vmult(le,le),N.vmult(ue,ue),C.vadd(le,le),C.vadd(ue,ue);const O=ne.distanceTo(h);!($.pointInTriangle(ne,ae,le,ue)||$.pointInTriangle(ne,le,ae,ue))||O>m||this.reportIntersection(r,ne,i,s,E)}}}}_intersectTrimesh(e,t,n,s,i,o){const r=Hs,a=Ks,c=Ys,l=tn,d=Us,u=qs,g=Vs,h=Xs,y=Ws,m=e.indices;e.vertices;const b=this.from,v=this.to,A=this.direction;c.position.copy(n),c.quaternion.copy(t),q.vectorToLocalFrame(n,t,A,d),q.pointToLocalFrame(n,t,b,u),q.pointToLocalFrame(n,t,v,g),g.x*=e.scale.x,g.y*=e.scale.y,g.z*=e.scale.z,u.x*=e.scale.x,u.y*=e.scale.y,u.z*=e.scale.z,g.vsub(u,d),d.normalize();const E=u.distanceSquared(g);e.tree.rayQuery(this,c,a);for(let S=0,M=a.length;!this.result.shouldStop&&S!==M;S++){const N=a[S];e.getNormal(N,r),e.getVertex(m[N*3],ae),ae.vsub(u,l);const C=d.dot(r),_=r.dot(l)/C;if(_<0)continue;d.scale(_,ne),ne.vadd(u,ne),e.getVertex(m[N*3+1],le),e.getVertex(m[N*3+2],ue);const I=ne.distanceSquared(u);!($.pointInTriangle(ne,le,ae,ue)||$.pointInTriangle(ne,ae,le,ue))||I>E||(q.vectorToWorldFrame(t,r,y),q.pointToWorldFrame(n,t,ne,h),this.reportIntersection(y,h,i,s,N))}a.length=0}reportIntersection(e,t,n,s,i){const o=this.from,r=this.to,a=o.distanceTo(t),c=this.result;if(!(this.skipBackfaces&&e.dot(this.direction)>0))switch(c.hitFaceIndex=typeof i<"u"?i:-1,this.mode){case $.ALL:this.hasHit=!0,c.set(o,r,e,t,n,s,a),c.hasHit=!0,this.callback(c);break;case $.CLOSEST:(a<c.distance||!c.hasHit)&&(this.hasHit=!0,c.hasHit=!0,c.set(o,r,e,t,n,s,a));break;case $.ANY:this.hasHit=!0,c.hasHit=!0,c.set(o,r,e,t,n,s,a),c.shouldStop=!0;break}}static pointInTriangle(e,t,n,s){s.vsub(t,Ee),n.vsub(t,Be),e.vsub(t,gt);const i=Ee.dot(Ee),o=Ee.dot(Be),r=Ee.dot(gt),a=Be.dot(Be),c=Be.dot(gt);let l,d;return(l=a*r-o*c)>=0&&(d=i*c-o*r)>=0&&l+d<i*a-o*o}}$.CLOSEST=mt.CLOSEST,$.ANY=mt.ANY,$.ALL=mt.ALL;const Jt=new se,yt=[],Be=new f,gt=new f,Fs=new f,Bs=new Y,ne=new f,ae=new f,le=new f,ue=new f;new f,new $e;const en={faceList:[0]},Ze=new f,zs=new $,ks=[],js=new f,Ds=new f,Gs=new f;new f,new f;const tn=new f,Hs=new f,Us=new f,qs=new f,Vs=new f,Ws=new f,Xs=new f;new se;const Ks=[],Ys=new q,Ee=new f,Qe=new f;function $s(p,e,t){t.vsub(p,Ee);const n=Ee.dot(e);return e.scale(n,Qe),Qe.vadd(p,Qe),t.distanceTo(Qe)}class Zs{static defaults(e,t){e===void 0&&(e={});for(let n in t)n in e||(e[n]=t[n]);return e}}class nn{constructor(){this.spatial=new f,this.rotational=new f}multiplyElement(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)}multiplyVectors(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}}class ze{constructor(e,t,n,s){n===void 0&&(n=-1e6),s===void 0&&(s=1e6),this.id=ze.idCounter++,this.minForce=n,this.maxForce=s,this.bi=e,this.bj=t,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new nn,this.jacobianElementB=new nn,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}setSpookParams(e,t,n){const s=t,i=e,o=n;this.a=4/(o*(1+4*s)),this.b=4*s/(1+4*s),this.eps=4/(o*o*i*(1+4*s))}computeB(e,t,n){const s=this.computeGW(),i=this.computeGq(),o=this.computeGiMf();return-i*e-s*t-o*n}computeGq(){const e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,s=this.bj,i=n.position,o=s.position;return e.spatial.dot(i)+t.spatial.dot(o)}computeGW(){const e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,s=this.bj,i=n.velocity,o=s.velocity,r=n.angularVelocity,a=s.angularVelocity;return e.multiplyVectors(i,r)+t.multiplyVectors(o,a)}computeGWlambda(){const e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,s=this.bj,i=n.vlambda,o=s.vlambda,r=n.wlambda,a=s.wlambda;return e.multiplyVectors(i,r)+t.multiplyVectors(o,a)}computeGiMf(){const e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,s=this.bj,i=n.force,o=n.torque,r=s.force,a=s.torque,c=n.invMassSolve,l=s.invMassSolve;return i.scale(c,sn),r.scale(l,on),n.invInertiaWorldSolve.vmult(o,rn),s.invInertiaWorldSolve.vmult(a,an),e.multiplyVectors(sn,rn)+t.multiplyVectors(on,an)}computeGiMGt(){const e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,s=this.bj,i=n.invMassSolve,o=s.invMassSolve,r=n.invInertiaWorldSolve,a=s.invInertiaWorldSolve;let c=i+o;return r.vmult(e.rotational,Je),c+=Je.dot(e.rotational),a.vmult(t.rotational,Je),c+=Je.dot(t.rotational),c}addToWlambda(e){const t=this.jacobianElementA,n=this.jacobianElementB,s=this.bi,i=this.bj,o=Qs;s.vlambda.addScaledVector(s.invMassSolve*e,t.spatial,s.vlambda),i.vlambda.addScaledVector(i.invMassSolve*e,n.spatial,i.vlambda),s.invInertiaWorldSolve.vmult(t.rotational,o),s.wlambda.addScaledVector(e,o,s.wlambda),i.invInertiaWorldSolve.vmult(n.rotational,o),i.wlambda.addScaledVector(e,o,i.wlambda)}computeC(){return this.computeGiMGt()+this.eps}}ze.idCounter=0;const sn=new f,on=new f,rn=new f,an=new f,Je=new f,Qs=new f;class Js extends ze{constructor(e,t,n){n===void 0&&(n=1e6),super(e,t,0,n),this.restitution=0,this.ri=new f,this.rj=new f,this.ni=new f}computeB(e){const t=this.a,n=this.b,s=this.bi,i=this.bj,o=this.ri,r=this.rj,a=ei,c=ti,l=s.velocity,d=s.angularVelocity;s.force,s.torque;const u=i.velocity,g=i.angularVelocity;i.force,i.torque;const h=ni,y=this.jacobianElementA,m=this.jacobianElementB,b=this.ni;o.cross(b,a),r.cross(b,c),b.negate(y.spatial),a.negate(y.rotational),m.spatial.copy(b),m.rotational.copy(c),h.copy(i.position),h.vadd(r,h),h.vsub(s.position,h),h.vsub(o,h);const v=b.dot(h),A=this.restitution+1,E=A*u.dot(b)-A*l.dot(b)+g.dot(c)-d.dot(a),S=this.computeGiMf();return-v*t-E*n-e*S}getImpactVelocityAlongNormal(){const e=si,t=ii,n=oi,s=ri,i=ai;return this.bi.position.vadd(this.ri,n),this.bj.position.vadd(this.rj,s),this.bi.getVelocityAtWorldPoint(n,e),this.bj.getVelocityAtWorldPoint(s,t),e.vsub(t,i),this.ni.dot(i)}}const ei=new f,ti=new f,ni=new f,si=new f,ii=new f,oi=new f,ri=new f,ai=new f;new f,new f,new f,new f,new f,new f,new f,new f,new f,new f;class cn extends ze{constructor(e,t,n){super(e,t,-n,n),this.ri=new f,this.rj=new f,this.t=new f}computeB(e){this.a;const t=this.b;this.bi,this.bj;const n=this.ri,s=this.rj,i=ci,o=li,r=this.t;n.cross(r,i),s.cross(r,o);const a=this.jacobianElementA,c=this.jacobianElementB;r.negate(a.spatial),i.negate(a.rotational),c.spatial.copy(r),c.rotational.copy(o);const l=this.computeGW(),d=this.computeGiMf();return-l*t-e*d}}const ci=new f,li=new f;class et{constructor(e,t,n){n=Zs.defaults(n,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=et.idCounter++,this.materials=[e,t],this.friction=n.friction,this.restitution=n.restitution,this.contactEquationStiffness=n.contactEquationStiffness,this.contactEquationRelaxation=n.contactEquationRelaxation,this.frictionEquationStiffness=n.frictionEquationStiffness,this.frictionEquationRelaxation=n.frictionEquationRelaxation}}et.idCounter=0;class tt{constructor(e){e===void 0&&(e={});let t="";typeof e=="string"&&(t=e,e={}),this.name=t,this.id=tt.idCounter++,this.friction=typeof e.friction<"u"?e.friction:-1,this.restitution=typeof e.restitution<"u"?e.restitution:-1}}tt.idCounter=0,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new $,new f,new f,new f,new f(1,0,0),new f(0,1,0),new f(0,0,1),new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new f,new se,new f,new se,new f,new f,new f,new f,new f,new f,new f,new se,new f,new q,new se;class ui{constructor(){this.equations=[]}solve(e,t){return 0}addEquation(e){e.enabled&&!e.bi.isTrigger&&!e.bj.isTrigger&&this.equations.push(e)}removeEquation(e){const t=this.equations,n=t.indexOf(e);n!==-1&&t.splice(n,1)}removeAllEquations(){this.equations.length=0}}class hi extends ui{constructor(){super(),this.iterations=10,this.tolerance=1e-7}solve(e,t){let n=0;const s=this.iterations,i=this.tolerance*this.tolerance,o=this.equations,r=o.length,a=t.bodies,c=a.length,l=e;let d,u,g,h,y,m;if(r!==0)for(let E=0;E!==c;E++)a[E].updateSolveMassProperties();const b=fi,v=pi,A=di;b.length=r,v.length=r,A.length=r;for(let E=0;E!==r;E++){const S=o[E];A[E]=0,v[E]=S.computeB(l),b[E]=1/S.computeC()}if(r!==0){for(let M=0;M!==c;M++){const N=a[M],C=N.vlambda,_=N.wlambda;C.set(0,0,0),_.set(0,0,0)}for(n=0;n!==s;n++){h=0;for(let M=0;M!==r;M++){const N=o[M];d=v[M],u=b[M],m=A[M],y=N.computeGWlambda(),g=u*(d-y-N.eps*m),m+g<N.minForce?g=N.minForce-m:m+g>N.maxForce&&(g=N.maxForce-m),A[M]+=g,h+=g>0?g:-g,N.addToWlambda(g)}if(h*h<i)break}for(let M=0;M!==c;M++){const N=a[M],C=N.velocity,_=N.angularVelocity;N.vlambda.vmul(N.linearFactor,N.vlambda),C.vadd(N.vlambda,C),N.wlambda.vmul(N.angularFactor,N.wlambda),_.vadd(N.wlambda,_)}let E=o.length;const S=1/l;for(;E--;)o[E].multiplier=A[E]*S}return n}}const di=[],fi=[],pi=[];z.STATIC;class mi{constructor(){this.objects=[],this.type=Object}release(){const e=arguments.length;for(let t=0;t!==e;t++)this.objects.push(t<0||arguments.length<=t?void 0:arguments[t]);return this}get(){return this.objects.length===0?this.constructObject():this.objects.pop()}constructObject(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}resize(e){const t=this.objects;for(;t.length>e;)t.pop();for(;t.length<e;)t.push(this.constructObject());return this}}class yi extends mi{constructor(){super(...arguments),this.type=f}constructObject(){return new f}}const X={sphereSphere:F.types.SPHERE,spherePlane:F.types.SPHERE|F.types.PLANE,boxBox:F.types.BOX|F.types.BOX,sphereBox:F.types.SPHERE|F.types.BOX,planeBox:F.types.PLANE|F.types.BOX,convexConvex:F.types.CONVEXPOLYHEDRON,sphereConvex:F.types.SPHERE|F.types.CONVEXPOLYHEDRON,planeConvex:F.types.PLANE|F.types.CONVEXPOLYHEDRON,boxConvex:F.types.BOX|F.types.CONVEXPOLYHEDRON,sphereHeightfield:F.types.SPHERE|F.types.HEIGHTFIELD,boxHeightfield:F.types.BOX|F.types.HEIGHTFIELD,convexHeightfield:F.types.CONVEXPOLYHEDRON|F.types.HEIGHTFIELD,sphereParticle:F.types.PARTICLE|F.types.SPHERE,planeParticle:F.types.PLANE|F.types.PARTICLE,boxParticle:F.types.BOX|F.types.PARTICLE,convexParticle:F.types.PARTICLE|F.types.CONVEXPOLYHEDRON,cylinderCylinder:F.types.CYLINDER,sphereCylinder:F.types.SPHERE|F.types.CYLINDER,planeCylinder:F.types.PLANE|F.types.CYLINDER,boxCylinder:F.types.BOX|F.types.CYLINDER,convexCylinder:F.types.CONVEXPOLYHEDRON|F.types.CYLINDER,heightfieldCylinder:F.types.HEIGHTFIELD|F.types.CYLINDER,particleCylinder:F.types.PARTICLE|F.types.CYLINDER,sphereTrimesh:F.types.SPHERE|F.types.TRIMESH,planeTrimesh:F.types.PLANE|F.types.TRIMESH};class gi{get[X.sphereSphere](){return this.sphereSphere}get[X.spherePlane](){return this.spherePlane}get[X.boxBox](){return this.boxBox}get[X.sphereBox](){return this.sphereBox}get[X.planeBox](){return this.planeBox}get[X.convexConvex](){return this.convexConvex}get[X.sphereConvex](){return this.sphereConvex}get[X.planeConvex](){return this.planeConvex}get[X.boxConvex](){return this.boxConvex}get[X.sphereHeightfield](){return this.sphereHeightfield}get[X.boxHeightfield](){return this.boxHeightfield}get[X.convexHeightfield](){return this.convexHeightfield}get[X.sphereParticle](){return this.sphereParticle}get[X.planeParticle](){return this.planeParticle}get[X.boxParticle](){return this.boxParticle}get[X.convexParticle](){return this.convexParticle}get[X.cylinderCylinder](){return this.convexConvex}get[X.sphereCylinder](){return this.sphereConvex}get[X.planeCylinder](){return this.planeConvex}get[X.boxCylinder](){return this.boxConvex}get[X.convexCylinder](){return this.convexConvex}get[X.heightfieldCylinder](){return this.heightfieldCylinder}get[X.particleCylinder](){return this.particleCylinder}get[X.sphereTrimesh](){return this.sphereTrimesh}get[X.planeTrimesh](){return this.planeTrimesh}constructor(e){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new yi,this.world=e,this.currentContactMaterial=e.defaultContactMaterial,this.enableFrictionReduction=!1}createContactEquation(e,t,n,s,i,o){let r;this.contactPointPool.length?(r=this.contactPointPool.pop(),r.bi=e,r.bj=t):r=new Js(e,t),r.enabled=e.collisionResponse&&t.collisionResponse&&n.collisionResponse&&s.collisionResponse;const a=this.currentContactMaterial;r.restitution=a.restitution,r.setSpookParams(a.contactEquationStiffness,a.contactEquationRelaxation,this.world.dt);const c=n.material||e.material,l=s.material||t.material;return c&&l&&c.restitution>=0&&l.restitution>=0&&(r.restitution=c.restitution*l.restitution),r.si=i||n,r.sj=o||s,r}createFrictionEquationsFromContact(e,t){const n=e.bi,s=e.bj,i=e.si,o=e.sj,r=this.world,a=this.currentContactMaterial;let c=a.friction;const l=i.material||n.material,d=o.material||s.material;if(l&&d&&l.friction>=0&&d.friction>=0&&(c=l.friction*d.friction),c>0){const u=c*(r.frictionGravity||r.gravity).length();let g=n.invMass+s.invMass;g>0&&(g=1/g);const h=this.frictionEquationPool,y=h.length?h.pop():new cn(n,s,u*g),m=h.length?h.pop():new cn(n,s,u*g);return y.bi=m.bi=n,y.bj=m.bj=s,y.minForce=m.minForce=-u*g,y.maxForce=m.maxForce=u*g,y.ri.copy(e.ri),y.rj.copy(e.rj),m.ri.copy(e.ri),m.rj.copy(e.rj),e.ni.tangents(y.t,m.t),y.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,r.dt),m.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,r.dt),y.enabled=m.enabled=e.enabled,t.push(y,m),!0}return!1}createFrictionFromAverage(e){let t=this.result[this.result.length-1];if(!this.createFrictionEquationsFromContact(t,this.frictionResult)||e===1)return;const n=this.frictionResult[this.frictionResult.length-2],s=this.frictionResult[this.frictionResult.length-1];Te.setZero(),Ce.setZero(),_e.setZero();const i=t.bi;t.bj;for(let r=0;r!==e;r++)t=this.result[this.result.length-1-r],t.bi!==i?(Te.vadd(t.ni,Te),Ce.vadd(t.ri,Ce),_e.vadd(t.rj,_e)):(Te.vsub(t.ni,Te),Ce.vadd(t.rj,Ce),_e.vadd(t.ri,_e));const o=1/e;Ce.scale(o,n.ri),_e.scale(o,n.rj),s.ri.copy(n.ri),s.rj.copy(n.rj),Te.normalize(),Te.tangents(n.t,s.t)}getContacts(e,t,n,s,i,o,r){this.contactPointPool=i,this.frictionEquationPool=r,this.result=s,this.frictionResult=o;const a=bi,c=xi,l=wi,d=vi;for(let u=0,g=e.length;u!==g;u++){const h=e[u],y=t[u];let m=null;h.material&&y.material&&(m=n.getContactMaterial(h.material,y.material)||null);const b=h.type&z.KINEMATIC&&y.type&z.STATIC||h.type&z.STATIC&&y.type&z.KINEMATIC||h.type&z.KINEMATIC&&y.type&z.KINEMATIC;for(let v=0;v<h.shapes.length;v++){h.quaternion.mult(h.shapeOrientations[v],a),h.quaternion.vmult(h.shapeOffsets[v],l),l.vadd(h.position,l);const A=h.shapes[v];for(let E=0;E<y.shapes.length;E++){y.quaternion.mult(y.shapeOrientations[E],c),y.quaternion.vmult(y.shapeOffsets[E],d),d.vadd(y.position,d);const S=y.shapes[E];if(!(A.collisionFilterMask&S.collisionFilterGroup&&S.collisionFilterMask&A.collisionFilterGroup)||l.distanceTo(d)>A.boundingSphereRadius+S.boundingSphereRadius)continue;let M=null;A.material&&S.material&&(M=n.getContactMaterial(A.material,S.material)||null),this.currentContactMaterial=M||m||n.defaultContactMaterial;const N=A.type|S.type,C=this[N];if(C){let _=!1;A.type<S.type?_=C.call(this,A,S,l,d,a,c,h,y,A,S,b):_=C.call(this,S,A,d,l,c,a,y,h,A,S,b),_&&b&&(n.shapeOverlapKeeper.set(A.id,S.id),n.bodyOverlapKeeper.set(h.id,y.id))}}}}}sphereSphere(e,t,n,s,i,o,r,a,c,l,d){if(d)return n.distanceSquared(s)<(e.radius+t.radius)**2;const u=this.createContactEquation(r,a,e,t,c,l);s.vsub(n,u.ni),u.ni.normalize(),u.ri.copy(u.ni),u.rj.copy(u.ni),u.ri.scale(e.radius,u.ri),u.rj.scale(-t.radius,u.rj),u.ri.vadd(n,u.ri),u.ri.vsub(r.position,u.ri),u.rj.vadd(s,u.rj),u.rj.vsub(a.position,u.rj),this.result.push(u),this.createFrictionEquationsFromContact(u,this.frictionResult)}spherePlane(e,t,n,s,i,o,r,a,c,l,d){const u=this.createContactEquation(r,a,e,t,c,l);if(u.ni.set(0,0,1),o.vmult(u.ni,u.ni),u.ni.negate(u.ni),u.ni.normalize(),u.ni.scale(e.radius,u.ri),n.vsub(s,nt),u.ni.scale(u.ni.dot(nt),ln),nt.vsub(ln,u.rj),-nt.dot(u.ni)<=e.radius){if(d)return!0;const g=u.ri,h=u.rj;g.vadd(n,g),g.vsub(r.position,g),h.vadd(s,h),h.vsub(a.position,h),this.result.push(u),this.createFrictionEquationsFromContact(u,this.frictionResult)}}boxBox(e,t,n,s,i,o,r,a,c,l,d){return e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,n,s,i,o,r,a,e,t,d)}sphereBox(e,t,n,s,i,o,r,a,c,l,d){const u=this.v3pool,g=Xi;n.vsub(s,st),t.getSideNormals(g,o);const h=e.radius;let y=!1;const m=Yi,b=$i,v=Zi;let A=null,E=0,S=0,M=0,N=null;for(let R=0,D=g.length;R!==D&&y===!1;R++){const G=qi;G.copy(g[R]);const H=G.length();G.normalize();const ee=st.dot(G);if(ee<H+h&&ee>0){const Q=Vi,j=Wi;Q.copy(g[(R+1)%3]),j.copy(g[(R+2)%3]);const xe=Q.length(),Le=j.length();Q.normalize(),j.normalize();const qe=st.dot(Q),Ve=st.dot(j);if(qe<xe&&qe>-xe&&Ve<Le&&Ve>-Le){const at=Math.abs(ee-H-h);if((N===null||at<N)&&(N=at,S=qe,M=Ve,A=H,m.copy(G),b.copy(Q),v.copy(j),E++,d))return!0}}}if(E){y=!0;const R=this.createContactEquation(r,a,e,t,c,l);m.scale(-h,R.ri),R.ni.copy(m),R.ni.negate(R.ni),m.scale(A,m),b.scale(S,b),m.vadd(b,m),v.scale(M,v),m.vadd(v,R.rj),R.ri.vadd(n,R.ri),R.ri.vsub(r.position,R.ri),R.rj.vadd(s,R.rj),R.rj.vsub(a.position,R.rj),this.result.push(R),this.createFrictionEquationsFromContact(R,this.frictionResult)}let C=u.get();const _=Ki;for(let R=0;R!==2&&!y;R++)for(let D=0;D!==2&&!y;D++)for(let G=0;G!==2&&!y;G++)if(C.set(0,0,0),R?C.vadd(g[0],C):C.vsub(g[0],C),D?C.vadd(g[1],C):C.vsub(g[1],C),G?C.vadd(g[2],C):C.vsub(g[2],C),s.vadd(C,_),_.vsub(n,_),_.lengthSquared()<h*h){if(d)return!0;y=!0;const H=this.createContactEquation(r,a,e,t,c,l);H.ri.copy(_),H.ri.normalize(),H.ni.copy(H.ri),H.ri.scale(h,H.ri),H.rj.copy(C),H.ri.vadd(n,H.ri),H.ri.vsub(r.position,H.ri),H.rj.vadd(s,H.rj),H.rj.vsub(a.position,H.rj),this.result.push(H),this.createFrictionEquationsFromContact(H,this.frictionResult)}u.release(C),C=null;const I=u.get(),B=u.get(),O=u.get(),T=u.get(),L=u.get(),P=g.length;for(let R=0;R!==P&&!y;R++)for(let D=0;D!==P&&!y;D++)if(R%3!==D%3){g[D].cross(g[R],I),I.normalize(),g[R].vadd(g[D],B),O.copy(n),O.vsub(B,O),O.vsub(s,O);const G=O.dot(I);I.scale(G,T);let H=0;for(;H===R%3||H===D%3;)H++;L.copy(n),L.vsub(T,L),L.vsub(B,L),L.vsub(s,L);const ee=Math.abs(G),Q=L.length();if(ee<g[H].length()&&Q<h){if(d)return!0;y=!0;const j=this.createContactEquation(r,a,e,t,c,l);B.vadd(T,j.rj),j.rj.copy(j.rj),L.negate(j.ni),j.ni.normalize(),j.ri.copy(j.rj),j.ri.vadd(s,j.ri),j.ri.vsub(n,j.ri),j.ri.normalize(),j.ri.scale(h,j.ri),j.ri.vadd(n,j.ri),j.ri.vsub(r.position,j.ri),j.rj.vadd(s,j.rj),j.rj.vsub(a.position,j.rj),this.result.push(j),this.createFrictionEquationsFromContact(j,this.frictionResult)}}u.release(I,B,O,T,L)}planeBox(e,t,n,s,i,o,r,a,c,l,d){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,t.convexPolyhedronRepresentation.id=t.id,this.planeConvex(e,t.convexPolyhedronRepresentation,n,s,i,o,r,a,e,t,d)}convexConvex(e,t,n,s,i,o,r,a,c,l,d,u,g){const h=fo;if(!(n.distanceTo(s)>e.boundingSphereRadius+t.boundingSphereRadius)&&e.findSeparatingAxis(t,n,i,s,o,h,u,g)){const y=[],m=po;e.clipAgainstHull(n,i,t,s,o,h,-100,100,y);let b=0;for(let v=0;v!==y.length;v++){if(d)return!0;const A=this.createContactEquation(r,a,e,t,c,l),E=A.ri,S=A.rj;h.negate(A.ni),y[v].normal.negate(m),m.scale(y[v].depth,m),y[v].point.vadd(m,E),S.copy(y[v].point),E.vsub(n,E),S.vsub(s,S),E.vadd(n,E),E.vsub(r.position,E),S.vadd(s,S),S.vsub(a.position,S),this.result.push(A),b++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(A,this.frictionResult)}this.enableFrictionReduction&&b&&this.createFrictionFromAverage(b)}}sphereConvex(e,t,n,s,i,o,r,a,c,l,d){const u=this.v3pool;n.vsub(s,Qi);const g=t.faceNormals,h=t.faces,y=t.vertices,m=e.radius;let b=!1;for(let v=0;v!==y.length;v++){const A=y[v],E=no;o.vmult(A,E),s.vadd(E,E);const S=to;if(E.vsub(n,S),S.lengthSquared()<m*m){if(d)return!0;b=!0;const M=this.createContactEquation(r,a,e,t,c,l);M.ri.copy(S),M.ri.normalize(),M.ni.copy(M.ri),M.ri.scale(m,M.ri),E.vsub(s,M.rj),M.ri.vadd(n,M.ri),M.ri.vsub(r.position,M.ri),M.rj.vadd(s,M.rj),M.rj.vsub(a.position,M.rj),this.result.push(M),this.createFrictionEquationsFromContact(M,this.frictionResult);return}}for(let v=0,A=h.length;v!==A&&b===!1;v++){const E=g[v],S=h[v],M=so;o.vmult(E,M);const N=io;o.vmult(y[S[0]],N),N.vadd(s,N);const C=oo;M.scale(-m,C),n.vadd(C,C);const _=ro;C.vsub(N,_);const I=_.dot(M),B=ao;if(n.vsub(N,B),I<0&&B.dot(M)>0){const O=[];for(let T=0,L=S.length;T!==L;T++){const P=u.get();o.vmult(y[S[T]],P),s.vadd(P,P),O.push(P)}if(Ui(O,M,n)){if(d)return!0;b=!0;const T=this.createContactEquation(r,a,e,t,c,l);M.scale(-m,T.ri),M.negate(T.ni);const L=u.get();M.scale(-I,L);const P=u.get();M.scale(-m,P),n.vsub(s,T.rj),T.rj.vadd(P,T.rj),T.rj.vadd(L,T.rj),T.rj.vadd(s,T.rj),T.rj.vsub(a.position,T.rj),T.ri.vadd(n,T.ri),T.ri.vsub(r.position,T.ri),u.release(L),u.release(P),this.result.push(T),this.createFrictionEquationsFromContact(T,this.frictionResult);for(let R=0,D=O.length;R!==D;R++)u.release(O[R]);return}else for(let T=0;T!==S.length;T++){const L=u.get(),P=u.get();o.vmult(y[S[(T+1)%S.length]],L),o.vmult(y[S[(T+2)%S.length]],P),s.vadd(L,L),s.vadd(P,P);const R=Ji;P.vsub(L,R);const D=eo;R.unit(D);const G=u.get(),H=u.get();n.vsub(L,H);const ee=H.dot(D);D.scale(ee,G),G.vadd(L,G);const Q=u.get();if(G.vsub(n,Q),ee>0&&ee*ee<R.lengthSquared()&&Q.lengthSquared()<m*m){if(d)return!0;const j=this.createContactEquation(r,a,e,t,c,l);G.vsub(s,j.rj),G.vsub(n,j.ni),j.ni.normalize(),j.ni.scale(m,j.ri),j.rj.vadd(s,j.rj),j.rj.vsub(a.position,j.rj),j.ri.vadd(n,j.ri),j.ri.vsub(r.position,j.ri),this.result.push(j),this.createFrictionEquationsFromContact(j,this.frictionResult);for(let xe=0,Le=O.length;xe!==Le;xe++)u.release(O[xe]);u.release(L),u.release(P),u.release(G),u.release(Q),u.release(H);return}u.release(L),u.release(P),u.release(G),u.release(Q),u.release(H)}for(let T=0,L=O.length;T!==L;T++)u.release(O[T])}}}planeConvex(e,t,n,s,i,o,r,a,c,l,d){const u=co,g=lo;g.set(0,0,1),i.vmult(g,g);let h=0;const y=uo;for(let m=0;m!==t.vertices.length;m++)if(u.copy(t.vertices[m]),o.vmult(u,u),s.vadd(u,u),u.vsub(n,y),g.dot(y)<=0){if(d)return!0;const v=this.createContactEquation(r,a,e,t,c,l),A=ho;g.scale(g.dot(y),A),u.vsub(A,A),A.vsub(n,v.ri),v.ni.copy(g),u.vsub(s,v.rj),v.ri.vadd(n,v.ri),v.ri.vsub(r.position,v.ri),v.rj.vadd(s,v.rj),v.rj.vsub(a.position,v.rj),this.result.push(v),h++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(v,this.frictionResult)}this.enableFrictionReduction&&h&&this.createFrictionFromAverage(h)}boxConvex(e,t,n,s,i,o,r,a,c,l,d){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t,n,s,i,o,r,a,e,t,d)}sphereHeightfield(e,t,n,s,i,o,r,a,c,l,d){const u=t.data,g=e.radius,h=t.elementSize,y=Mo,m=So;q.pointToLocalFrame(s,o,n,m);let b=Math.floor((m.x-g)/h)-1,v=Math.ceil((m.x+g)/h)+1,A=Math.floor((m.y-g)/h)-1,E=Math.ceil((m.y+g)/h)+1;if(v<0||E<0||b>u.length||A>u[0].length)return;b<0&&(b=0),v<0&&(v=0),A<0&&(A=0),E<0&&(E=0),b>=u.length&&(b=u.length-1),v>=u.length&&(v=u.length-1),E>=u[0].length&&(E=u[0].length-1),A>=u[0].length&&(A=u[0].length-1);const S=[];t.getRectMinMax(b,A,v,E,S);const M=S[0],N=S[1];if(m.z-g>N||m.z+g<M)return;const C=this.result;for(let _=b;_<v;_++)for(let I=A;I<E;I++){const B=C.length;let O=!1;if(t.getConvexTrianglePillar(_,I,!1),q.pointToWorldFrame(s,o,t.pillarOffset,y),n.distanceTo(y)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(O=this.sphereConvex(e,t.pillarConvex,n,y,i,o,r,a,e,t,d)),d&&O||(t.getConvexTrianglePillar(_,I,!0),q.pointToWorldFrame(s,o,t.pillarOffset,y),n.distanceTo(y)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(O=this.sphereConvex(e,t.pillarConvex,n,y,i,o,r,a,e,t,d)),d&&O))return!0;if(C.length-B>2)return}}boxHeightfield(e,t,n,s,i,o,r,a,c,l,d){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,t,n,s,i,o,r,a,e,t,d)}convexHeightfield(e,t,n,s,i,o,r,a,c,l,d){const u=t.data,g=t.elementSize,h=e.boundingSphereRadius,y=Eo,m=To,b=Ao;q.pointToLocalFrame(s,o,n,b);let v=Math.floor((b.x-h)/g)-1,A=Math.ceil((b.x+h)/g)+1,E=Math.floor((b.y-h)/g)-1,S=Math.ceil((b.y+h)/g)+1;if(A<0||S<0||v>u.length||E>u[0].length)return;v<0&&(v=0),A<0&&(A=0),E<0&&(E=0),S<0&&(S=0),v>=u.length&&(v=u.length-1),A>=u.length&&(A=u.length-1),S>=u[0].length&&(S=u[0].length-1),E>=u[0].length&&(E=u[0].length-1);const M=[];t.getRectMinMax(v,E,A,S,M);const N=M[0],C=M[1];if(!(b.z-h>C||b.z+h<N))for(let _=v;_<A;_++)for(let I=E;I<S;I++){let B=!1;if(t.getConvexTrianglePillar(_,I,!1),q.pointToWorldFrame(s,o,t.pillarOffset,y),n.distanceTo(y)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(B=this.convexConvex(e,t.pillarConvex,n,y,i,o,r,a,null,null,d,m,null)),d&&B||(t.getConvexTrianglePillar(_,I,!0),q.pointToWorldFrame(s,o,t.pillarOffset,y),n.distanceTo(y)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(B=this.convexConvex(e,t.pillarConvex,n,y,i,o,r,a,null,null,d,m,null)),d&&B))return!0}}sphereParticle(e,t,n,s,i,o,r,a,c,l,d){const u=wo;if(u.set(0,0,1),s.vsub(n,u),u.lengthSquared()<=e.radius*e.radius){if(d)return!0;const h=this.createContactEquation(a,r,t,e,c,l);u.normalize(),h.rj.copy(u),h.rj.scale(e.radius,h.rj),h.ni.copy(u),h.ni.negate(h.ni),h.ri.set(0,0,0),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}}planeParticle(e,t,n,s,i,o,r,a,c,l,d){const u=mo;u.set(0,0,1),r.quaternion.vmult(u,u);const g=yo;if(s.vsub(r.position,g),u.dot(g)<=0){if(d)return!0;const y=this.createContactEquation(a,r,t,e,c,l);y.ni.copy(u),y.ni.negate(y.ni),y.ri.set(0,0,0);const m=go;u.scale(u.dot(s),m),s.vsub(m,m),y.rj.copy(m),this.result.push(y),this.createFrictionEquationsFromContact(y,this.frictionResult)}}boxParticle(e,t,n,s,i,o,r,a,c,l,d){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,t,n,s,i,o,r,a,e,t,d)}convexParticle(e,t,n,s,i,o,r,a,c,l,d){let u=-1;const g=bo,h=xo;let y=null;const m=vo;if(m.copy(s),m.vsub(n,m),i.conjugate(un),un.vmult(m,m),e.pointIsInside(m)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(n,i),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(i);for(let b=0,v=e.faces.length;b!==v;b++){const A=[e.worldVertices[e.faces[b][0]]],E=e.worldFaceNormals[b];s.vsub(A[0],hn);const S=-E.dot(hn);if(y===null||Math.abs(S)<Math.abs(y)){if(d)return!0;y=S,u=b,g.copy(E)}}if(u!==-1){const b=this.createContactEquation(a,r,t,e,c,l);g.scale(y,h),h.vadd(s,h),h.vsub(n,h),b.rj.copy(h),g.negate(b.ni),b.ri.set(0,0,0);const v=b.ri,A=b.rj;v.vadd(s,v),v.vsub(a.position,v),A.vadd(n,A),A.vsub(r.position,A),this.result.push(b),this.createFrictionEquationsFromContact(b,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}}heightfieldCylinder(e,t,n,s,i,o,r,a,c,l,d){return this.convexHeightfield(t,e,s,n,o,i,a,r,c,l,d)}particleCylinder(e,t,n,s,i,o,r,a,c,l,d){return this.convexParticle(t,e,s,n,o,i,a,r,c,l,d)}sphereTrimesh(e,t,n,s,i,o,r,a,c,l,d){const u=_i,g=Pi,h=Ni,y=Ii,m=Li,b=Oi,v=ki,A=Ci,E=Mi,S=ji;q.pointToLocalFrame(s,o,n,m);const M=e.radius;v.lowerBound.set(m.x-M,m.y-M,m.z-M),v.upperBound.set(m.x+M,m.y+M,m.z+M),t.getTrianglesInAABB(v,S);const N=Ri,C=e.radius*e.radius;for(let T=0;T<S.length;T++)for(let L=0;L<3;L++)if(t.getVertex(t.indices[S[T]*3+L],N),N.vsub(m,E),E.lengthSquared()<=C){if(A.copy(N),q.pointToWorldFrame(s,o,A,N),N.vsub(n,E),d)return!0;let P=this.createContactEquation(r,a,e,t,c,l);P.ni.copy(E),P.ni.normalize(),P.ri.copy(P.ni),P.ri.scale(e.radius,P.ri),P.ri.vadd(n,P.ri),P.ri.vsub(r.position,P.ri),P.rj.copy(N),P.rj.vsub(a.position,P.rj),this.result.push(P),this.createFrictionEquationsFromContact(P,this.frictionResult)}for(let T=0;T<S.length;T++)for(let L=0;L<3;L++){t.getVertex(t.indices[S[T]*3+L],u),t.getVertex(t.indices[S[T]*3+(L+1)%3],g),g.vsub(u,h),m.vsub(g,b);const P=b.dot(h);m.vsub(u,b);let R=b.dot(h);if(R>0&&P<0&&(m.vsub(u,b),y.copy(h),y.normalize(),R=b.dot(y),y.scale(R,b),b.vadd(u,b),b.distanceTo(m)<e.radius)){if(d)return!0;const G=this.createContactEquation(r,a,e,t,c,l);b.vsub(m,G.ni),G.ni.normalize(),G.ni.scale(e.radius,G.ri),G.ri.vadd(n,G.ri),G.ri.vsub(r.position,G.ri),q.pointToWorldFrame(s,o,b,b),b.vsub(a.position,G.rj),q.vectorToWorldFrame(o,G.ni,G.ni),q.vectorToWorldFrame(o,G.ri,G.ri),this.result.push(G),this.createFrictionEquationsFromContact(G,this.frictionResult)}}const _=Fi,I=Bi,B=zi,O=Si;for(let T=0,L=S.length;T!==L;T++){t.getTriangleVertices(S[T],_,I,B),t.getNormal(S[T],O),m.vsub(_,b);let P=b.dot(O);if(O.scale(P,b),m.vsub(b,b),P=b.distanceTo(m),$.pointInTriangle(b,_,I,B)&&P<e.radius){if(d)return!0;let R=this.createContactEquation(r,a,e,t,c,l);b.vsub(m,R.ni),R.ni.normalize(),R.ni.scale(e.radius,R.ri),R.ri.vadd(n,R.ri),R.ri.vsub(r.position,R.ri),q.pointToWorldFrame(s,o,b,b),b.vsub(a.position,R.rj),q.vectorToWorldFrame(o,R.ni,R.ni),q.vectorToWorldFrame(o,R.ri,R.ri),this.result.push(R),this.createFrictionEquationsFromContact(R,this.frictionResult)}}S.length=0}planeTrimesh(e,t,n,s,i,o,r,a,c,l,d){const u=new f,g=Ai;g.set(0,0,1),i.vmult(g,g);for(let h=0;h<t.vertices.length/3;h++){t.getVertex(h,u);const y=new f;y.copy(u),q.pointToWorldFrame(s,o,y,u);const m=Ei;if(u.vsub(n,m),g.dot(m)<=0){if(d)return!0;const v=this.createContactEquation(r,a,e,t,c,l);v.ni.copy(g);const A=Ti;g.scale(m.dot(g),A),u.vsub(A,A),v.ri.copy(A),v.ri.vsub(r.position,v.ri),v.rj.copy(u),v.rj.vsub(a.position,v.rj),this.result.push(v),this.createFrictionEquationsFromContact(v,this.frictionResult)}}}}const Te=new f,Ce=new f,_e=new f,wi=new f,vi=new f,bi=new Y,xi=new Y,Ai=new f,Ei=new f,Ti=new f,Si=new f,Mi=new f;new f;const Ri=new f,Ci=new f,_i=new f,Pi=new f,Ni=new f,Ii=new f,Li=new f,Oi=new f,Fi=new f,Bi=new f,zi=new f,ki=new se,ji=[],nt=new f,ln=new f,Di=new f,Gi=new f,Hi=new f;function Ui(p,e,t){let n=null;const s=p.length;for(let i=0;i!==s;i++){const o=p[i],r=Di;p[(i+1)%s].vsub(o,r);const a=Gi;r.cross(e,a);const c=Hi;t.vsub(o,c);const l=a.dot(c);if(n===null||l>0&&n===!0||l<=0&&n===!1){n===null&&(n=l>0);continue}else return!1}return!0}const st=new f,qi=new f,Vi=new f,Wi=new f,Xi=[new f,new f,new f,new f,new f,new f],Ki=new f,Yi=new f,$i=new f,Zi=new f,Qi=new f,Ji=new f,eo=new f,to=new f,no=new f,so=new f,io=new f,oo=new f,ro=new f,ao=new f;new f,new f;const co=new f,lo=new f,uo=new f,ho=new f,fo=new f,po=new f,mo=new f,yo=new f,go=new f,wo=new f,un=new Y,vo=new f;new f;const bo=new f,hn=new f,xo=new f,Ao=new f,Eo=new f,To=[0],So=new f,Mo=new f;class dn{constructor(){this.current=[],this.previous=[]}getKey(e,t){if(t<e){const n=t;t=e,e=n}return e<<16|t}set(e,t){const n=this.getKey(e,t),s=this.current;let i=0;for(;n>s[i];)i++;if(n!==s[i]){for(let o=s.length-1;o>=i;o--)s[o+1]=s[o];s[i]=n}}tick(){const e=this.current;this.current=this.previous,this.previous=e,this.current.length=0}getDiff(e,t){const n=this.current,s=this.previous,i=n.length,o=s.length;let r=0;for(let a=0;a<i;a++){let c=!1;const l=n[a];for(;l>s[r];)r++;c=l===s[r],c||fn(e,l)}r=0;for(let a=0;a<o;a++){let c=!1;const l=s[a];for(;l>n[r];)r++;c=n[r]===l,c||fn(t,l)}}}function fn(p,e){p.push((e&4294901760)>>16,e&65535)}const wt=(p,e)=>p<e?`${p}-${e}`:`${e}-${p}`;class Ro{constructor(){this.data={keys:[]}}get(e,t){const n=wt(e,t);return this.data[n]}set(e,t,n){const s=wt(e,t);this.get(e,t)||this.data.keys.push(s),this.data[s]=n}delete(e,t){const n=wt(e,t),s=this.data.keys.indexOf(n);s!==-1&&this.data.keys.splice(s,1),delete this.data[n]}reset(){const e=this.data,t=e.keys;for(;t.length>0;){const n=t.pop();delete e[n]}}}let Co=class extends Ut{constructor(e){e===void 0&&(e={}),super(),this.dt=-1,this.allowSleep=!!e.allowSleep,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=e.quatNormalizeSkip!==void 0?e.quatNormalizeSkip:0,this.quatNormalizeFast=e.quatNormalizeFast!==void 0?e.quatNormalizeFast:!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new f,e.gravity&&this.gravity.copy(e.gravity),e.frictionGravity&&(this.frictionGravity=new f,this.frictionGravity.copy(e.frictionGravity)),this.broadphase=e.broadphase!==void 0?e.broadphase:new Vt,this.bodies=[],this.hasActiveBodies=!1,this.solver=e.solver!==void 0?e.solver:new hi,this.constraints=[],this.narrowphase=new gi(this),this.collisionMatrix=new Ht,this.collisionMatrixPrevious=new Ht,this.bodyOverlapKeeper=new dn,this.shapeOverlapKeeper=new dn,this.contactmaterials=[],this.contactMaterialTable=new Ro,this.defaultMaterial=new tt("default"),this.defaultContactMaterial=new et(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.accumulator=0,this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.idToBodyMap={},this.broadphase.setWorld(this)}getContactMaterial(e,t){return this.contactMaterialTable.get(e.id,t.id)}collisionMatrixTick(){const e=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=e,this.collisionMatrix.reset(),this.bodyOverlapKeeper.tick(),this.shapeOverlapKeeper.tick()}addConstraint(e){this.constraints.push(e)}removeConstraint(e){const t=this.constraints.indexOf(e);t!==-1&&this.constraints.splice(t,1)}rayTest(e,t,n){n instanceof $e?this.raycastClosest(e,t,{skipBackfaces:!0},n):this.raycastAll(e,t,{skipBackfaces:!0},n)}raycastAll(e,t,n,s){return n===void 0&&(n={}),n.mode=$.ALL,n.from=e,n.to=t,n.callback=s,vt.intersectWorld(this,n)}raycastAny(e,t,n,s){return n===void 0&&(n={}),n.mode=$.ANY,n.from=e,n.to=t,n.result=s,vt.intersectWorld(this,n)}raycastClosest(e,t,n,s){return n===void 0&&(n={}),n.mode=$.CLOSEST,n.from=e,n.to=t,n.result=s,vt.intersectWorld(this,n)}addBody(e){this.bodies.includes(e)||(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof z&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,this.idToBodyMap[e.id]=e,this.dispatchEvent(this.addBodyEvent))}removeBody(e){e.world=null;const t=this.bodies.length-1,n=this.bodies,s=n.indexOf(e);if(s!==-1){n.splice(s,1);for(let i=0;i!==n.length;i++)n[i].index=i;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=e,delete this.idToBodyMap[e.id],this.dispatchEvent(this.removeBodyEvent)}}getBodyById(e){return this.idToBodyMap[e]}getShapeById(e){const t=this.bodies;for(let n=0;n<t.length;n++){const s=t[n].shapes;for(let i=0;i<s.length;i++){const o=s[i];if(o.id===e)return o}}return null}addContactMaterial(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)}removeContactMaterial(e){const t=this.contactmaterials.indexOf(e);t!==-1&&(this.contactmaterials.splice(t,1),this.contactMaterialTable.delete(e.materials[0].id,e.materials[1].id))}fixedStep(e,t){e===void 0&&(e=1/60),t===void 0&&(t=10);const n=Z.now()/1e3;if(!this.lastCallTime)this.step(e,void 0,t);else{const s=n-this.lastCallTime;this.step(e,s,t)}this.lastCallTime=n}step(e,t,n){if(n===void 0&&(n=10),t===void 0)this.internalStep(e),this.time+=e;else{this.accumulator+=t;const s=Z.now();let i=0;for(;this.accumulator>=e&&i<n&&(this.internalStep(e),this.accumulator-=e,i++,!(Z.now()-s>e*1e3)););this.accumulator=this.accumulator%e;const o=this.accumulator/e;for(let r=0;r!==this.bodies.length;r++){const a=this.bodies[r];a.previousPosition.lerp(a.position,o,a.interpolatedPosition),a.previousQuaternion.slerp(a.quaternion,o,a.interpolatedQuaternion),a.previousQuaternion.normalize()}this.time+=t}}internalStep(e){this.dt=e;const t=this.contacts,n=Lo,s=Oo,i=this.bodies.length,o=this.bodies,r=this.solver,a=this.gravity,c=this.doProfiling,l=this.profile,d=z.DYNAMIC;let u=-1/0;const g=this.constraints,h=Io;a.length();const y=a.x,m=a.y,b=a.z;let v=0;for(c&&(u=Z.now()),v=0;v!==i;v++){const T=o[v];if(T.type===d){const L=T.force,P=T.mass;L.x+=P*y,L.y+=P*m,L.z+=P*b}}for(let T=0,L=this.subsystems.length;T!==L;T++)this.subsystems[T].update();c&&(u=Z.now()),n.length=0,s.length=0,this.broadphase.collisionPairs(this,n,s),c&&(l.broadphase=Z.now()-u);let A=g.length;for(v=0;v!==A;v++){const T=g[v];if(!T.collideConnected)for(let L=n.length-1;L>=0;L-=1)(T.bodyA===n[L]&&T.bodyB===s[L]||T.bodyB===n[L]&&T.bodyA===s[L])&&(n.splice(L,1),s.splice(L,1))}this.collisionMatrixTick(),c&&(u=Z.now());const E=No,S=t.length;for(v=0;v!==S;v++)E.push(t[v]);t.length=0;const M=this.frictionEquations.length;for(v=0;v!==M;v++)h.push(this.frictionEquations[v]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(n,s,this,t,E,this.frictionEquations,h),c&&(l.narrowphase=Z.now()-u),c&&(u=Z.now()),v=0;v<this.frictionEquations.length;v++)r.addEquation(this.frictionEquations[v]);const N=t.length;for(let T=0;T!==N;T++){const L=t[T],P=L.bi,R=L.bj,D=L.si,G=L.sj;let H;if(P.material&&R.material?H=this.getContactMaterial(P.material,R.material)||this.defaultContactMaterial:H=this.defaultContactMaterial,H.friction,P.material&&R.material&&(P.material.friction>=0&&R.material.friction>=0&&P.material.friction*R.material.friction,P.material.restitution>=0&&R.material.restitution>=0&&(L.restitution=P.material.restitution*R.material.restitution)),r.addEquation(L),P.allowSleep&&P.type===z.DYNAMIC&&P.sleepState===z.SLEEPING&&R.sleepState===z.AWAKE&&R.type!==z.STATIC){const ee=R.velocity.lengthSquared()+R.angularVelocity.lengthSquared(),Q=R.sleepSpeedLimit**2;ee>=Q*2&&(P.wakeUpAfterNarrowphase=!0)}if(R.allowSleep&&R.type===z.DYNAMIC&&R.sleepState===z.SLEEPING&&P.sleepState===z.AWAKE&&P.type!==z.STATIC){const ee=P.velocity.lengthSquared()+P.angularVelocity.lengthSquared(),Q=P.sleepSpeedLimit**2;ee>=Q*2&&(R.wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(P,R,!0),this.collisionMatrixPrevious.get(P,R)||(ke.body=R,ke.contact=L,P.dispatchEvent(ke),ke.body=P,R.dispatchEvent(ke)),this.bodyOverlapKeeper.set(P.id,R.id),this.shapeOverlapKeeper.set(D.id,G.id)}for(this.emitContactEvents(),c&&(l.makeContactConstraints=Z.now()-u,u=Z.now()),v=0;v!==i;v++){const T=o[v];T.wakeUpAfterNarrowphase&&(T.wakeUp(),T.wakeUpAfterNarrowphase=!1)}for(A=g.length,v=0;v!==A;v++){const T=g[v];T.update();for(let L=0,P=T.equations.length;L!==P;L++){const R=T.equations[L];r.addEquation(R)}}r.solve(e,this),c&&(l.solve=Z.now()-u),r.removeAllEquations();const C=Math.pow;for(v=0;v!==i;v++){const T=o[v];if(T.type&d){const L=C(1-T.linearDamping,e),P=T.velocity;P.scale(L,P);const R=T.angularVelocity;if(R){const D=C(1-T.angularDamping,e);R.scale(D,R)}}}this.dispatchEvent(Po),c&&(u=Z.now());const I=this.stepnumber%(this.quatNormalizeSkip+1)===0,B=this.quatNormalizeFast;for(v=0;v!==i;v++)o[v].integrate(e,I,B);this.clearForces(),this.broadphase.dirty=!0,c&&(l.integrate=Z.now()-u),this.stepnumber+=1,this.dispatchEvent(_o);let O=!0;if(this.allowSleep)for(O=!1,v=0;v!==i;v++){const T=o[v];T.sleepTick(this.time),T.sleepState!==z.SLEEPING&&(O=!0)}this.hasActiveBodies=O}emitContactEvents(){const e=this.hasAnyEventListener("beginContact"),t=this.hasAnyEventListener("endContact");if((e||t)&&this.bodyOverlapKeeper.getDiff(he,de),e){for(let i=0,o=he.length;i<o;i+=2)je.bodyA=this.getBodyById(he[i]),je.bodyB=this.getBodyById(he[i+1]),this.dispatchEvent(je);je.bodyA=je.bodyB=null}if(t){for(let i=0,o=de.length;i<o;i+=2)De.bodyA=this.getBodyById(de[i]),De.bodyB=this.getBodyById(de[i+1]),this.dispatchEvent(De);De.bodyA=De.bodyB=null}he.length=de.length=0;const n=this.hasAnyEventListener("beginShapeContact"),s=this.hasAnyEventListener("endShapeContact");if((n||s)&&this.shapeOverlapKeeper.getDiff(he,de),n){for(let i=0,o=he.length;i<o;i+=2){const r=this.getShapeById(he[i]),a=this.getShapeById(he[i+1]);fe.shapeA=r,fe.shapeB=a,r&&(fe.bodyA=r.body),a&&(fe.bodyB=a.body),this.dispatchEvent(fe)}fe.bodyA=fe.bodyB=fe.shapeA=fe.shapeB=null}if(s){for(let i=0,o=de.length;i<o;i+=2){const r=this.getShapeById(de[i]),a=this.getShapeById(de[i+1]);pe.shapeA=r,pe.shapeB=a,r&&(pe.bodyA=r.body),a&&(pe.bodyB=a.body),this.dispatchEvent(pe)}pe.bodyA=pe.bodyB=pe.shapeA=pe.shapeB=null}}clearForces(){const e=this.bodies,t=e.length;for(let n=0;n!==t;n++){const s=e[n];s.force,s.torque,s.force.set(0,0,0),s.torque.set(0,0,0)}}};new se;const vt=new $,Z=globalThis.performance||{};if(!Z.now){let p=Date.now();Z.timing&&Z.timing.navigationStart&&(p=Z.timing.navigationStart),Z.now=()=>Date.now()-p}new f;const _o={type:"postStep"},Po={type:"preStep"},ke={type:z.COLLIDE_EVENT_NAME,body:null,contact:null},No=[],Io=[],Lo=[],Oo=[],he=[],de=[],je={type:"beginContact",bodyA:null,bodyB:null},De={type:"endContact",bodyA:null,bodyB:null},fe={type:"beginShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},pe={type:"endShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null};function Fo(p,e,t){let{color:n=65280,scale:s=1,onInit:i,onUpdate:o}=t===void 0?{}:t;const r=[],a=new w.MeshBasicMaterial({color:n??65280,wireframe:!0}),c=new f,l=new f,d=new f,u=new Y,g=new w.SphereGeometry(1),h=new w.BoxGeometry(1,1,1),y=new w.PlaneGeometry(10,10,10,10);y.translate(0,0,1e-4);function m(C){const _=new w.BufferGeometry,I=[];for(let O=0;O<C.vertices.length;O++){const T=C.vertices[O];I.push(T.x,T.y,T.z)}_.setAttribute("position",new w.Float32BufferAttribute(I,3));const B=[];for(let O=0;O<C.faces.length;O++){const T=C.faces[O],L=T[0];for(let P=1;P<T.length-1;P++){const R=T[P],D=T[P+1];B.push(L,R,D)}}return _.setIndex(B),_.computeBoundingSphere(),_.computeVertexNormals(),_}function b(C){const _=new w.BufferGeometry,I=[],B=c,O=l,T=d;for(let L=0;L<C.indices.length/3;L++)C.getTriangleVertices(L,B,O,T),I.push(B.x,B.y,B.z),I.push(O.x,O.y,O.z),I.push(T.x,T.y,T.z);return _.setAttribute("position",new w.Float32BufferAttribute(I,3)),_.computeBoundingSphere(),_.computeVertexNormals(),_}function v(C){const _=new w.BufferGeometry,I=C.elementSize||1,B=C.data.flatMap((T,L)=>T.flatMap((P,R)=>[L*I,R*I,P])),O=[];for(let T=0;T<C.data.length-1;T++)for(let L=0;L<C.data[T].length-1;L++){const P=C.data[T].length,R=T*P+L;O.push(R+1,R+P,R+P+1),O.push(R+P,R+1,R)}return _.setIndex(O),_.setAttribute("position",new w.Float32BufferAttribute(B,3)),_.computeBoundingSphere(),_.computeVertexNormals(),_}function A(C){let _=new w.Mesh;const{SPHERE:I,BOX:B,PLANE:O,CYLINDER:T,CONVEXPOLYHEDRON:L,TRIMESH:P,HEIGHTFIELD:R}=F.types;switch(C.type){case I:{_=new w.Mesh(g,a);break}case B:{_=new w.Mesh(h,a);break}case O:{_=new w.Mesh(y,a);break}case T:{const D=new w.CylinderGeometry(C.radiusTop,C.radiusBottom,C.height,C.numSegments);_=new w.Mesh(D,a),C.geometryId=D.id;break}case L:{const D=m(C);_=new w.Mesh(D,a),C.geometryId=D.id;break}case P:{const D=b(C);_=new w.Mesh(D,a),C.geometryId=D.id;break}case R:{const D=v(C);_=new w.Mesh(D,a),C.geometryId=D.id;break}}return p.add(_),_}function E(C,_){const{SPHERE:I,BOX:B,PLANE:O,CYLINDER:T,CONVEXPOLYHEDRON:L,TRIMESH:P,HEIGHTFIELD:R}=F.types;switch(_.type){case I:{const{radius:D}=_;C.scale.set(D*s,D*s,D*s);break}case B:{C.scale.copy(_.halfExtents),C.scale.multiplyScalar(2*s);break}case O:break;case T:{C.scale.set(1*s,1*s,1*s);break}case L:{C.scale.set(1*s,1*s,1*s);break}case P:{C.scale.copy(_.scale).multiplyScalar(s);break}case R:{C.scale.set(1*s,1*s,1*s);break}}}function S(C,_){if(!C)return!1;const{geometry:I}=C;return I instanceof w.SphereGeometry&&_.type===F.types.SPHERE||I instanceof w.BoxGeometry&&_.type===F.types.BOX||I instanceof w.PlaneGeometry&&_.type===F.types.PLANE||I.id===_.geometryId&&_.type===F.types.CYLINDER||I.id===_.geometryId&&_.type===F.types.CONVEXPOLYHEDRON||I.id===_.geometryId&&_.type===F.types.TRIMESH||I.id===_.geometryId&&_.type===F.types.HEIGHTFIELD}function M(C,_){let I=r[C],B=!1;return S(I,_)||(I&&p.remove(I),r[C]=I=A(_),B=!0),E(I,_),B}function N(){const C=r,_=c,I=u;let B=0;for(const O of e.bodies)for(let T=0;T!==O.shapes.length;T++){const L=O.shapes[T],P=M(B,L),R=C[B];R&&(O.quaternion.vmult(O.shapeOffsets[T],_),O.position.vadd(_,_),O.quaternion.mult(O.shapeOrientations[T],I),R.position.copy(_),R.quaternion.copy(I),P&&i instanceof Function&&i(O,R,L),!P&&o instanceof Function&&o(O,R,L)),B++}for(let O=B;O<C.length;O++){const T=C[O];T&&p.remove(T)}C.length=B}return{update:N}}function pn(p,e){if(e===w.TrianglesDrawMode)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),p;if(e===w.TriangleFanDrawMode||e===w.TriangleStripDrawMode){let t=p.getIndex();if(t===null){const o=[],r=p.getAttribute("position");if(r!==void 0){for(let a=0;a<r.count;a++)o.push(a);p.setIndex(o),t=p.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),p}const n=t.count-2,s=[];if(e===w.TriangleFanDrawMode)for(let o=1;o<=n;o++)s.push(t.getX(0)),s.push(t.getX(o)),s.push(t.getX(o+1));else for(let o=0;o<n;o++)o%2===0?(s.push(t.getX(o)),s.push(t.getX(o+1)),s.push(t.getX(o+2))):(s.push(t.getX(o+2)),s.push(t.getX(o+1)),s.push(t.getX(o)));s.length/3!==n&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const i=p.clone();return i.setIndex(s),i.clearGroups(),i}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),p}class bt extends w.Loader{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new Do(t)}),this.register(function(t){return new Yo(t)}),this.register(function(t){return new $o(t)}),this.register(function(t){return new Zo(t)}),this.register(function(t){return new Ho(t)}),this.register(function(t){return new Uo(t)}),this.register(function(t){return new qo(t)}),this.register(function(t){return new Vo(t)}),this.register(function(t){return new jo(t)}),this.register(function(t){return new Wo(t)}),this.register(function(t){return new Go(t)}),this.register(function(t){return new Ko(t)}),this.register(function(t){return new Xo(t)}),this.register(function(t){return new zo(t)}),this.register(function(t){return new Qo(t)}),this.register(function(t){return new Jo(t)})}load(e,t,n,s){const i=this;let o;if(this.resourcePath!=="")o=this.resourcePath;else if(this.path!==""){const c=w.LoaderUtils.extractUrlBase(e);o=w.LoaderUtils.resolveURL(c,this.path)}else o=w.LoaderUtils.extractUrlBase(e);this.manager.itemStart(e);const r=function(c){s?s(c):console.error(c),i.manager.itemError(e),i.manager.itemEnd(e)},a=new w.FileLoader(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,function(c){try{i.parse(c,o,function(l){t(l),i.manager.itemEnd(e)},r)}catch(l){r(l)}},n,r)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,s){let i;const o={},r={},a=new TextDecoder;if(typeof e=="string")i=JSON.parse(e);else if(e instanceof ArrayBuffer)if(a.decode(new Uint8Array(e,0,4))===mn){try{o[U.KHR_BINARY_GLTF]=new er(e)}catch(d){s&&s(d);return}i=JSON.parse(o[U.KHR_BINARY_GLTF].content)}else i=JSON.parse(a.decode(e));else i=e;if(i.asset===void 0||i.asset.version[0]<2){s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const c=new fr(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let l=0;l<this.pluginCallbacks.length;l++){const d=this.pluginCallbacks[l](c);d.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),r[d.name]=d,o[d.name]=!0}if(i.extensionsUsed)for(let l=0;l<i.extensionsUsed.length;++l){const d=i.extensionsUsed[l],u=i.extensionsRequired||[];switch(d){case U.KHR_MATERIALS_UNLIT:o[d]=new ko;break;case U.KHR_DRACO_MESH_COMPRESSION:o[d]=new tr(i,this.dracoLoader);break;case U.KHR_TEXTURE_TRANSFORM:o[d]=new nr;break;case U.KHR_MESH_QUANTIZATION:o[d]=new sr;break;default:u.indexOf(d)>=0&&r[d]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+d+'".')}}c.setExtensions(o),c.setPlugins(r),c.parse(n,s)}parseAsync(e,t){const n=this;return new Promise(function(s,i){n.parse(e,t,s,i)})}}function Bo(){let p={};return{get:function(e){return p[e]},add:function(e,t){p[e]=t},remove:function(e){delete p[e]},removeAll:function(){p={}}}}const U={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class zo{constructor(e){this.parser=e,this.name=U.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let n=0,s=t.length;n<s;n++){const i=t[n];i.extensions&&i.extensions[this.name]&&i.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){const t=this.parser,n="light:"+e;let s=t.cache.get(n);if(s)return s;const i=t.json,a=((i.extensions&&i.extensions[this.name]||{}).lights||[])[e];let c;const l=new w.Color(16777215);a.color!==void 0&&l.setRGB(a.color[0],a.color[1],a.color[2],w.LinearSRGBColorSpace);const d=a.range!==void 0?a.range:0;switch(a.type){case"directional":c=new w.DirectionalLight(l),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new w.PointLight(l),c.distance=d;break;case"spot":c=new w.SpotLight(l),c.distance=d,a.spot=a.spot||{},a.spot.innerConeAngle=a.spot.innerConeAngle!==void 0?a.spot.innerConeAngle:0,a.spot.outerConeAngle=a.spot.outerConeAngle!==void 0?a.spot.outerConeAngle:Math.PI/4,c.angle=a.spot.outerConeAngle,c.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return c.position.set(0,0,0),c.decay=2,be(c,a),a.intensity!==void 0&&(c.intensity=a.intensity),c.name=t.createUniqueName(a.name||"light_"+e),s=Promise.resolve(c),t.cache.add(n,s),s}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,n=this.parser,i=n.json.nodes[e],r=(i.extensions&&i.extensions[this.name]||{}).light;return r===void 0?null:this._loadLight(r).then(function(a){return n._getNodeRef(t.cache,r,a)})}}class ko{constructor(){this.name=U.KHR_MATERIALS_UNLIT}getMaterialType(){return w.MeshBasicMaterial}extendParams(e,t,n){const s=[];e.color=new w.Color(1,1,1),e.opacity=1;const i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const o=i.baseColorFactor;e.color.setRGB(o[0],o[1],o[2],w.LinearSRGBColorSpace),e.opacity=o[3]}i.baseColorTexture!==void 0&&s.push(n.assignTexture(e,"map",i.baseColorTexture,w.SRGBColorSpace))}return Promise.all(s)}}class jo{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name].emissiveStrength;return i!==void 0&&(t.emissiveIntensity=i),Promise.resolve()}}class Do{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:w.MeshPhysicalMaterial}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];if(o.clearcoatFactor!==void 0&&(t.clearcoat=o.clearcoatFactor),o.clearcoatTexture!==void 0&&i.push(n.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),o.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),o.clearcoatRoughnessTexture!==void 0&&i.push(n.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),o.clearcoatNormalTexture!==void 0&&(i.push(n.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),o.clearcoatNormalTexture.scale!==void 0)){const r=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new w.Vector2(r,r)}return Promise.all(i)}}class Go{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:w.MeshPhysicalMaterial}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];return o.iridescenceFactor!==void 0&&(t.iridescence=o.iridescenceFactor),o.iridescenceTexture!==void 0&&i.push(n.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),o.iridescenceIor!==void 0&&(t.iridescenceIOR=o.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),o.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),o.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),o.iridescenceThicknessTexture!==void 0&&i.push(n.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(i)}}class Ho{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_SHEEN}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:w.MeshPhysicalMaterial}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[];t.sheenColor=new w.Color(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=s.extensions[this.name];if(o.sheenColorFactor!==void 0){const r=o.sheenColorFactor;t.sheenColor.setRGB(r[0],r[1],r[2],w.LinearSRGBColorSpace)}return o.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=o.sheenRoughnessFactor),o.sheenColorTexture!==void 0&&i.push(n.assignTexture(t,"sheenColorMap",o.sheenColorTexture,w.SRGBColorSpace)),o.sheenRoughnessTexture!==void 0&&i.push(n.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(i)}}class Uo{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:w.MeshPhysicalMaterial}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];return o.transmissionFactor!==void 0&&(t.transmission=o.transmissionFactor),o.transmissionTexture!==void 0&&i.push(n.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(i)}}class qo{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_VOLUME}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:w.MeshPhysicalMaterial}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];t.thickness=o.thicknessFactor!==void 0?o.thicknessFactor:0,o.thicknessTexture!==void 0&&i.push(n.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const r=o.attenuationColor||[1,1,1];return t.attenuationColor=new w.Color().setRGB(r[0],r[1],r[2],w.LinearSRGBColorSpace),Promise.all(i)}}class Vo{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_IOR}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:w.MeshPhysicalMaterial}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name];return t.ior=i.ior!==void 0?i.ior:1.5,Promise.resolve()}}class Wo{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_SPECULAR}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:w.MeshPhysicalMaterial}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];t.specularIntensity=o.specularFactor!==void 0?o.specularFactor:1,o.specularTexture!==void 0&&i.push(n.assignTexture(t,"specularIntensityMap",o.specularTexture));const r=o.specularColorFactor||[1,1,1];return t.specularColor=new w.Color().setRGB(r[0],r[1],r[2],w.LinearSRGBColorSpace),o.specularColorTexture!==void 0&&i.push(n.assignTexture(t,"specularColorMap",o.specularColorTexture,w.SRGBColorSpace)),Promise.all(i)}}class Xo{constructor(e){this.parser=e,this.name=U.EXT_MATERIALS_BUMP}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:w.MeshPhysicalMaterial}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];return t.bumpScale=o.bumpFactor!==void 0?o.bumpFactor:1,o.bumpTexture!==void 0&&i.push(n.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(i)}}class Ko{constructor(e){this.parser=e,this.name=U.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const n=this.parser.json.materials[e];return!n.extensions||!n.extensions[this.name]?null:w.MeshPhysicalMaterial}extendMaterialParams(e,t){const n=this.parser,s=n.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];return o.anisotropyStrength!==void 0&&(t.anisotropy=o.anisotropyStrength),o.anisotropyRotation!==void 0&&(t.anisotropyRotation=o.anisotropyRotation),o.anisotropyTexture!==void 0&&i.push(n.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(i)}}class Yo{constructor(e){this.parser=e,this.name=U.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,n=t.json,s=n.textures[e];if(!s.extensions||!s.extensions[this.name])return null;const i=s.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,i.source,o)}}class $o{constructor(e){this.parser=e,this.name=U.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,s=n.json,i=s.textures[e];if(!i.extensions||!i.extensions[t])return null;const o=i.extensions[t],r=s.images[o.source];let a=n.textureLoader;if(r.uri){const c=n.options.manager.getHandler(r.uri);c!==null&&(a=c)}return this.detectSupport().then(function(c){if(c)return n.loadTextureImage(e,o.source,a);if(s.extensionsRequired&&s.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return n.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Zo{constructor(e){this.parser=e,this.name=U.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,s=n.json,i=s.textures[e];if(!i.extensions||!i.extensions[t])return null;const o=i.extensions[t],r=s.images[o.source];let a=n.textureLoader;if(r.uri){const c=n.options.manager.getHandler(r.uri);c!==null&&(a=c)}return this.detectSupport().then(function(c){if(c)return n.loadTextureImage(e,o.source,a);if(s.extensionsRequired&&s.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return n.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Qo{constructor(e){this.name=U.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,n=t.bufferViews[e];if(n.extensions&&n.extensions[this.name]){const s=n.extensions[this.name],i=this.parser.getDependency("buffer",s.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then(function(r){const a=s.byteOffset||0,c=s.byteLength||0,l=s.count,d=s.byteStride,u=new Uint8Array(r,a,c);return o.decodeGltfBufferAsync?o.decodeGltfBufferAsync(l,d,u,s.mode,s.filter).then(function(g){return g.buffer}):o.ready.then(function(){const g=new ArrayBuffer(l*d);return o.decodeGltfBuffer(new Uint8Array(g),l,d,u,s.mode,s.filter),g})})}else return null}}class Jo{constructor(e){this.name=U.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||n.mesh===void 0)return null;const s=t.meshes[n.mesh];for(const c of s.primitives)if(c.mode!==ie.TRIANGLES&&c.mode!==ie.TRIANGLE_STRIP&&c.mode!==ie.TRIANGLE_FAN&&c.mode!==void 0)return null;const o=n.extensions[this.name].attributes,r=[],a={};for(const c in o)r.push(this.parser.getDependency("accessor",o[c]).then(l=>(a[c]=l,a[c])));return r.length<1?null:(r.push(this.parser.createNodeMesh(e)),Promise.all(r).then(c=>{const l=c.pop(),d=l.isGroup?l.children:[l],u=c[0].count,g=[];for(const h of d){const y=new w.Matrix4,m=new w.Vector3,b=new w.Quaternion,v=new w.Vector3(1,1,1),A=new w.InstancedMesh(h.geometry,h.material,u);for(let E=0;E<u;E++)a.TRANSLATION&&m.fromBufferAttribute(a.TRANSLATION,E),a.ROTATION&&b.fromBufferAttribute(a.ROTATION,E),a.SCALE&&v.fromBufferAttribute(a.SCALE,E),A.setMatrixAt(E,y.compose(m,b,v));for(const E in a)if(E==="_COLOR_0"){const S=a[E];A.instanceColor=new w.InstancedBufferAttribute(S.array,S.itemSize,S.normalized)}else E!=="TRANSLATION"&&E!=="ROTATION"&&E!=="SCALE"&&h.geometry.setAttribute(E,a[E]);w.Object3D.prototype.copy.call(A,h),this.parser.assignFinalMaterial(A),g.push(A)}return l.isGroup?(l.clear(),l.add(...g),l):g[0]}))}}const mn="glTF",Ge=12,yn={JSON:1313821514,BIN:5130562};class er{constructor(e){this.name=U.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,Ge),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==mn)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const s=this.header.length-Ge,i=new DataView(e,Ge);let o=0;for(;o<s;){const r=i.getUint32(o,!0);o+=4;const a=i.getUint32(o,!0);if(o+=4,a===yn.JSON){const c=new Uint8Array(e,Ge+o,r);this.content=n.decode(c)}else if(a===yn.BIN){const c=Ge+o;this.body=e.slice(c,c+r)}o+=r}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class tr{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=U.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const n=this.json,s=this.dracoLoader,i=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,r={},a={},c={};for(const l in o){const d=At[l]||l.toLowerCase();r[d]=o[l]}for(const l in e.attributes){const d=At[l]||l.toLowerCase();if(o[l]!==void 0){const u=n.accessors[e.attributes[l]],g=Pe[u.componentType];c[d]=g.name,a[d]=u.normalized===!0}}return t.getDependency("bufferView",i).then(function(l){return new Promise(function(d,u){s.decodeDracoFile(l,function(g){for(const h in g.attributes){const y=g.attributes[h],m=a[h];m!==void 0&&(y.normalized=m)}d(g)},r,c,w.LinearSRGBColorSpace,u)})})}}class nr{constructor(){this.name=U.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class sr{constructor(){this.name=U.KHR_MESH_QUANTIZATION}}class gn extends w.Interpolant{constructor(e,t,n,s){super(e,t,n,s)}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,s=this.valueSize,i=e*s*3+s;for(let o=0;o!==s;o++)t[o]=n[i+o];return t}interpolate_(e,t,n,s){const i=this.resultBuffer,o=this.sampleValues,r=this.valueSize,a=r*2,c=r*3,l=s-t,d=(n-t)/l,u=d*d,g=u*d,h=e*c,y=h-c,m=-2*g+3*u,b=g-u,v=1-m,A=b-u+d;for(let E=0;E!==r;E++){const S=o[y+E+r],M=o[y+E+a]*l,N=o[h+E+r],C=o[h+E]*l;i[E]=v*S+A*M+m*N+b*C}return i}}const ir=new w.Quaternion;class or extends gn{interpolate_(e,t,n,s){const i=super.interpolate_(e,t,n,s);return ir.fromArray(i).normalize().toArray(i),i}}const ie={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},Pe={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},wn={9728:w.NearestFilter,9729:w.LinearFilter,9984:w.NearestMipmapNearestFilter,9985:w.LinearMipmapNearestFilter,9986:w.NearestMipmapLinearFilter,9987:w.LinearMipmapLinearFilter},vn={33071:w.ClampToEdgeWrapping,33648:w.MirroredRepeatWrapping,10497:w.RepeatWrapping},xt={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},At={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},ve={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},rr={CUBICSPLINE:void 0,LINEAR:w.InterpolateLinear,STEP:w.InterpolateDiscrete},Et={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function ar(p){return p.DefaultMaterial===void 0&&(p.DefaultMaterial=new w.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:w.FrontSide})),p.DefaultMaterial}function Se(p,e,t){for(const n in t.extensions)p[n]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[n]=t.extensions[n])}function be(p,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(p.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function cr(p,e,t){let n=!1,s=!1,i=!1;for(let c=0,l=e.length;c<l;c++){const d=e[c];if(d.POSITION!==void 0&&(n=!0),d.NORMAL!==void 0&&(s=!0),d.COLOR_0!==void 0&&(i=!0),n&&s&&i)break}if(!n&&!s&&!i)return Promise.resolve(p);const o=[],r=[],a=[];for(let c=0,l=e.length;c<l;c++){const d=e[c];if(n){const u=d.POSITION!==void 0?t.getDependency("accessor",d.POSITION):p.attributes.position;o.push(u)}if(s){const u=d.NORMAL!==void 0?t.getDependency("accessor",d.NORMAL):p.attributes.normal;r.push(u)}if(i){const u=d.COLOR_0!==void 0?t.getDependency("accessor",d.COLOR_0):p.attributes.color;a.push(u)}}return Promise.all([Promise.all(o),Promise.all(r),Promise.all(a)]).then(function(c){const l=c[0],d=c[1],u=c[2];return n&&(p.morphAttributes.position=l),s&&(p.morphAttributes.normal=d),i&&(p.morphAttributes.color=u),p.morphTargetsRelative=!0,p})}function lr(p,e){if(p.updateMorphTargets(),e.weights!==void 0)for(let t=0,n=e.weights.length;t<n;t++)p.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(p.morphTargetInfluences.length===t.length){p.morphTargetDictionary={};for(let n=0,s=t.length;n<s;n++)p.morphTargetDictionary[t[n]]=n}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function ur(p){let e;const t=p.extensions&&p.extensions[U.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+Tt(t.attributes):e=p.indices+":"+Tt(p.attributes)+":"+p.mode,p.targets!==void 0)for(let n=0,s=p.targets.length;n<s;n++)e+=":"+Tt(p.targets[n]);return e}function Tt(p){let e="";const t=Object.keys(p).sort();for(let n=0,s=t.length;n<s;n++)e+=t[n]+":"+p[t[n]]+";";return e}function St(p){switch(p){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function hr(p){return p.search(/\.jpe?g($|\?)/i)>0||p.search(/^data\:image\/jpeg/)===0?"image/jpeg":p.search(/\.webp($|\?)/i)>0||p.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const dr=new w.Matrix4;class fr{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Bo,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,s=!1,i=-1;typeof navigator<"u"&&(n=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,s=navigator.userAgent.indexOf("Firefox")>-1,i=s?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),typeof createImageBitmap>"u"||n||s&&i<98?this.textureLoader=new w.TextureLoader(this.options.manager):this.textureLoader=new w.ImageBitmapLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new w.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const n=this,s=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])}).then(function(o){const r={scene:o[0][s.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:s.asset,parser:n,userData:{}};return Se(i,r,s),be(r,s),Promise.all(n._invokeAll(function(a){return a.afterRoot&&a.afterRoot(r)})).then(function(){e(r)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let s=0,i=t.length;s<i;s++){const o=t[s].joints;for(let r=0,a=o.length;r<a;r++)e[o[r]].isBone=!0}for(let s=0,i=e.length;s<i;s++){const o=e[s];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(n[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;const s=n.clone(),i=(o,r)=>{const a=this.associations.get(o);a!=null&&this.associations.set(r,a);for(const[c,l]of o.children.entries())i(l,r.children[c])};return i(n,s),s.name+="_instance_"+e.uses[t]++,s}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){const s=e(t[n]);if(s)return s}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const n=[];for(let s=0;s<t.length;s++){const i=e(t[s]);i&&n.push(i)}return n}getDependency(e,t){const n=e+":"+t;let s=this.cache.get(n);if(!s){switch(e){case"scene":s=this.loadScene(t);break;case"node":s=this._invokeOne(function(i){return i.loadNode&&i.loadNode(t)});break;case"mesh":s=this._invokeOne(function(i){return i.loadMesh&&i.loadMesh(t)});break;case"accessor":s=this.loadAccessor(t);break;case"bufferView":s=this._invokeOne(function(i){return i.loadBufferView&&i.loadBufferView(t)});break;case"buffer":s=this.loadBuffer(t);break;case"material":s=this._invokeOne(function(i){return i.loadMaterial&&i.loadMaterial(t)});break;case"texture":s=this._invokeOne(function(i){return i.loadTexture&&i.loadTexture(t)});break;case"skin":s=this.loadSkin(t);break;case"animation":s=this._invokeOne(function(i){return i.loadAnimation&&i.loadAnimation(t)});break;case"camera":s=this.loadCamera(t);break;default:if(s=this._invokeOne(function(i){return i!=this&&i.getDependency&&i.getDependency(e,t)}),!s)throw new Error("Unknown type: "+e);break}this.cache.add(n,s)}return s}getDependencies(e){let t=this.cache.get(e);if(!t){const n=this,s=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(s.map(function(i,o){return n.getDependency(e,o)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],n=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[U.KHR_BINARY_GLTF].body);const s=this.options;return new Promise(function(i,o){n.load(w.LoaderUtils.resolveURL(t.uri,s.path),i,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(n){const s=t.byteLength||0,i=t.byteOffset||0;return n.slice(i,i+s)})}loadAccessor(e){const t=this,n=this.json,s=this.json.accessors[e];if(s.bufferView===void 0&&s.sparse===void 0){const o=xt[s.type],r=Pe[s.componentType],a=s.normalized===!0,c=new r(s.count*o);return Promise.resolve(new w.BufferAttribute(c,o,a))}const i=[];return s.bufferView!==void 0?i.push(this.getDependency("bufferView",s.bufferView)):i.push(null),s.sparse!==void 0&&(i.push(this.getDependency("bufferView",s.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",s.sparse.values.bufferView))),Promise.all(i).then(function(o){const r=o[0],a=xt[s.type],c=Pe[s.componentType],l=c.BYTES_PER_ELEMENT,d=l*a,u=s.byteOffset||0,g=s.bufferView!==void 0?n.bufferViews[s.bufferView].byteStride:void 0,h=s.normalized===!0;let y,m;if(g&&g!==d){const b=Math.floor(u/g),v="InterleavedBuffer:"+s.bufferView+":"+s.componentType+":"+b+":"+s.count;let A=t.cache.get(v);A||(y=new c(r,b*g,s.count*g/l),A=new w.InterleavedBuffer(y,g/l),t.cache.add(v,A)),m=new w.InterleavedBufferAttribute(A,a,u%g/l,h)}else r===null?y=new c(s.count*a):y=new c(r,u,s.count*a),m=new w.BufferAttribute(y,a,h);if(s.sparse!==void 0){const b=xt.SCALAR,v=Pe[s.sparse.indices.componentType],A=s.sparse.indices.byteOffset||0,E=s.sparse.values.byteOffset||0,S=new v(o[1],A,s.sparse.count*b),M=new c(o[2],E,s.sparse.count*a);r!==null&&(m=new w.BufferAttribute(m.array.slice(),m.itemSize,m.normalized));for(let N=0,C=S.length;N<C;N++){const _=S[N];if(m.setX(_,M[N*a]),a>=2&&m.setY(_,M[N*a+1]),a>=3&&m.setZ(_,M[N*a+2]),a>=4&&m.setW(_,M[N*a+3]),a>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return m})}loadTexture(e){const t=this.json,n=this.options,i=t.textures[e].source,o=t.images[i];let r=this.textureLoader;if(o.uri){const a=n.manager.getHandler(o.uri);a!==null&&(r=a)}return this.loadTextureImage(e,i,r)}loadTextureImage(e,t,n){const s=this,i=this.json,o=i.textures[e],r=i.images[t],a=(r.uri||r.bufferView)+":"+o.sampler;if(this.textureCache[a])return this.textureCache[a];const c=this.loadImageSource(t,n).then(function(l){l.flipY=!1,l.name=o.name||r.name||"",l.name===""&&typeof r.uri=="string"&&r.uri.startsWith("data:image/")===!1&&(l.name=r.uri);const u=(i.samplers||{})[o.sampler]||{};return l.magFilter=wn[u.magFilter]||w.LinearFilter,l.minFilter=wn[u.minFilter]||w.LinearMipmapLinearFilter,l.wrapS=vn[u.wrapS]||w.RepeatWrapping,l.wrapT=vn[u.wrapT]||w.RepeatWrapping,s.associations.set(l,{textures:e}),l}).catch(function(){return null});return this.textureCache[a]=c,c}loadImageSource(e,t){const n=this,s=this.json,i=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(d=>d.clone());const o=s.images[e],r=self.URL||self.webkitURL;let a=o.uri||"",c=!1;if(o.bufferView!==void 0)a=n.getDependency("bufferView",o.bufferView).then(function(d){c=!0;const u=new Blob([d],{type:o.mimeType});return a=r.createObjectURL(u),a});else if(o.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const l=Promise.resolve(a).then(function(d){return new Promise(function(u,g){let h=u;t.isImageBitmapLoader===!0&&(h=function(y){const m=new w.Texture(y);m.needsUpdate=!0,u(m)}),t.load(w.LoaderUtils.resolveURL(d,i.path),h,void 0,g)})}).then(function(d){return c===!0&&r.revokeObjectURL(a),d.userData.mimeType=o.mimeType||hr(o.uri),d}).catch(function(d){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),d});return this.sourceCache[e]=l,l}assignTexture(e,t,n,s){const i=this;return this.getDependency("texture",n.index).then(function(o){if(!o)return null;if(n.texCoord!==void 0&&n.texCoord>0&&(o=o.clone(),o.channel=n.texCoord),i.extensions[U.KHR_TEXTURE_TRANSFORM]){const r=n.extensions!==void 0?n.extensions[U.KHR_TEXTURE_TRANSFORM]:void 0;if(r){const a=i.associations.get(o);o=i.extensions[U.KHR_TEXTURE_TRANSFORM].extendTexture(o,r),i.associations.set(o,a)}}return s!==void 0&&(o.colorSpace=s),e[t]=o,o})}assignFinalMaterial(e){const t=e.geometry;let n=e.material;const s=t.attributes.tangent===void 0,i=t.attributes.color!==void 0,o=t.attributes.normal===void 0;if(e.isPoints){const r="PointsMaterial:"+n.uuid;let a=this.cache.get(r);a||(a=new w.PointsMaterial,w.Material.prototype.copy.call(a,n),a.color.copy(n.color),a.map=n.map,a.sizeAttenuation=!1,this.cache.add(r,a)),n=a}else if(e.isLine){const r="LineBasicMaterial:"+n.uuid;let a=this.cache.get(r);a||(a=new w.LineBasicMaterial,w.Material.prototype.copy.call(a,n),a.color.copy(n.color),a.map=n.map,this.cache.add(r,a)),n=a}if(s||i||o){let r="ClonedMaterial:"+n.uuid+":";s&&(r+="derivative-tangents:"),i&&(r+="vertex-colors:"),o&&(r+="flat-shading:");let a=this.cache.get(r);a||(a=n.clone(),i&&(a.vertexColors=!0),o&&(a.flatShading=!0),s&&(a.normalScale&&(a.normalScale.y*=-1),a.clearcoatNormalScale&&(a.clearcoatNormalScale.y*=-1)),this.cache.add(r,a),this.associations.set(a,this.associations.get(n))),n=a}e.material=n}getMaterialType(){return w.MeshStandardMaterial}loadMaterial(e){const t=this,n=this.json,s=this.extensions,i=n.materials[e];let o;const r={},a=i.extensions||{},c=[];if(a[U.KHR_MATERIALS_UNLIT]){const d=s[U.KHR_MATERIALS_UNLIT];o=d.getMaterialType(),c.push(d.extendParams(r,i,t))}else{const d=i.pbrMetallicRoughness||{};if(r.color=new w.Color(1,1,1),r.opacity=1,Array.isArray(d.baseColorFactor)){const u=d.baseColorFactor;r.color.setRGB(u[0],u[1],u[2],w.LinearSRGBColorSpace),r.opacity=u[3]}d.baseColorTexture!==void 0&&c.push(t.assignTexture(r,"map",d.baseColorTexture,w.SRGBColorSpace)),r.metalness=d.metallicFactor!==void 0?d.metallicFactor:1,r.roughness=d.roughnessFactor!==void 0?d.roughnessFactor:1,d.metallicRoughnessTexture!==void 0&&(c.push(t.assignTexture(r,"metalnessMap",d.metallicRoughnessTexture)),c.push(t.assignTexture(r,"roughnessMap",d.metallicRoughnessTexture))),o=this._invokeOne(function(u){return u.getMaterialType&&u.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(u){return u.extendMaterialParams&&u.extendMaterialParams(e,r)})))}i.doubleSided===!0&&(r.side=w.DoubleSide);const l=i.alphaMode||Et.OPAQUE;if(l===Et.BLEND?(r.transparent=!0,r.depthWrite=!1):(r.transparent=!1,l===Et.MASK&&(r.alphaTest=i.alphaCutoff!==void 0?i.alphaCutoff:.5)),i.normalTexture!==void 0&&o!==w.MeshBasicMaterial&&(c.push(t.assignTexture(r,"normalMap",i.normalTexture)),r.normalScale=new w.Vector2(1,1),i.normalTexture.scale!==void 0)){const d=i.normalTexture.scale;r.normalScale.set(d,d)}if(i.occlusionTexture!==void 0&&o!==w.MeshBasicMaterial&&(c.push(t.assignTexture(r,"aoMap",i.occlusionTexture)),i.occlusionTexture.strength!==void 0&&(r.aoMapIntensity=i.occlusionTexture.strength)),i.emissiveFactor!==void 0&&o!==w.MeshBasicMaterial){const d=i.emissiveFactor;r.emissive=new w.Color().setRGB(d[0],d[1],d[2],w.LinearSRGBColorSpace)}return i.emissiveTexture!==void 0&&o!==w.MeshBasicMaterial&&c.push(t.assignTexture(r,"emissiveMap",i.emissiveTexture,w.SRGBColorSpace)),Promise.all(c).then(function(){const d=new o(r);return i.name&&(d.name=i.name),be(d,i),t.associations.set(d,{materials:e}),i.extensions&&Se(s,d,i),d})}createUniqueName(e){const t=w.PropertyBinding.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,n=this.extensions,s=this.primitiveCache;function i(r){return n[U.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(r,t).then(function(a){return bn(a,r,t)})}const o=[];for(let r=0,a=e.length;r<a;r++){const c=e[r],l=ur(c),d=s[l];if(d)o.push(d.promise);else{let u;c.extensions&&c.extensions[U.KHR_DRACO_MESH_COMPRESSION]?u=i(c):u=bn(new w.BufferGeometry,c,t),s[l]={primitive:c,promise:u},o.push(u)}}return Promise.all(o)}loadMesh(e){const t=this,n=this.json,s=this.extensions,i=n.meshes[e],o=i.primitives,r=[];for(let a=0,c=o.length;a<c;a++){const l=o[a].material===void 0?ar(this.cache):this.getDependency("material",o[a].material);r.push(l)}return r.push(t.loadGeometries(o)),Promise.all(r).then(function(a){const c=a.slice(0,a.length-1),l=a[a.length-1],d=[];for(let g=0,h=l.length;g<h;g++){const y=l[g],m=o[g];let b;const v=c[g];if(m.mode===ie.TRIANGLES||m.mode===ie.TRIANGLE_STRIP||m.mode===ie.TRIANGLE_FAN||m.mode===void 0)b=i.isSkinnedMesh===!0?new w.SkinnedMesh(y,v):new w.Mesh(y,v),b.isSkinnedMesh===!0&&b.normalizeSkinWeights(),m.mode===ie.TRIANGLE_STRIP?b.geometry=pn(b.geometry,w.TriangleStripDrawMode):m.mode===ie.TRIANGLE_FAN&&(b.geometry=pn(b.geometry,w.TriangleFanDrawMode));else if(m.mode===ie.LINES)b=new w.LineSegments(y,v);else if(m.mode===ie.LINE_STRIP)b=new w.Line(y,v);else if(m.mode===ie.LINE_LOOP)b=new w.LineLoop(y,v);else if(m.mode===ie.POINTS)b=new w.Points(y,v);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+m.mode);Object.keys(b.geometry.morphAttributes).length>0&&lr(b,i),b.name=t.createUniqueName(i.name||"mesh_"+e),be(b,i),m.extensions&&Se(s,b,m),t.assignFinalMaterial(b),d.push(b)}for(let g=0,h=d.length;g<h;g++)t.associations.set(d[g],{meshes:e,primitives:g});if(d.length===1)return i.extensions&&Se(s,d[0],i),d[0];const u=new w.Group;i.extensions&&Se(s,u,i),t.associations.set(u,{meshes:e});for(let g=0,h=d.length;g<h;g++)u.add(d[g]);return u})}loadCamera(e){let t;const n=this.json.cameras[e],s=n[n.type];if(!s){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return n.type==="perspective"?t=new w.PerspectiveCamera(w.MathUtils.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):n.type==="orthographic"&&(t=new w.OrthographicCamera(-s.xmag,s.xmag,s.ymag,-s.ymag,s.znear,s.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),be(t,n),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],n=[];for(let s=0,i=t.joints.length;s<i;s++)n.push(this._loadNodeShallow(t.joints[s]));return t.inverseBindMatrices!==void 0?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then(function(s){const i=s.pop(),o=s,r=[],a=[];for(let c=0,l=o.length;c<l;c++){const d=o[c];if(d){r.push(d);const u=new w.Matrix4;i!==null&&u.fromArray(i.array,c*16),a.push(u)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[c])}return new w.Skeleton(r,a)})}loadAnimation(e){const t=this.json,n=this,s=t.animations[e],i=s.name?s.name:"animation_"+e,o=[],r=[],a=[],c=[],l=[];for(let d=0,u=s.channels.length;d<u;d++){const g=s.channels[d],h=s.samplers[g.sampler],y=g.target,m=y.node,b=s.parameters!==void 0?s.parameters[h.input]:h.input,v=s.parameters!==void 0?s.parameters[h.output]:h.output;y.node!==void 0&&(o.push(this.getDependency("node",m)),r.push(this.getDependency("accessor",b)),a.push(this.getDependency("accessor",v)),c.push(h),l.push(y))}return Promise.all([Promise.all(o),Promise.all(r),Promise.all(a),Promise.all(c),Promise.all(l)]).then(function(d){const u=d[0],g=d[1],h=d[2],y=d[3],m=d[4],b=[];for(let v=0,A=u.length;v<A;v++){const E=u[v],S=g[v],M=h[v],N=y[v],C=m[v];if(E===void 0)continue;E.updateMatrix&&E.updateMatrix();const _=n._createAnimationTracks(E,S,M,N,C);if(_)for(let I=0;I<_.length;I++)b.push(_[I])}return new w.AnimationClip(i,void 0,b)})}createNodeMesh(e){const t=this.json,n=this,s=t.nodes[e];return s.mesh===void 0?null:n.getDependency("mesh",s.mesh).then(function(i){const o=n._getNodeRef(n.meshCache,s.mesh,i);return s.weights!==void 0&&o.traverse(function(r){if(r.isMesh)for(let a=0,c=s.weights.length;a<c;a++)r.morphTargetInfluences[a]=s.weights[a]}),o})}loadNode(e){const t=this.json,n=this,s=t.nodes[e],i=n._loadNodeShallow(e),o=[],r=s.children||[];for(let c=0,l=r.length;c<l;c++)o.push(n.getDependency("node",r[c]));const a=s.skin===void 0?Promise.resolve(null):n.getDependency("skin",s.skin);return Promise.all([i,Promise.all(o),a]).then(function(c){const l=c[0],d=c[1],u=c[2];u!==null&&l.traverse(function(g){g.isSkinnedMesh&&g.bind(u,dr)});for(let g=0,h=d.length;g<h;g++)l.add(d[g]);return l})}_loadNodeShallow(e){const t=this.json,n=this.extensions,s=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const i=t.nodes[e],o=i.name?s.createUniqueName(i.name):"",r=[],a=s._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(e)});return a&&r.push(a),i.camera!==void 0&&r.push(s.getDependency("camera",i.camera).then(function(c){return s._getNodeRef(s.cameraCache,i.camera,c)})),s._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(e)}).forEach(function(c){r.push(c)}),this.nodeCache[e]=Promise.all(r).then(function(c){let l;if(i.isBone===!0?l=new w.Bone:c.length>1?l=new w.Group:c.length===1?l=c[0]:l=new w.Object3D,l!==c[0])for(let d=0,u=c.length;d<u;d++)l.add(c[d]);if(i.name&&(l.userData.name=i.name,l.name=o),be(l,i),i.extensions&&Se(n,l,i),i.matrix!==void 0){const d=new w.Matrix4;d.fromArray(i.matrix),l.applyMatrix4(d)}else i.translation!==void 0&&l.position.fromArray(i.translation),i.rotation!==void 0&&l.quaternion.fromArray(i.rotation),i.scale!==void 0&&l.scale.fromArray(i.scale);return s.associations.has(l)||s.associations.set(l,{}),s.associations.get(l).nodes=e,l}),this.nodeCache[e]}loadScene(e){const t=this.extensions,n=this.json.scenes[e],s=this,i=new w.Group;n.name&&(i.name=s.createUniqueName(n.name)),be(i,n),n.extensions&&Se(t,i,n);const o=n.nodes||[],r=[];for(let a=0,c=o.length;a<c;a++)r.push(s.getDependency("node",o[a]));return Promise.all(r).then(function(a){for(let l=0,d=a.length;l<d;l++)i.add(a[l]);const c=l=>{const d=new Map;for(const[u,g]of s.associations)(u instanceof w.Material||u instanceof w.Texture)&&d.set(u,g);return l.traverse(u=>{const g=s.associations.get(u);g!=null&&d.set(u,g)}),d};return s.associations=c(i),i})}_createAnimationTracks(e,t,n,s,i){const o=[],r=e.name?e.name:e.uuid,a=[];ve[i.path]===ve.weights?e.traverse(function(u){u.morphTargetInfluences&&a.push(u.name?u.name:u.uuid)}):a.push(r);let c;switch(ve[i.path]){case ve.weights:c=w.NumberKeyframeTrack;break;case ve.rotation:c=w.QuaternionKeyframeTrack;break;case ve.position:case ve.scale:c=w.VectorKeyframeTrack;break;default:switch(n.itemSize){case 1:c=w.NumberKeyframeTrack;break;case 2:case 3:default:c=w.VectorKeyframeTrack;break}break}const l=s.interpolation!==void 0?rr[s.interpolation]:w.InterpolateLinear,d=this._getArrayFromAccessor(n);for(let u=0,g=a.length;u<g;u++){const h=new c(a[u]+"."+ve[i.path],t.array,d,l);s.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(h),o.push(h)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const n=St(t.constructor),s=new Float32Array(t.length);for(let i=0,o=t.length;i<o;i++)s[i]=t[i]*n;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(n){const s=this instanceof w.QuaternionKeyframeTrack?or:gn;return new s(this.times,this.values,this.getValueSize()/3,n)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function pr(p,e,t){const n=e.attributes,s=new w.Box3;if(n.POSITION!==void 0){const r=t.json.accessors[n.POSITION],a=r.min,c=r.max;if(a!==void 0&&c!==void 0){if(s.set(new w.Vector3(a[0],a[1],a[2]),new w.Vector3(c[0],c[1],c[2])),r.normalized){const l=St(Pe[r.componentType]);s.min.multiplyScalar(l),s.max.multiplyScalar(l)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const i=e.targets;if(i!==void 0){const r=new w.Vector3,a=new w.Vector3;for(let c=0,l=i.length;c<l;c++){const d=i[c];if(d.POSITION!==void 0){const u=t.json.accessors[d.POSITION],g=u.min,h=u.max;if(g!==void 0&&h!==void 0){if(a.setX(Math.max(Math.abs(g[0]),Math.abs(h[0]))),a.setY(Math.max(Math.abs(g[1]),Math.abs(h[1]))),a.setZ(Math.max(Math.abs(g[2]),Math.abs(h[2]))),u.normalized){const y=St(Pe[u.componentType]);a.multiplyScalar(y)}r.max(a)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}s.expandByVector(r)}p.boundingBox=s;const o=new w.Sphere;s.getCenter(o.center),o.radius=s.min.distanceTo(s.max)/2,p.boundingSphere=o}function bn(p,e,t){const n=e.attributes,s=[];function i(o,r){return t.getDependency("accessor",o).then(function(a){p.setAttribute(r,a)})}for(const o in n){const r=At[o]||o.toLowerCase();r in p.attributes||s.push(i(n[o],r))}if(e.indices!==void 0&&!p.index){const o=t.getDependency("accessor",e.indices).then(function(r){p.setIndex(r)});s.push(o)}return w.ColorManagement.workingColorSpace!==w.LinearSRGBColorSpace&&"COLOR_0"in n&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${w.ColorManagement.workingColorSpace}" not supported.`),be(p,e),pr(p,e,t),Promise.all(s).then(function(){return e.targets!==void 0?cr(p,e.targets,t):p})}const K={Handedness:Object.freeze({NONE:"none",LEFT:"left",RIGHT:"right"}),ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};async function xn(p){const e=await fetch(p);if(e.ok)return e.json();throw new Error(e.statusText)}async function mr(p){if(!p)throw new Error("No basePath supplied");return await xn(`${p}/profilesList.json`)}async function yr(p,e,t=null,n=!0){if(!p)throw new Error("No xrInputSource supplied");if(!e)throw new Error("No basePath supplied");const s=await mr(e);let i;if(p.profiles.some(a=>{const c=s[a];return c&&(i={profileId:a,profilePath:`${e}/${c.path}`,deprecated:!!c.deprecated}),!!i}),!i){if(!t)throw new Error("No matching profile name found");const a=s[t];if(!a)throw new Error(`No matching profile name found and default profile "${t}" missing.`);i={profileId:t,profilePath:`${e}/${a.path}`,deprecated:!!a.deprecated}}const o=await xn(i.profilePath);let r;if(n){let a;if(p.handedness==="any"?a=o.layouts[Object.keys(o.layouts)[0]]:a=o.layouts[p.handedness],!a)throw new Error(`No matching handedness, ${p.handedness}, in profile ${i.profileId}`);a.assetPath&&(r=i.profilePath.replace("profile.json",a.assetPath))}return{profile:o,assetPath:r}}const gr={xAxis:0,yAxis:0,button:0,state:K.ComponentState.DEFAULT};function wr(p=0,e=0){let t=p,n=e;if(Math.sqrt(p*p+e*e)>1){const o=Math.atan2(e,p);t=Math.cos(o),n=Math.sin(o)}return{normalizedXAxis:t*.5+.5,normalizedYAxis:n*.5+.5}}class vr{constructor(e){this.componentProperty=e.componentProperty,this.states=e.states,this.valueNodeName=e.valueNodeName,this.valueNodeProperty=e.valueNodeProperty,this.valueNodeProperty===K.VisualResponseProperty.TRANSFORM&&(this.minNodeName=e.minNodeName,this.maxNodeName=e.maxNodeName),this.value=0,this.updateFromComponent(gr)}updateFromComponent({xAxis:e,yAxis:t,button:n,state:s}){const{normalizedXAxis:i,normalizedYAxis:o}=wr(e,t);switch(this.componentProperty){case K.ComponentProperty.X_AXIS:this.value=this.states.includes(s)?i:.5;break;case K.ComponentProperty.Y_AXIS:this.value=this.states.includes(s)?o:.5;break;case K.ComponentProperty.BUTTON:this.value=this.states.includes(s)?n:0;break;case K.ComponentProperty.STATE:this.valueNodeProperty===K.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(s):this.value=this.states.includes(s)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class br{constructor(e,t){if(!e||!t||!t.visualResponses||!t.gamepadIndices||Object.keys(t.gamepadIndices).length===0)throw new Error("Invalid arguments supplied");this.id=e,this.type=t.type,this.rootNodeName=t.rootNodeName,this.touchPointNodeName=t.touchPointNodeName,this.visualResponses={},Object.keys(t.visualResponses).forEach(n=>{const s=new vr(t.visualResponses[n]);this.visualResponses[n]=s}),this.gamepadIndices=Object.assign({},t.gamepadIndices),this.values={state:K.ComponentState.DEFAULT,button:this.gamepadIndices.button!==void 0?0:void 0,xAxis:this.gamepadIndices.xAxis!==void 0?0:void 0,yAxis:this.gamepadIndices.yAxis!==void 0?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(e){if(this.values.state=K.ComponentState.DEFAULT,this.gamepadIndices.button!==void 0&&e.buttons.length>this.gamepadIndices.button){const t=e.buttons[this.gamepadIndices.button];this.values.button=t.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,t.pressed||this.values.button===1?this.values.state=K.ComponentState.PRESSED:(t.touched||this.values.button>K.ButtonTouchThreshold)&&(this.values.state=K.ComponentState.TOUCHED)}this.gamepadIndices.xAxis!==void 0&&e.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=e.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===K.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>K.AxisTouchThreshold&&(this.values.state=K.ComponentState.TOUCHED)),this.gamepadIndices.yAxis!==void 0&&e.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=e.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===K.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>K.AxisTouchThreshold&&(this.values.state=K.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach(t=>{t.updateFromComponent(this.values)})}}class xr{constructor(e,t,n){if(!e)throw new Error("No xrInputSource supplied");if(!t)throw new Error("No profile supplied");this.xrInputSource=e,this.assetUrl=n,this.id=t.profileId,this.layoutDescription=t.layouts[e.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach(s=>{const i=this.layoutDescription.components[s];this.components[s]=new br(s,i)}),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const e=[];return Object.values(this.components).forEach(t=>{e.push(t.data)}),e}updateFromGamepad(){Object.values(this.components).forEach(e=>{e.updateFromGamepad(this.xrInputSource.gamepad)})}}const Ar="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",Er="generic-trigger";class Tr extends w.Object3D{constructor(){super(),this.motionController=null,this.envMap=null}setEnvironmentMap(e){return this.envMap==e?this:(this.envMap=e,this.traverse(t=>{t.isMesh&&(t.material.envMap=this.envMap,t.material.needsUpdate=!0)}),this)}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&(this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach(t=>{Object.values(t.visualResponses).forEach(n=>{const{valueNode:s,minNode:i,maxNode:o,value:r,valueNodeProperty:a}=n;s&&(a===K.VisualResponseProperty.VISIBILITY?s.visible=r:a===K.VisualResponseProperty.TRANSFORM&&(s.quaternion.slerpQuaternions(i.quaternion,o.quaternion,r),s.position.lerpVectors(i.position,o.position,r)))})}))}}function Sr(p,e){Object.values(p.components).forEach(t=>{const{type:n,touchPointNodeName:s,visualResponses:i}=t;if(n===K.ComponentType.TOUCHPAD)if(t.touchPointNode=e.getObjectByName(s),t.touchPointNode){const o=new w.SphereGeometry(.001),r=new w.MeshBasicMaterial({color:255}),a=new w.Mesh(o,r);t.touchPointNode.add(a)}else console.warn(`Could not find touch dot, ${t.touchPointNodeName}, in touchpad component ${t.id}`);Object.values(i).forEach(o=>{const{valueNodeName:r,minNodeName:a,maxNodeName:c,valueNodeProperty:l}=o;if(l===K.VisualResponseProperty.TRANSFORM){if(o.minNode=e.getObjectByName(a),o.maxNode=e.getObjectByName(c),!o.minNode){console.warn(`Could not find ${a} in the model`);return}if(!o.maxNode){console.warn(`Could not find ${c} in the model`);return}}o.valueNode=e.getObjectByName(r),o.valueNode||console.warn(`Could not find ${r} in the model`)})})}function An(p,e){Sr(p.motionController,e),p.envMap&&e.traverse(t=>{t.isMesh&&(t.material.envMap=p.envMap,t.material.needsUpdate=!0)}),p.add(e)}class Mr{constructor(e=null){this.gltfLoader=e,this.path=Ar,this._assetCache={},this.gltfLoader||(this.gltfLoader=new bt)}createControllerModel(e){const t=new Tr;let n=null;return e.addEventListener("connected",s=>{const i=s.data;i.targetRayMode!=="tracked-pointer"||!i.gamepad||yr(i,this.path,Er).then(({profile:o,assetPath:r})=>{t.motionController=new xr(i,o,r);const a=this._assetCache[t.motionController.assetUrl];if(a)n=a.scene.clone(),An(t,n);else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(t.motionController.assetUrl,c=>{this._assetCache[t.motionController.assetUrl]=c,n=c.scene.clone(),An(t,n)},null,()=>{throw new Error(`Asset ${t.motionController.assetUrl} missing or malformed.`)})}}).catch(o=>{console.warn(o)})}),e.addEventListener("disconnected",()=>{t.motionController=null,t.remove(n),n=null}),t}}const En=new w.Matrix4,Tn=new w.Vector3;class Sn{constructor(e,t,n,s,i){this.controller=t,this.handModel=e,this.envMap=null;let o;!i||!i.primitive||i.primitive==="sphere"?o=new w.SphereGeometry(1,10,10):i.primitive==="box"&&(o=new w.BoxGeometry(1,1,1));const r=new w.MeshStandardMaterial;this.handMesh=new w.InstancedMesh(o,r,30),this.handMesh.frustumCulled=!1,this.handMesh.instanceMatrix.setUsage(w.DynamicDrawUsage),this.handMesh.castShadow=!0,this.handMesh.receiveShadow=!0,this.handModel.add(this.handMesh),this.joints=["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]}updateMesh(){const t=this.controller.joints;let n=0;for(let s=0;s<this.joints.length;s++){const i=t[this.joints[s]];i.visible&&(Tn.setScalar(i.jointRadius||.008),En.compose(i.position,i.quaternion,Tn),this.handMesh.setMatrixAt(s,En),n++)}this.handMesh.count=n,this.handMesh.instanceMatrix.needsUpdate=!0}}const Rr="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/";class Cr{constructor(e,t,n,s,i=null){this.controller=t,this.handModel=e,this.bones=[],i===null&&(i=new bt,i.setPath(n||Rr)),i.load(`${s}.glb`,o=>{const r=o.scene.children[0];this.handModel.add(r);const a=r.getObjectByProperty("type","SkinnedMesh");a.frustumCulled=!1,a.castShadow=!0,a.receiveShadow=!0,["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"].forEach(l=>{const d=r.getObjectByName(l);d!==void 0?d.jointName=l:console.warn(`Couldn't find ${l} in ${s} hand mesh`),this.bones.push(d)})})}updateMesh(){const e=this.controller.joints;for(let t=0;t<this.bones.length;t++){const n=this.bones[t];if(n){const s=e[n.jointName];if(s.visible){const i=s.position;n.position.copy(i),n.quaternion.copy(s.quaternion)}}}}}class _r extends w.Object3D{constructor(e){super(),this.controller=e,this.motionController=null,this.envMap=null,this.mesh=null}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&this.motionController.updateMesh()}}class Pr{constructor(){this.path=null}setPath(e){return this.path=e,this}createHandModel(e,t){const n=new _r(e);return e.addEventListener("connected",s=>{const i=s.data;i.hand&&!n.motionController&&(n.xrInputSource=i,t===void 0||t==="spheres"?n.motionController=new Sn(n,e,this.path,i.handedness,{primitive:"sphere"}):t==="boxes"?n.motionController=new Sn(n,e,this.path,i.handedness,{primitive:"box"}):t==="mesh"&&(n.motionController=new Cr(n,e,this.path,i.handedness))),e.visible=!0}),e.addEventListener("disconnected",()=>{e.visible=!1}),n}}class Nr extends w.Object3D{constructor(e){super();const t=new w.Matrix4,n=new Map,s=e.xr;s.addEventListener("planesdetected",i=>{const o=i.data,r=o.detectedPlanes,a=s.getReferenceSpace();let c=!1;for(const[l,d]of n)r.has(l)===!1&&(d.geometry.dispose(),d.material.dispose(),this.remove(d),n.delete(l),c=!0);for(const l of r)if(n.has(l)===!1){const d=o.getPose(l.planeSpace,a);t.fromArray(d.transform.matrix);const u=l.polygon;let g=Number.MAX_SAFE_INTEGER,h=Number.MIN_SAFE_INTEGER,y=Number.MAX_SAFE_INTEGER,m=Number.MIN_SAFE_INTEGER;for(const M of u)g=Math.min(g,M.x),h=Math.max(h,M.x),y=Math.min(y,M.z),m=Math.max(m,M.z);const b=h-g,v=m-y,A=new w.BoxGeometry(b,.01,v),E=new w.MeshBasicMaterial({color:16777215*Math.random()}),S=new w.Mesh(A,E);S.position.setFromMatrixPosition(t),S.quaternion.setFromRotationMatrix(t),this.add(S),n.set(l,S),c=!0}c&&this.dispatchEvent({type:"planeschanged"})})}}class Mn extends w.EventDispatcher{constructor(){super();Bt(this,"onSessionEnded",()=>{this.xrSession.removeEventListener("end",this.onSessionEnded),this.xrSession=null,this.app.dispatchEvent({type:"xrended",message:"xrended"})});Bt(this,"onSessionStarted",async t=>{t.addEventListener("end",this.onSessionEnded),await this.app.renderer.xr.setSession(t),this.xrSession=t,this.app.dispatchEvent({type:"xrstarted",message:"xrstarted"})});this.app=new It,this.xrMode="inline",this.xrSessionFeatures={requiredFeatures:["local"],optionalFeatures:["hand-tracking"]},this.xrSession=null,this.xrButton=this.createXRButton(),this.controllers=this.setupControllers(),this.xrPlanes=new Nr(this.app.renderer),this.app.renderer.xr.addEventListener("planesdetected",t=>{let n=this.app.renderer.xr.getSession();console.log(n)})}setXRSessionFeatures(t="inline",n={}){this.xrMode=t,this.xrSessionFeatures=n}checkXRSupport(){"xr"in navigator?navigator.xr.isSessionSupported(this.xrMode).then(t=>{t?this.app.dispatchEvent({type:"xrsupported",message:{isSupported:!0}}):this.app.dispatchEvent({type:"xrsupported",message:{isSupported:!1,reason:`The session mode '${this.xrMode}' is not supported on this device`}})}):this.app.dispatchEvent({type:"xrsupported",message:{isSupported:!1,reason:"The WebXR API does not exist in navigator"}})}createXRButton(){let t=document.createElement("button");return t.id="xr-button",t.disabled=!0,t.innerText="XR not available",this.app.addEventListener("xrsupported",n=>{n.message.isSupported&&(t.innerText="Start XR",t.disabled=!1,t.addEventListener("click",()=>{this.startXR()}))}),t}setupControllers(){let t=new Mr,n=new Pr,s=[];for(let i=0;i<2;i++){let o=this.app.renderer.xr.getController(i);s.push(o);let r=this.app.renderer.xr.getHand(i);r.add(n.createHandModel(r,"mesh")),this.app.scene.add(r);let a=new w.BufferGeometry().setFromPoints([new w.Vector3(0,0,0),new w.Vector3(0,0,-1)]),c=new w.Line(a);c.name="line",c.scale.z=3,o.add(c.clone());let l=this.app.renderer.xr.getControllerGrip(i);l.add(t.createControllerModel(l)),this.app.scene.add(o),this.app.scene.add(l)}return s}async startXR(){this.xrSession!==null&&(console.log("There is already an active XR session. Exiting..."),this.xrSession.end());try{let t=await navigator.xr.requestSession(this.xrMode,this.xrSessionFeatures);this.onSessionStarted(t)}catch(t){console.error(t)}}}const Mt=new WeakMap;class Ir extends w.Loader{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,n,s){const i=new w.FileLoader(this.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(e,o=>{this.parse(o,t,s)},n,s)}parse(e,t,n=()=>{}){this.decodeDracoFile(e,t,null,null,w.SRGBColorSpace).catch(n)}decodeDracoFile(e,t,n,s,i=w.LinearSRGBColorSpace,o=()=>{}){const r={attributeIDs:n||this.defaultAttributeIDs,attributeTypes:s||this.defaultAttributeTypes,useUniqueIDs:!!n,vertexColorSpace:i};return this.decodeGeometry(e,r).then(t).catch(o)}decodeGeometry(e,t){const n=JSON.stringify(t);if(Mt.has(e)){const a=Mt.get(e);if(a.key===n)return a.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let s;const i=this.workerNextTaskID++,o=e.byteLength,r=this._getWorker(i,o).then(a=>(s=a,new Promise((c,l)=>{s._callbacks[i]={resolve:c,reject:l},s.postMessage({type:"decode",id:i,taskConfig:t,buffer:e},[e])}))).then(a=>this._createGeometry(a.geometry));return r.catch(()=>!0).then(()=>{s&&i&&this._releaseTask(s,i)}),Mt.set(e,{key:n,promise:r}),r}_createGeometry(e){const t=new w.BufferGeometry;e.index&&t.setIndex(new w.BufferAttribute(e.index.array,1));for(let n=0;n<e.attributes.length;n++){const s=e.attributes[n],i=s.name,o=s.array,r=s.itemSize,a=new w.BufferAttribute(o,r);i==="color"&&(this._assignVertexColorSpace(a,s.vertexColorSpace),a.normalized=!(o instanceof Float32Array)),t.setAttribute(i,a)}return t}_assignVertexColorSpace(e,t){if(t!==w.SRGBColorSpace)return;const n=new w.Color;for(let s=0,i=e.count;s<i;s++)n.fromBufferAttribute(e,s).convertSRGBToLinear(),e.setXYZ(s,n.r,n.g,n.b)}_loadLibrary(e,t){const n=new w.FileLoader(this.manager);return n.setPath(this.decoderPath),n.setResponseType(t),n.setWithCredentials(this.withCredentials),new Promise((s,i)=>{n.load(e,s,void 0,i)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(n=>{const s=n[0];e||(this.decoderConfig.wasmBinary=n[1]);const i=Lr.toString(),o=["/* draco decoder */",s,"","/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([o]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const s=new Worker(this.workerSourceURL);s._callbacks={},s._taskCosts={},s._taskLoad=0,s.postMessage({type:"init",decoderConfig:this.decoderConfig}),s.onmessage=function(i){const o=i.data;switch(o.type){case"decode":s._callbacks[o.id].resolve(o);break;case"error":s._callbacks[o.id].reject(o);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+o.type+'"')}},this.workerPool.push(s)}else this.workerPool.sort(function(s,i){return s._taskLoad>i._taskLoad?-1:1});const n=this.workerPool[this.workerPool.length-1];return n._taskCosts[e]=t,n._taskLoad+=t,n})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this.workerSourceURL!==""&&URL.revokeObjectURL(this.workerSourceURL),this}}function Lr(){let p,e;onmessage=function(o){const r=o.data;switch(r.type){case"init":p=r.decoderConfig,e=new Promise(function(l){p.onModuleLoaded=function(d){l({draco:d})},DracoDecoderModule(p)});break;case"decode":const a=r.buffer,c=r.taskConfig;e.then(l=>{const d=l.draco,u=new d.Decoder;try{const g=t(d,u,new Int8Array(a),c),h=g.attributes.map(y=>y.array.buffer);g.index&&h.push(g.index.array.buffer),self.postMessage({type:"decode",id:r.id,geometry:g},h)}catch(g){console.error(g),self.postMessage({type:"error",id:r.id,error:g.message})}finally{d.destroy(u)}});break}};function t(o,r,a,c){const l=c.attributeIDs,d=c.attributeTypes;let u,g;const h=r.GetEncodedGeometryType(a);if(h===o.TRIANGULAR_MESH)u=new o.Mesh,g=r.DecodeArrayToMesh(a,a.byteLength,u);else if(h===o.POINT_CLOUD)u=new o.PointCloud,g=r.DecodeArrayToPointCloud(a,a.byteLength,u);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!g.ok()||u.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+g.error_msg());const y={index:null,attributes:[]};for(const m in l){const b=self[d[m]];let v,A;if(c.useUniqueIDs)A=l[m],v=r.GetAttributeByUniqueId(u,A);else{if(A=r.GetAttributeId(u,o[l[m]]),A===-1)continue;v=r.GetAttribute(u,A)}const E=s(o,r,u,m,b,v);m==="color"&&(E.vertexColorSpace=c.vertexColorSpace),y.attributes.push(E)}return h===o.TRIANGULAR_MESH&&(y.index=n(o,r,u)),o.destroy(u),y}function n(o,r,a){const l=a.num_faces()*3,d=l*4,u=o._malloc(d);r.GetTrianglesUInt32Array(a,d,u);const g=new Uint32Array(o.HEAPF32.buffer,u,l).slice();return o._free(u),{array:g,itemSize:1}}function s(o,r,a,c,l,d){const u=d.num_components(),h=a.num_points()*u,y=h*l.BYTES_PER_ELEMENT,m=i(o,l),b=o._malloc(y);r.GetAttributeDataArrayForAllPoints(a,d,m,y,b);const v=new l(o.HEAPF32.buffer,b,h).slice();return o._free(b),{name:c,array:v,itemSize:u}}function i(o,r){switch(r){case Float32Array:return o.DT_FLOAT32;case Int8Array:return o.DT_INT8;case Int16Array:return o.DT_INT16;case Int32Array:return o.DT_INT32;case Uint8Array:return o.DT_UINT8;case Uint16Array:return o.DT_UINT16;case Uint32Array:return o.DT_UINT32}}}class Or{constructor(){this.gltfLoader=new bt,this.dracoLoader=new Ir,this.dracoLoader.setDecoderPath("../libs/draco/gltf/"),this.gltfLoader.setDRACOLoader(this.dracoLoader)}async load(e){return await this.gltfLoader.loadAsync(e)}}class Fr extends w.EventDispatcher{constructor(){super(),this.app=new It}register(e,t){document.addEventListener("keydown",n=>{})}}var Rt={exports:{}},it={},Rn;function Br(){if(Rn)return it;Rn=1,Object.defineProperty(it,"__esModule",{value:!0});function p(h,y){(y==null||y>h.length)&&(y=h.length);for(var m=0,b=new Array(y);m<y;m++)b[m]=h[m];return b}function e(h){if(Array.isArray(h))return p(h)}function t(h){if(typeof Symbol<"u"&&h[Symbol.iterator]!=null||h["@@iterator"]!=null)return Array.from(h)}function n(h,y){if(h){if(typeof h=="string")return p(h,y);var m=Object.prototype.toString.call(h).slice(8,-1);if(m==="Object"&&h.constructor&&(m=h.constructor.name),m==="Map"||m==="Set")return Array.from(h);if(m==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(m))return p(h,y)}}function s(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function i(h){return e(h)||t(h)||n(h)||s()}function o(h,y){var m=typeof Symbol<"u"&&h[Symbol.iterator]||h["@@iterator"];if(!m){if(Array.isArray(h)||(m=n(h))||y&&h&&typeof h.length=="number"){m&&(h=m);var b=0,v=function(){};return{s:v,n:function(){return b>=h.length?{done:!0}:{done:!1,value:h[b++]}},e:function(M){throw M},f:v}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var A=!0,E=!1,S;return{s:function(){m=m.call(h)},n:function(){var M=m.next();return A=M.done,M},e:function(M){E=!0,S=M},f:function(){try{!A&&m.return!=null&&m.return()}finally{if(E)throw S}}}}function r(h,y){if(!(h instanceof y))throw new TypeError("Cannot call a class as a function")}function a(h,y){if(typeof h!="object"||h===null)return h;var m=h[Symbol.toPrimitive];if(m!==void 0){var b=m.call(h,y||"default");if(typeof b!="object")return b;throw new TypeError("@@toPrimitive must return a primitive value.")}return(y==="string"?String:Number)(h)}function c(h){var y=a(h,"string");return typeof y=="symbol"?y:String(y)}function l(h,y){for(var m=0;m<y.length;m++){var b=y[m];b.enumerable=b.enumerable||!1,b.configurable=!0,"value"in b&&(b.writable=!0),Object.defineProperty(h,c(b.key),b)}}function d(h,y,m){return y&&l(h.prototype,y),m&&l(h,m),Object.defineProperty(h,"prototype",{writable:!1}),h}function u(h,y,m){return y=c(y),y in h?Object.defineProperty(h,y,{value:m,enumerable:!0,configurable:!0,writable:!0}):h[y]=m,h}var g=function(){function h(){r(this,h),u(this,"subscribers",new Set)}return d(h,[{key:"onSubscribe",get:function(){return this._onSubscribe||(this._onSubscribe=new h),this._onSubscribe}},{key:"onUnsubscribe",get:function(){return this._onUnsubscribe||(this._onUnsubscribe=new h),this._onUnsubscribe}},{key:"subscribe",value:function(m){var b,v=this;return this.subscribers.add(m),(b=this._onSubscribe)===null||b===void 0||b.emit(m),function(){return v.unsubscribe(m)}}},{key:"unsubscribe",value:function(m){var b;this.subscribers.delete(m),(b=this._onUnsubscribe)===null||b===void 0||b.emit(m)}},{key:"clear",value:function(){if(this._onUnsubscribe){var m=o(this.subscribers),b;try{for(m.s();!(b=m.n()).done;){var v=b.value;this._onUnsubscribe.emit(v)}}catch(A){m.e(A)}finally{m.f()}}this.subscribers.clear()}},{key:"emit",value:function(){for(var m=arguments.length,b=new Array(m),v=0;v<m;v++)b[v]=arguments[v];this.subscribers.forEach(function(A){return A.apply(void 0,b)})}},{key:"emitAsync",value:function(){for(var m=arguments.length,b=new Array(m),v=0;v<m;v++)b[v]=arguments[v];return Promise.all(i(this.subscribers).map(function(A){return A.apply(void 0,b)}))}}]),h}();return it.Event=g,it}var ot={},Cn;function zr(){if(Cn)return ot;Cn=1,Object.defineProperty(ot,"__esModule",{value:!0});function p(h,y){(y==null||y>h.length)&&(y=h.length);for(var m=0,b=new Array(y);m<y;m++)b[m]=h[m];return b}function e(h){if(Array.isArray(h))return p(h)}function t(h){if(typeof Symbol<"u"&&h[Symbol.iterator]!=null||h["@@iterator"]!=null)return Array.from(h)}function n(h,y){if(h){if(typeof h=="string")return p(h,y);var m=Object.prototype.toString.call(h).slice(8,-1);if(m==="Object"&&h.constructor&&(m=h.constructor.name),m==="Map"||m==="Set")return Array.from(h);if(m==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(m))return p(h,y)}}function s(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function i(h){return e(h)||t(h)||n(h)||s()}function o(h,y){var m=typeof Symbol<"u"&&h[Symbol.iterator]||h["@@iterator"];if(!m){if(Array.isArray(h)||(m=n(h))||y&&h&&typeof h.length=="number"){m&&(h=m);var b=0,v=function(){};return{s:v,n:function(){return b>=h.length?{done:!0}:{done:!1,value:h[b++]}},e:function(M){throw M},f:v}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var A=!0,E=!1,S;return{s:function(){m=m.call(h)},n:function(){var M=m.next();return A=M.done,M},e:function(M){E=!0,S=M},f:function(){try{!A&&m.return!=null&&m.return()}finally{if(E)throw S}}}}function r(h,y){if(!(h instanceof y))throw new TypeError("Cannot call a class as a function")}function a(h,y){if(typeof h!="object"||h===null)return h;var m=h[Symbol.toPrimitive];if(m!==void 0){var b=m.call(h,y||"default");if(typeof b!="object")return b;throw new TypeError("@@toPrimitive must return a primitive value.")}return(y==="string"?String:Number)(h)}function c(h){var y=a(h,"string");return typeof y=="symbol"?y:String(y)}function l(h,y){for(var m=0;m<y.length;m++){var b=y[m];b.enumerable=b.enumerable||!1,b.configurable=!0,"value"in b&&(b.writable=!0),Object.defineProperty(h,c(b.key),b)}}function d(h,y,m){return y&&l(h.prototype,y),m&&l(h,m),Object.defineProperty(h,"prototype",{writable:!1}),h}function u(h,y,m){return y=c(y),y in h?Object.defineProperty(h,y,{value:m,enumerable:!0,configurable:!0,writable:!0}):h[y]=m,h}var g=function(){function h(){r(this,h),u(this,"subscribers",new Set)}return d(h,[{key:"onSubscribe",get:function(){return this._onSubscribe||(this._onSubscribe=new h),this._onSubscribe}},{key:"onUnsubscribe",get:function(){return this._onUnsubscribe||(this._onUnsubscribe=new h),this._onUnsubscribe}},{key:"subscribe",value:function(m){var b,v=this;return this.subscribers.add(m),(b=this._onSubscribe)===null||b===void 0||b.emit(m),function(){return v.unsubscribe(m)}}},{key:"unsubscribe",value:function(m){var b;this.subscribers.delete(m),(b=this._onUnsubscribe)===null||b===void 0||b.emit(m)}},{key:"clear",value:function(){if(this._onUnsubscribe){var m=o(this.subscribers),b;try{for(m.s();!(b=m.n()).done;){var v=b.value;this._onUnsubscribe.emit(v)}}catch(A){m.e(A)}finally{m.f()}}this.subscribers.clear()}},{key:"emit",value:function(){for(var m=arguments.length,b=new Array(m),v=0;v<m;v++)b[v]=arguments[v];this.subscribers.forEach(function(A){return A.apply(void 0,b)})}},{key:"emitAsync",value:function(){for(var m=arguments.length,b=new Array(m),v=0;v<m;v++)b[v]=arguments[v];return Promise.all(i(this.subscribers).map(function(A){return A.apply(void 0,b)}))}}]),h}();return ot.Event=g,ot}process.env.NODE_ENV==="production"?Rt.exports=zr():Rt.exports=Br();var _n=Rt.exports;function Pn(p,e){(e==null||e>p.length)&&(e=p.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=p[t];return n}function kr(p,e){if(p){if(typeof p=="string")return Pn(p,e);var t=Object.prototype.toString.call(p).slice(8,-1);if(t==="Object"&&p.constructor&&(t=p.constructor.name),t==="Map"||t==="Set")return Array.from(p);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return Pn(p,e)}}function jr(p,e){var t=typeof Symbol<"u"&&p[Symbol.iterator]||p["@@iterator"];if(!t){if(Array.isArray(p)||(t=kr(p))||e&&p&&typeof p.length=="number"){t&&(p=t);var n=0,s=function(){};return{s,n:function(){return n>=p.length?{done:!0}:{done:!1,value:p[n++]}},e:function(a){throw a},f:s}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var i=!0,o=!1,r;return{s:function(){t=t.call(p)},n:function(){var a=t.next();return i=a.done,a},e:function(a){o=!0,r=a},f:function(){try{!i&&t.return!=null&&t.return()}finally{if(o)throw r}}}}function Dr(p,e){if(!(p instanceof e))throw new TypeError("Cannot call a class as a function")}function Gr(p,e){if(typeof p!="object"||p===null)return p;var t=p[Symbol.toPrimitive];if(t!==void 0){var n=t.call(p,e||"default");if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(p)}function Nn(p){var e=Gr(p,"string");return typeof e=="symbol"?e:String(e)}function In(p,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(p,Nn(n.key),n)}}function Hr(p,e,t){return e&&In(p.prototype,e),t&&In(p,t),Object.defineProperty(p,"prototype",{writable:!1}),p}function rt(p,e,t){return e=Nn(e),e in p?Object.defineProperty(p,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):p[e]=t,p}var Ln;Ln=Symbol.iterator;var On=function(){function p(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];Dr(this,p),rt(this,"_version",0),rt(this,"onEntityAdded",new _n.Event),rt(this,"onEntityRemoved",new _n.Event),rt(this,"entityPositions",new Map),this._entities=e,this.add=this.add.bind(this),this.remove=this.remove.bind(this);for(var t=0;t<e.length;t++)this.entityPositions.set(e[t],t)}return Hr(p,[{key:"version",get:function(){return this._version}},{key:"entities",get:function(){return this._entities}},{key:Ln,value:function(){var t=this,n=this._entities.length,s={value:void 0,done:!1};return{next:function(){return s.value=t._entities[--n],s.done=n<0,s}}}},{key:"size",get:function(){return this.entities.length}},{key:"first",get:function(){return this.entities[0]}},{key:"has",value:function(t){return this.entityPositions.has(t)}},{key:"add",value:function(t){return t&&!this.has(t)&&(this.entities.push(t),this.entityPositions.set(t,this.entities.length-1),this._version++,this.onEntityAdded.emit(t)),t}},{key:"remove",value:function(t){if(this.has(t)){this.onEntityRemoved.emit(t);var n=this.entityPositions.get(t);this.entityPositions.delete(t);var s=this.entities[this.entities.length-1];s!==t&&(this.entities[n]=s,this.entityPositions.set(s,n)),this.entities.pop(),this._version++}return t}},{key:"clear",value:function(){var t=jr(this),n;try{for(t.s();!(n=t.n()).done;){var s=n.value;this.remove(s)}}catch(i){t.e(i)}finally{t.f()}}}]),p}(),Fn=new WeakMap,Bn=0,Ur=function(e){var t=Fn.get(e);return t!==void 0?t:(Fn.set(e,Bn),Bn++)};function qr(){var p=new Array;function e(s){p.push(s)}function t(){p.length=0}function n(){p.forEach(function(s){return s()}),t()}return e.clear=t,e.flush=n,e}function Ct(p,e){(e==null||e>p.length)&&(e=p.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=p[t];return n}function Vr(p){if(Array.isArray(p))return Ct(p)}function Wr(p){if(typeof Symbol<"u"&&p[Symbol.iterator]!=null||p["@@iterator"]!=null)return Array.from(p)}function zn(p,e){if(p){if(typeof p=="string")return Ct(p,e);var t=Object.prototype.toString.call(p).slice(8,-1);if(t==="Object"&&p.constructor&&(t=p.constructor.name),t==="Map"||t==="Set")return Array.from(p);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return Ct(p,e)}}function Xr(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function He(p){return Vr(p)||Wr(p)||zn(p)||Xr()}function Me(p){return Me=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},Me(p)}function Kr(p,e){for(;!Object.prototype.hasOwnProperty.call(p,e)&&(p=Me(p),p!==null););return p}function Ue(){return typeof Reflect<"u"&&Reflect.get?Ue=Reflect.get.bind():Ue=function(e,t,n){var s=Kr(e,t);if(s){var i=Object.getOwnPropertyDescriptor(s,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}},Ue.apply(this,arguments)}function _t(p,e){var t=typeof Symbol<"u"&&p[Symbol.iterator]||p["@@iterator"];if(!t){if(Array.isArray(p)||(t=zn(p))||e&&p&&typeof p.length=="number"){t&&(p=t);var n=0,s=function(){};return{s,n:function(){return n>=p.length?{done:!0}:{done:!1,value:p[n++]}},e:function(a){throw a},f:s}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var i=!0,o=!1,r;return{s:function(){t=t.call(p)},n:function(){var a=t.next();return i=a.done,a},e:function(a){o=!0,r=a},f:function(){try{!i&&t.return!=null&&t.return()}finally{if(o)throw r}}}}function Yr(p,e){if(typeof p!="object"||p===null)return p;var t=p[Symbol.toPrimitive];if(t!==void 0){var n=t.call(p,e||"default");if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(p)}function kn(p){var e=Yr(p,"string");return typeof e=="symbol"?e:String(e)}function Ne(p,e,t){return e=kn(e),e in p?Object.defineProperty(p,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):p[e]=t,p}function jn(p,e){var t=Object.keys(p);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(p);e&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(p,s).enumerable})),t.push.apply(t,n)}return t}function Re(p){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?jn(Object(t),!0).forEach(function(n){Ne(p,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(p,Object.getOwnPropertyDescriptors(t)):jn(Object(t)).forEach(function(n){Object.defineProperty(p,n,Object.getOwnPropertyDescriptor(t,n))})}return p}function Dn(p,e){if(!(p instanceof e))throw new TypeError("Cannot call a class as a function")}function Gn(p,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(p,kn(n.key),n)}}function Hn(p,e,t){return e&&Gn(p.prototype,e),t&&Gn(p,t),Object.defineProperty(p,"prototype",{writable:!1}),p}function Ie(p){if(p===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return p}function Pt(p,e){return Pt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,s){return n.__proto__=s,n},Pt(p,e)}function Un(p,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");p.prototype=Object.create(e&&e.prototype,{constructor:{value:p,writable:!0,configurable:!0}}),Object.defineProperty(p,"prototype",{writable:!1}),e&&Pt(p,e)}function $r(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Zr(p,e){if(e&&(typeof e=="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return Ie(p)}function qn(p){var e=$r();return function(){var n=Me(p),s;if(e){var i=Me(this).constructor;s=Reflect.construct(n,arguments,i)}else s=n.apply(this,arguments);return Zr(this,s)}}var Vn,Qr=function(p){Un(t,p);var e=qn(t);function t(){var n,s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return Dn(this,t),n=e.call(this,s),Ne(Ie(n),"queries",new Set),Ne(Ie(n),"entityToId",new Map),Ne(Ie(n),"idToEntity",new Map),Ne(Ie(n),"nextId",0),n.onEntityAdded.subscribe(function(i){n.reindex(i)}),n.onEntityRemoved.subscribe(function(i){if(n.queries.forEach(function(r){return r.remove(i)}),n.entityToId.has(i)){var o=n.entityToId.get(i);n.idToEntity.delete(o),n.entityToId.delete(i)}}),n}return Hn(t,[{key:"update",value:function(n){function s(i,o,r){return n.apply(this,arguments)}return s.toString=function(){return n.toString()},s}(function(n,s,i){if(typeof s=="function"){var o=s(n);o&&Object.assign(n,o)}else typeof s=="string"?n[s]=i:s&&Object.assign(n,s);return this.reindex(n),n})},{key:"addComponent",value:function(s,i,o){s[i]===void 0&&(s[i]=o,this.reindex(s))}},{key:"removeComponent",value:function(s,i){if(s[i]!==void 0){if(this.has(s)){var o=Re({},s);delete o[i],this.reindex(s,o)}delete s[i]}}},{key:"query",value:function(s){var i=ta(s),o=Xn(i),r=_t(this.queries),a;try{for(r.s();!(a=r.n()).done;){var c=a.value;if(c.key===o)return c}}catch(d){r.e(d)}finally{r.f()}var l=new Jr(this,i);return this.queries.add(l),l}},{key:"with",value:function(){for(var s=arguments.length,i=new Array(s),o=0;o<s;o++)i[o]=arguments[o];return this.query({with:i,without:[],predicates:[]})}},{key:"without",value:function(){for(var s=arguments.length,i=new Array(s),o=0;o<s;o++)i[o]=arguments[o];return this.query({with:[],without:i,predicates:[]})}},{key:"where",value:function(s){return this.query({with:[],without:[],predicates:[s]})}},{key:"reindex",value:function(s){var i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:s;if(this.has(s)){var o=_t(this.queries),r;try{for(o.s();!(r=o.n()).done;){var a=r.value;a.evaluate(s,i)}}catch(c){o.e(c)}finally{o.f()}}}},{key:"id",value:function(s){if(this.has(s)){if(!this.entityToId.has(s)){var i=this.nextId++;this.entityToId.set(s,i),this.idToEntity.set(i,s)}return this.entityToId.get(s)}}},{key:"entity",value:function(s){return this.idToEntity.get(s)}}]),t}(On);Vn=Symbol.iterator;var Jr=function(p){Un(t,p);var e=qn(t);function t(n,s){var i;return Dn(this,t),i=e.call(this),Ne(Ie(i),"_isConnected",!1),i.world=n,i.config=s,i.key=Xn(s),i.onEntityAdded.onSubscribe.subscribe(function(){return i.connect()}),i.onEntityRemoved.onSubscribe.subscribe(function(){return i.connect()}),i}return Hn(t,[{key:"isConnected",get:function(){return this._isConnected}},{key:"entities",get:function(){return this._isConnected||this.connect(),Ue(Me(t.prototype),"entities",this)}},{key:Vn,value:function(){return this._isConnected||this.connect(),Ue(Me(t.prototype),Symbol.iterator,this).call(this)}},{key:"connect",value:function(){if(!this._isConnected){this._isConnected=!0;var s=_t(this.world),i;try{for(s.s();!(i=s.n()).done;){var o=i.value;this.evaluate(o)}}catch(r){s.e(r)}finally{s.f()}}return this}},{key:"disconnect",value:function(){return this._isConnected=!1,this}},{key:"with",value:function(){for(var s=arguments.length,i=new Array(s),o=0;o<s;o++)i[o]=arguments[o];return this.world.query(Re(Re({},this.config),{},{with:[].concat(He(this.config.with),i)}))}},{key:"without",value:function(){for(var s=arguments.length,i=new Array(s),o=0;o<s;o++)i[o]=arguments[o];return this.world.query(Re(Re({},this.config),{},{without:[].concat(He(this.config.without),i)}))}},{key:"where",value:function(s){return this.world.query(Re(Re({},this.config),{},{predicates:[].concat(He(this.config.predicates),[s])}))}},{key:"want",value:function(s){return this.config.with.every(function(i){return s[i]!==void 0})&&this.config.without.every(function(i){return s[i]===void 0})&&this.config.predicates.every(function(i){return i(s)})}},{key:"evaluate",value:function(s){var i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:s;if(this.isConnected){var o=this.want(i),r=this.has(s);o&&!r?this.add(s):!o&&r&&this.remove(s)}}}]),t}(On),Wn=function(e){return He(new Set(e.sort().filter(function(t){return!!t&&t!==""})))};function ea(p){return He(new Set(p))}function ta(p){return{with:Wn(p.with),without:Wn(p.without),predicates:ea(p.predicates)}}function Xn(p){return"".concat(p.with.join(","),":").concat(p.without.join(","),":").concat(p.predicates.map(function(e){return Ur(e)}).join(","))}qr();class na{constructor(){this.world=this.initCannon(),this.MAX_VELOCITY=4}initCannon(){let e=new Co;return e.gravity.set(0,-9.82,0),e.broadphase=new Vt,e.solver.iterations=20,e}}let Nt=null;class It extends w.EventDispatcher{constructor(){if(super(),Nt)return Nt;Nt=this,this.world=new Qr,this.physics=new na,this.canvas=document.querySelector("#app"),this.canvas.classList.add("app"),this.scene=new w.Scene,this.camera=new w.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.01,1e3),this.renderer=new w.WebGLRenderer({canvas:this.canvas,antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.pixelRatio=Math.max(window.devicePixelRatio,2),this.renderer.xr.enabled=!0,this.renderer.setClearColor(new w.Color(0,0,0)),this.xr=new Mn,this.loader=new Or,this.input=new Fr,this.controls=this.addOrbitControls(),this.cannonDebugger=new Fo(this.scene,this.physics.world),this.querySystems();let e=new w.AmbientLight(16777215,1);this.scene.add(e),window.addEventListener("resize",()=>{this.onResize()})}start(){this.renderer.xr&&this.xr.checkXRSupport(),this.renderer.setAnimationLoop(()=>{this.update()})}querySystems(){this.meshEntities=this.world.with("mesh").without("physics"),this.physicsEntities=this.world.with("mesh","physics")}update(){this.dispatchEvent({type:"update",message:"update"}),this.physics.world.fixedStep(),this.cannonDebugger.update(),this.physicsSystem(),this.controls.update(),this.renderer.render(this.scene,this.camera)}inputSystem(){}physicsSystem(){for(const{mesh:e,physics:t}of this.physicsEntities)e.position.copy(t.body.position),e.quaternion.copy(t.body.quaternion)}movementSystem(){for(const{mesh:e,velocity:t}of this.meshEntities)e.position.x+=t.x,e.position.y+=t.y,e.position.z+=t.z}onResize(){let e=window.innerWidth,t=window.innerHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}addOrbitControls(){return new cs(this.camera,this.renderer.domElement)}addEntity(){return this.world.add({})}}const Kn=[new w.BoxGeometry(.2,.2,.2),new w.ConeGeometry(.2,.2,64),new w.CylinderGeometry(.2,.2,.2,64),new w.IcosahedronGeometry(.2,8),new w.TorusGeometry(.2,.04,64,32)];function sa(p=10){let e=[];for(let t=0;t<p;t++){const n=Kn[Math.floor(Math.random()*Kn.length)],s=new w.MeshStandardMaterial({color:Math.random()*16777215,roughness:.3,metalness:0}),i=new w.Mesh(n,s);i.position.x=Math.random()*4-2,i.position.y=Math.random()*2,i.position.z=Math.random()*4-2,i.rotation.x=Math.random()*2*Math.PI,i.rotation.y=Math.random()*2*Math.PI,i.rotation.z=Math.random()*2*Math.PI,i.scale.setScalar(Math.random()+.5),i.castShadow=!0,i.receiveShadow=!0,e.push(i)}return e}let ia=new w.BoxGeometry,oa=new w.SphereGeometry,Yn=new w.MeshStandardMaterial({color:12542314});function ra(){return new w.Mesh(ia,Yn)}function aa(){return new w.Mesh(oa,Yn)}J.App=It,J.WebXRHandler=Mn,J.createCube=ra,J.createRandomObjects=sa,J.createSphere=aa,Object.defineProperty(J,Symbol.toStringTag,{value:"Module"})});
